name: Windows_10-11_ESD_Build (ASCII/7z Fix)

on:
  workflow_dispatch:

env:
  # Core filenames (PURE ASCII/ENGLISH)
  TARGET_WIM: Windows10_LTSC_2021_32_64_Windows_11_LTSC_2025.wim
  TARGET_ESD: Windows10_LTSC_2021_32_64_Windows_11_LTSC_2025.esd
  RELEASE_TAG: Windows10_LTSC_2021_32_64_Windows_11_LTSC_2025
  SPLIT_SIZE: 1950M
  RETENTION_DAYS: 3
  WORK_DIR: "${{ github.workspace }}\\win_build"
  # Explicit 7z path (avoid syntax error)
  SEVEN_ZIP_PATH: "${env:ProgramFiles}\\7-Zip\\7z.exe"

  # Download URLs (PURE ASCII)
  WIN10_X86_VOL1: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001
  WIN10_X86_VOL2: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002
  WIN10_X64_VOL1: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001
  WIN10_X64_VOL2: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002
  WIN10_X64_VOL3: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003
  WIN11_X64_VOL1: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001
  WIN11_X64_VOL2: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002
  WIN11_X64_VOL3: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003

jobs:
  build_with_error_fixes:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
        working-directory: ${{ github.workspace }}
    steps:
      # Step 1: Initialize Env (Fix encoding + 7z path + ASCII only)
      - name: 1. Initialize Environment (Encoding/7z/ASCII Fix)
        run: |
          # Fix non-ASCII encoding issue (force UTF-8)
          $OutputEncoding = [System.Text.Encoding]::UTF8
          $ConsoleOutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

          Write-Host "=== Initializing Build Environment ==="
          
          # Create working dir (absolute path, ASCII only)
          New-Item -Path $env:WORK_DIR -ItemType Directory -Force | Out-Null
          New-Item -Path "$env:WORK_DIR\temp" -ItemType Directory -Force | Out-Null
          
          # Validate path length (avoid MAX_PATH truncation)
          $workDirLength = $env:WORK_DIR.Length
          if ($workDirLength -ge 200) {
            Write-Error "Working directory path too long ($workDirLength chars) - may cause string termination errors! Path: $env:WORK_DIR"
            exit 1
          }

          # Validate 7z path (fix 7z syntax error)
          if (-not (Test-Path $env:SEVEN_ZIP_PATH)) {
            Write-Error "7-Zip not found at expected path: $env:SEVEN_ZIP_PATH. Please install 7-Zip first."
            exit 1
          }

          # Validate core tools (ASCII-only checks)
          $requiredTools = @(
            @{Name="7z"; Path=$env:SEVEN_ZIP_PATH},
            @{Name="curl"; Path="curl.exe"},
            @{Name="dism"; Path="dism.exe"}
          )
          foreach ($tool in $requiredTools) {
            if (-not (Get-Command $tool.Path -ErrorAction SilentlyContinue)) {
              Write-Error "$($tool.Name) tool not found at path: $($tool.Path) - aborting build."
              exit 1
            }
          }

          Write-Host "âœ… Environment initialized successfully (UTF-8 encoding, 7z path validated, ASCII-only paths)."

      # Step 2: Process Win10 x86 LTSC2021 (Fix 7z path syntax)
      - name: 2. Process Win10 x86 LTSC2021
        run: |
          Write-Host "=== Processing Win10 x86 LTSC2021 ==="
          Set-Location $env:WORK_DIR

          # Download 7z volumes (ASCII-only URLs, absolute path output)
          Write-Host "Downloading Win10 x86 7z volumes..."
          $outputPathX86Vol1 = Join-Path -Path $env:WORK_DIR -ChildPath (Split-Path $env:WIN10_X86_VOL1 -Leaf)
          $outputPathX86Vol2 = Join-Path -Path $env:WORK_DIR -ChildPath (Split-Path $env:WIN10_X86_VOL2 -Leaf)
          curl.exe -L --progress-bar -w "Download speed: %{speed_download} B/s`n" -o "$outputPathX86Vol1" $env:WIN10_X86_VOL1
          curl.exe -L --progress-bar -w "Download speed: %{speed_download} B/s`n" -o "$outputPathX86Vol2" $env:WIN10_X86_VOL2

          # Validate download (ASCII-only path check)
          if (-not (Test-Path "$outputPathX86Vol1")) {
            Write-Error "Win10 x86 7z volume 1 download failed! Path: $outputPathX86Vol1"
            exit 1
          }

          # Extract 7z (FIX: absolute path + quoted path for 7z syntax)
          Write-Host "Extracting Win10 x86 7z volumes..."
          $extractDir = Join-Path -Path $env:WORK_DIR -ChildPath "temp"
          & $env:SEVEN_ZIP_PATH x -y "$outputPathX86Vol1" -o"$extractDir" | Out-Null

          # Find ISO (absolute path, ASCII-only)
          Write-Host "Extracting install.esd from ISO..."
          $isoFile = Get-ChildItem -Path $extractDir -Filter *.iso -Recurse -File | Select-Object -First 1
          if (-not $isoFile) {
            Write-Error "ISO file not found in extracted Win10 x86 7z archive! Extract dir: $extractDir"
            exit 1
          }
          $isoAbsolutePath = Resolve-Path -Path $isoFile.FullName | Select-Object -ExpandProperty Path

          # Extract install.esd (FIX: 7z absolute path + quoted syntax)
          $esdExtractDir = Join-Path -Path $extractDir -ChildPath "esd"
          & $env:SEVEN_ZIP_PATH x -y "$isoAbsolutePath" -o"$esdExtractDir" "sources/install.esd" | Out-Null
          $esdPath = Join-Path -Path $esdExtractDir -ChildPath "sources/install.esd"

          # Validate ESD (ASCII-only path)
          if (-not (Test-Path "$esdPath")) {
            Write-Error "install.esd not found in Win10 x86 ISO! Path: $esdPath"
            exit 1
          }

          # Export to WIM (absolute path, ASCII-only)
          Write-Host "Exporting Win10 x86 to WIM..."
          $wimPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:TARGET_WIM
          dism /export-image /sourceimagefile:"$esdPath" /sourceindex:1 /destinationimagefile:"$wimPath" /compress:max /checkintegrity

          # Validate WIM (ASCII-only path)
          if (-not (Test-Path "$wimPath")) {
            Write-Error "Win10 x86 WIM export failed! Path: $wimPath"
            exit 1
          }
          Write-Host "âœ… Win10 x86 WIM generated successfully. Path: $wimPath"

          # Cleanup (ASCII-only paths)
          Write-Host "Cleaning up temporary files..."
          Remove-Item -Path "$outputPathX86Vol1", "$outputPathX86Vol2" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path $extractDir -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -Path $extractDir -ItemType Directory -Force | Out-Null

      # Incremental Backup v1 (Win10 x86 WIM)
      - name: ðŸ”¥ Incremental Backup v1 (Win10 x86 WIM Only)
        uses: actions/upload-artifact@v4
        with:
          name: WIM_Backup_v1_Win10_x86
          path: ${{ env.WORK_DIR }}\${{ env.TARGET_WIM }}
          retention-days: ${{ env.RETENTION_DAYS }}
        if: always()

      # Step 3: Process Win10 x64 LTSC2021 (Fix 7z path syntax)
      - name: 3. Process Win10 x64 LTSC2021
        run: |
          Write-Host "=== Processing Win10 x64 LTSC2021 ==="
          Set-Location $env:WORK_DIR

          # Download 7z volumes (absolute output paths)
          Write-Host "Downloading Win10 x64 7z volumes..."
          $outputPathX64Vol1 = Join-Path -Path $env:WORK_DIR -ChildPath (Split-Path $env:WIN10_X64_VOL1 -Leaf)
          $outputPathX64Vol2 = Join-Path -Path $env:WORK_DIR -ChildPath (Split-Path $env:WIN10_X64_VOL2 -Leaf)
          $outputPathX64Vol3 = Join-Path -Path $env:WORK_DIR -ChildPath (Split-Path $env:WIN10_X64_VOL3 -Leaf)
          curl.exe -L --progress-bar -w "Download speed: %{speed_download} B/s`n" -o "$outputPathX64Vol1" $env:WIN10_X64_VOL1
          curl.exe -L --progress-bar -w "Download speed: %{speed_download} B/s`n" -o "$outputPathX64Vol2" $env:WIN10_X64_VOL2
          curl.exe -L --progress-bar -w "Download speed: %{speed_download} B/s`n" -o "$outputPathX64Vol3" $env:WIN10_X64_VOL3

          # Validate download
          if (-not (Test-Path "$outputPathX64Vol1")) {
            Write-Error "Win10 x64 7z volume 1 download failed! Path: $outputPathX64Vol1"
            exit 1
          }

          # Extract 7z (FIX: absolute path + quoted syntax for 7z)
          Write-Host "Extracting Win10 x64 7z volumes..."
          $extractDir = Join-Path -Path $env:WORK_DIR -ChildPath "temp"
          & $env:SEVEN_ZIP_PATH x -y "$outputPathX64Vol1" -o"$extractDir" | Out-Null

          # Find ISO (absolute path)
          $isoFile = Get-ChildItem -Path $extractDir -Filter *.iso -Recurse -File | Select-Object -First 1
          if (-not $isoFile) {
            Write-Error "ISO file not found in extracted Win10 x64 7z archive! Extract dir: $extractDir"
            exit 1
          }
          $isoAbsolutePath = Resolve-Path -Path $isoFile.FullName | Select-Object -ExpandProperty Path

          # Extract install.esd (FIX: 7z absolute path)
          $esdExtractDir = Join-Path -Path $extractDir -ChildPath "esd"
          & $env:SEVEN_ZIP_PATH x -y "$isoAbsolutePath" -o"$esdExtractDir" "sources/install.esd" | Out-Null
          $esdPath = Join-Path -Path $esdExtractDir -ChildPath "sources/install.esd"

          # Validate ESD
          if (-not (Test-Path "$esdPath")) {
            Write-Error "install.esd not found in Win10 x64 ISO! Path: $esdPath"
            exit 1
          }

          # Append to WIM (absolute path)
          Write-Host "Appending Win10 x64 to existing WIM..."
          $wimPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:TARGET_WIM
          dism /export-image /sourceimagefile:"$esdPath" /sourceindex:1 /destinationimagefile:"$wimPath" /compress:max /checkintegrity

          Write-Host "âœ… Win10 x64 appended to WIM successfully. Path: $wimPath"

          # Cleanup
          Write-Host "Cleaning up temporary files..."
          Remove-Item -Path "$outputPathX64Vol1", "$outputPathX64Vol2", "$outputPathX64Vol3" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path $extractDir -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -Path $extractDir -ItemType Directory -Force | Out-Null

      # Incremental Backup v2 (Win10 x86+x64 WIM)
      - name: ðŸ”¥ Incremental Backup v2 (Win10 x86+x64 WIM)
        uses: actions/upload-artifact@v4
        with:
          name: WIM_Backup_v2_Win10_x86_x64
          path: ${{ env.WORK_DIR }}\${{ env.TARGET_WIM }}
          retention-days: ${{ env.RETENTION_DAYS }}
        if: always()

      # Step 4: Process Win11 x64 LTSC2024 (Fix 7z path syntax)
      - name: 4. Process Win11 x64 LTSC2024
        run: |
          Write-Host "=== Processing Win11 x64 LTSC2024 ==="
          Set-Location $env:WORK_DIR

          # Download 7z volumes (absolute output paths)
          Write-Host "Downloading Win11 x64 7z volumes..."
          $outputPathWin11Vol1 = Join-Path -Path $env:WORK_DIR -ChildPath (Split-Path $env:WIN11_X64_VOL1 -Leaf)
          $outputPathWin11Vol2 = Join-Path -Path $env:WORK_DIR -ChildPath (Split-Path $env:WIN11_X64_VOL2 -Leaf)
          $outputPathWin11Vol3 = Join-Path -Path $env:WORK_DIR -ChildPath (Split-Path $env:WIN11_X64_VOL3 -Leaf)
          curl.exe -L --progress-bar -w "Download speed: %{speed_download} B/s`n" -o "$outputPathWin11Vol1" $env:WIN11_X64_VOL1
          curl.exe -L --progress-bar -w "Download speed: %{speed_download} B/s`n" -o "$outputPathWin11Vol2" $env:WIN11_X64_VOL2
          curl.exe -L --progress-bar -w "Download speed: %{speed_download} B/s`n" -o "$outputPathWin11Vol3" $env:WIN11_X64_VOL3

          # Validate download
          if (-not (Test-Path "$outputPathWin11Vol1")) {
            Write-Error "Win11 x64 7z volume 1 download failed! Path: $outputPathWin11Vol1"
            exit 1
          }

          # Extract 7z (FIX: absolute path + quoted syntax)
          Write-Host "Extracting Win11 x64 7z volumes..."
          $extractDir = Join-Path -Path $env:WORK_DIR -ChildPath "temp"
          & $env:SEVEN_ZIP_PATH x -y "$outputPathWin11Vol1" -o"$extractDir" | Out-Null

          # Find ISO (absolute path)
          $isoFile = Get-ChildItem -Path $extractDir -Filter *.iso -Recurse -File | Select-Object -First 1
          if (-not $isoFile) {
            Write-Error "ISO file not found in extracted Win11 x64 7z archive! Extract dir: $extractDir"
            exit 1
          }
          $isoAbsolutePath = Resolve-Path -Path $isoFile.FullName | Select-Object -ExpandProperty Path

          # Extract install.esd (FIX: 7z absolute path)
          $esdExtractDir = Join-Path -Path $extractDir -ChildPath "esd"
          & $env:SEVEN_ZIP_PATH x -y "$isoAbsolutePath" -o"$esdExtractDir" "sources/install.esd" | Out-Null
          $esdPath = Join-Path -Path $esdExtractDir -ChildPath "sources/install.esd"

          # Validate ESD
          if (-not (Test-Path "$esdPath")) {
            Write-Error "install.esd not found in Win11 x64 ISO! Path: $esdPath"
            exit 1
          }

          # Append to WIM (absolute path)
          Write-Host "Appending Win11 x64 to existing WIM..."
          $wimPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:TARGET_WIM
          dism /export-image /sourceimagefile:"$esdPath" /sourceindex:1 /destinationimagefile:"$wimPath" /compress:max /checkintegrity

          # Validate final WIM
          if (-not (Test-Path "$wimPath")) {
            Write-Error "Final WIM generation failed! Path: $wimPath"
            exit 1
          }
          Write-Host "âœ… Final full WIM generated successfully. Path: $wimPath | Size: $(Get-Item "$wimPath").Length bytes"

          # Cleanup
          Write-Host "Cleaning up temporary files..."
          Remove-Item -Path "$outputPathWin11Vol1", "$outputPathWin11Vol2", "$outputPathWin11Vol3" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path $extractDir -Recurse -Force -ErrorAction SilentlyContinue

      # Incremental Backup v3 (Final Full WIM)
      - name: ðŸ”¥ Incremental Backup v3 (Final Full WIM)
        uses: actions/upload-artifact@v4
        with:
          name: WIM_Backup_v3_Final_Full
          path: ${{ env.WORK_DIR }}\${{ env.TARGET_WIM }}
          retention-days: ${{ env.RETENTION_DAYS }}
        if: always()

      # Step 5: Convert WIM to ESD (Fix DISM error 87 + ASCII path)
      - name: 5. Convert WIM to High-Compression ESD
        run: |
          Write-Host "=== Converting WIM to ESD (Recovery Compression) ==="
          Set-Location $env:WORK_DIR

          # Validate WIM (absolute path, ASCII-only)
          $wimPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:TARGET_WIM
          if (-not (Test-Path "$wimPath")) {
            Write-Error "Source WIM file not found! Path: $wimPath"
            exit 1
          }

          # Check WIM integrity (ASCII-only command)
          Write-Host "Checking WIM image integrity..."
          dism /get-imageinfo /imagefile:"$wimPath"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Source WIM file is corrupted! DISM exit code: $LASTEXITCODE"
            exit 1
          }

          # Convert to ESD (FIX: /format:esd + absolute path + ASCII-only)
          Write-Host "Starting ESD conversion..."
          $esdPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:TARGET_ESD
          dism /export-image /sourceimagefile:"$wimPath" /sourceindex:all /destinationimagefile:"$esdPath" /compress:recovery /checkintegrity /format:esd

          # Validate ESD
          if ($LASTEXITCODE -ne 0) {
            Write-Error "ESD conversion failed! DISM exit code: $LASTEXITCODE"
            exit 1
          }
          if (-not (Test-Path "$esdPath")) {
            Write-Error "ESD file not generated after conversion! Path: $esdPath"
            exit 1
          }
          Write-Host "âœ… ESD conversion completed successfully. Path: $esdPath | Size: $(Get-Item "$esdPath").Length bytes"

      # Backup ESD
      - name: ðŸ”¥ Backup ESD File
        uses: actions/upload-artifact@v4
        with:
          name: ESD_Backup_Final
          path: ${{ env.WORK_DIR }}\${{ env.TARGET_ESD }}
          retention-days: ${{ env.RETENTION_DAYS }}
        if: always()

      # Step 6: Split ESD to 1950M Volumes (Fix 7z path syntax)
      - name: 6. Split ESD to 1950M Volumes
        run: |
          Write-Host "=== Splitting ESD to $env:SPLIT_SIZE Volumes ==="
          Set-Location $env:WORK_DIR

          # Validate ESD (absolute path)
          $esdPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:TARGET_ESD
          if (-not (Test-Path "$esdPath")) {
            Write-Error "Source ESD file not found! Path: $esdPath"
            exit 1
          }

          # Split ESD (FIX: 7z absolute path + quoted path + ASCII-only)
          $splitOutputPath = Join-Path -Path $env:WORK_DIR -ChildPath "$env:TARGET_ESD.7z"
          & $env:SEVEN_ZIP_PATH a -t7z -mx=9 -v$env:SPLIT_SIZE "$splitOutputPath" "$esdPath" | Out-Null

          # Validate split volumes
          $splitVol1Path = Join-Path -Path $env:WORK_DIR -ChildPath "$env:TARGET_ESD.7z.001"
          if (-not (Test-Path "$splitVol1Path")) {
            Write-Error "ESD volume splitting failed! Volume 1 path: $splitVol1Path"
            exit 1
          }
          $splitFileCount = (Get-ChildItem -Path "$env:WORK_DIR\$env:TARGET_ESD.7z.*" | Measure-Object).Count
          Write-Host "âœ… ESD split completed successfully. Number of volumes: $splitFileCount"

      # Backup Split Volumes
      - name: ðŸ”¥ Backup Split Volumes
        uses: actions/upload-artifact@v4
        with:
          name: Split_Volumes_Backup_Final
          path: ${{ env.WORK_DIR }}\${{ env.TARGET_ESD }}.7z.*
          retention-days: ${{ env.RETENTION_DAYS }}
        if: always()

      # Step 7: Release to GitHub Releases (ASCII-only paths)
      - name: 7. Release to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          files: ${{ env.WORK_DIR }}\${{ env.TARGET_ESD }}.7z.*
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: success()
