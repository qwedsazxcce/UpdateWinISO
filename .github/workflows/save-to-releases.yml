name: 分步下载压缩上传ISO到Releases（全校验版）

on:
  workflow_dispatch:

jobs:
  process-isos-step-by-step:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 足够处理大文件的超时时间
    steps:
      # 步骤1：基础准备 + 环境校验
      - name: 检出代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装7zip并做兼容性校验
        run: |
          # 1. 升级系统包，避免安装失败
          sudo apt update -y && sudo apt upgrade -y
          # 2. 完整安装7zip（双包安装确保无缺失）
          sudo apt install -y p7zip p7zip-full
          # 3. 核心校验：确认7z命令存在
          if ! command -v 7z &> /dev/null; then
            echo "❌ 致命错误：7zip安装失败，未找到7z命令"
            exit 1
          fi
          # 4. 输出兼容的版本信息（无变量赋值，避免语法错）
          echo "✅ 7zip安装成功，版本信息："
          7z | head -n1
          # 5. 检查磁盘空间（避免压缩/下载时空间不足）
          echo "=== 磁盘空间检查 ==="
          DISK_FREE=$(df -BM /home/runner/work/ | grep / | awk '{print $4}' | sed 's/M//')
          if [ "$DISK_FREE" -lt 20000 ]; then  # 要求至少20GB可用空间
            echo "❌ 磁盘可用空间不足（当前：${DISK_FREE}M），需至少20000M"
            exit 1
          fi
          echo "✅ 磁盘可用空间充足：${DISK_FREE}M"

      # ===================== 处理第一个ISO =====================
      - name: 下载第一个ISO文件（带完整性校验）
        id: download_iso1
        run: |
          # 定义链接和文件名（硬编码避免解析错误）
          ISO_URL="https://software-static.download.prss.microsoft.com/dbazure/888969d5-f34g-4e03-ac9d-1f9786c66749/26100.1742.240906-0331.ge_release_svc_refresh_SERVER_EVAL_x64FRE_zh-cn.iso"
          ISO_NAME="26100.1742.240906-0331.ge_release_svc_refresh_SERVER_EVAL_x64FRE_zh-cn.iso"
          
          echo "=== 开始下载第一个ISO：${ISO_NAME} ==="
          # 稳定下载参数（断点续传+重试+超时+浏览器请求头）
          curl -L -o "${ISO_NAME}" \
            --retry 10 \
            --retry-delay 15 \
            --max-time 7200 \
            -C - \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            "${ISO_URL}"
          
          # 三重校验：文件存在 + 非空 + 大小合理（至少1GB）
          if [ ! -f "${ISO_NAME}" ]; then
            echo "❌ 第一个ISO下载失败：文件不存在"
            exit 1
          fi
          FILE_SIZE=$(stat -c%s "${ISO_NAME}")
          if [ "$FILE_SIZE" -eq 0 ]; then
            echo "❌ 第一个ISO下载失败：文件为空"
            exit 1
          fi
          if [ "$FILE_SIZE" -lt 1073741824 ]; then  # 1GB = 1024*1024*1024
            echo "❌ 第一个ISO下载失败：文件大小异常（${FILE_SIZE}字节）"
            exit 1
          fi
          
          echo "✅ 第一个ISO下载完成，大小：$(du -h "${ISO_NAME}" | awk '{print $1}')"
          # 写入环境变量（用echo + GITHUB_ENV，避免语法错）
          echo "FIRST_ISO_NAME=${ISO_NAME}" >> $GITHUB_ENV

      - name: 压缩第一个ISO（1950M分卷 + 校验）
        id: compress_iso1
        run: |
          ISO_NAME="${{ env.FIRST_ISO_NAME }}"
          COMPRESS_NAME="${ISO_NAME}.7z"
          
          echo "=== 开始压缩第一个ISO：${ISO_NAME} ==="
          # 7z压缩命令（兼容Ubuntu，无语法错）
          7z a -v1950M -t7z -mx5 "${COMPRESS_NAME}" "${ISO_NAME}"
          
          # 校验分卷是否生成
          if ! ls "${ISO_NAME}.7z."* 1> /dev/null 2>&1; then
            echo "❌ 第一个ISO压缩失败：未生成分卷文件"
            exit 1
          fi
          echo "✅ 第一个ISO压缩完成，分卷列表："
          ls -l "${ISO_NAME}.7z."*

      - name: 上传第一个ISO分卷到Releases
        id: upload_iso1
        uses: softprops/action-gh-release@v1  # 稳定版，避免兼容性问题
        with:
          tag_name: Server_2022-2025
          overwrite: true  # 覆盖同名文件，避免重复报错
          files: |
            ${{ env.FIRST_ISO_NAME }}.7z.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===================== 处理第二个ISO =====================
      - name: 下载第二个ISO文件（带完整性校验）
        id: download_iso2
        run: |
          ISO_URL="https://software-static.download.prss.microsoft.com/dbazure/988969d5-f34g-4e03-ac9d-1f9786c66756/20348.1787.230607-0640.fe_release_svc_refresh_SERVER_EVAL_x64FRE_zh-cn.iso"
          ISO_NAME="20348.1787.230607-0640.fe_release_svc_refresh_SERVER_EVAL_x64FRE_zh-cn.iso"
          
          echo "=== 开始下载第二个ISO：${ISO_NAME} ==="
          curl -L -o "${ISO_NAME}" \
            --retry 10 \
            --retry-delay 15 \
            --max-time 7200 \
            -C - \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            "${ISO_URL}"
          
          # 同第一个ISO的三重校验
          if [ ! -f "${ISO_NAME}" ]; then
            echo "❌ 第二个ISO下载失败：文件不存在"
            exit 1
          fi
          FILE_SIZE=$(stat -c%s "${ISO_NAME}")
          if [ "$FILE_SIZE" -eq 0 ]; then
            echo "❌ 第二个ISO下载失败：文件为空"
            exit 1
          fi
          if [ "$FILE_SIZE" -lt 1073741824 ]; then
            echo "❌ 第二个ISO下载失败：文件大小异常（${FILE_SIZE}字节）"
            exit 1
          fi
          
          echo "✅ 第二个ISO下载完成，大小：$(du -h "${ISO_NAME}" | awk '{print $1}')"
          echo "SECOND_ISO_NAME=${ISO_NAME}" >> $GITHUB_ENV

      - name: 压缩第二个ISO（1950M分卷 + 校验）
        id: compress_iso2
        run: |
          ISO_NAME="${{ env.SECOND_ISO_NAME }}"
          COMPRESS_NAME="${ISO_NAME}.7z"
          
          echo "=== 开始压缩第二个ISO：${ISO_NAME} ==="
          7z a -v1950M -t7z -mx5 "${COMPRESS_NAME}" "${ISO_NAME}"
          
          if ! ls "${ISO_NAME}.7z."* 1> /dev/null 2>&1; then
            echo "❌ 第二个ISO压缩失败：未生成分卷文件"
            exit 1
          fi
          echo "✅ 第二个ISO压缩完成，分卷列表："
          ls -l "${ISO_NAME}.7z."*

      - name: 上传第二个ISO分卷到Releases
        id: upload_iso2
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Server_2022-2025
          overwrite: true
          files: |
            ${{ env.SECOND_ISO_NAME }}.7z.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 步骤收尾：输出最终结果
      - name: 全流程完成确认
        run: |
          echo "✅ 所有ISO文件已完成「下载→压缩→上传」全流程！"
          echo "=== 最终文件列表 ==="
          ls -l *.iso *.7z.*
