name: Windows_LTSC_ESD

# 触发条件：手动触发（workflow_dispatch），也可添加push/tag触发
on:
  workflow_dispatch:

# 运行环境和任务配置
jobs:
  build-esd:
    runs-on: windows-2022
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 安装7-Zip（英文日志，避免乱码）
      - name: Install 7-Zip
        run: |
          if (-not (Test-Path "C:\Program Files\7-Zip\7z.exe")) {
            Write-Host "7-Zip not installed, installing via choco..."
            choco install 7zip -y --no-progress
          } else {
            Write-Host "7-Zip is already installed"
          }
        shell: powershell

      # 安装GitHub CLI（替换winget，英文日志）
      - name: Install GitHub CLI (gh)
        run: |
          if (-not (Get-Command "gh" -ErrorAction SilentlyContinue)) {
            Write-Host "GitHub CLI not installed, installing via choco..."
            choco install gh -y --no-progress
          } else {
            Write-Host "GitHub CLI is already installed"
          }
        shell: powershell

      # 创建临时目录（英文日志）
      - name: Create temporary directory
        run: |
          $tempDir = "$env:GITHUB_WORKSPACE\Temp_Win_Image"
          if (-not (Test-Path $tempDir)) {
            New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
            Write-Host "Temporary directory created: $tempDir"
          } else {
            Write-Host "Temporary directory already exists: $tempDir"
          }
        shell: powershell

      # 下载分卷（核心修复：&转义+英文日志+大括号匹配）
      - name: Download ISO split archives
        run: |
          # 定义下载分组（纯英文，避免编码问题）
          $downloadGroups = @(
              @{
                  Name = "Win10LTSC2021_x86"
                  Urls = @(
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002"
                  )
              },
              @{
                  Name = "Win10LTSC2021_amd64"
                  Urls = @(
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003"
                  )
              },
              @{
                  Name = "Win11LTSC2024_amd64"
                  Urls = @(
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003"
                  )
              }
          )

          # 遍历每个分组（修复大括号匹配）
          foreach ($group in $downloadGroups) {
              $groupName = $group.Name
              Write-Host "`n=== Processing group: $groupName ==="
              
              # 下载每个分卷（重试3次）
              foreach ($url in $group.Urls) {
                  $fileName = $url.Split('/')[-1]
                  $savePath = "$env:GITHUB_WORKSPACE\Temp_Win_Image\$fileName"
                  
                  # 检查文件是否已存在
                  if (Test-Path $savePath) {
                    Write-Host "File already exists, skip download: $fileName"
                    continue
                  }

                  # 下载重试逻辑
                  $retryCount = 0
                  $maxRetries = 3
                  $downloadSuccess = $false
                  
                  while ($retryCount -lt $maxRetries -and -not $downloadSuccess) {
                      try {
                          Write-Host "Downloading (retry $retryCount): $fileName"
                          Invoke-WebRequest -Uri $url -OutFile $savePath -UseBasicParsing -TimeoutSec 300 -ErrorAction Stop
                          $downloadSuccess = $true
                          Write-Host "Download success: $fileName"
                      } catch {
                          $retryCount++
                          Write-Warning "Download failed (retry $retryCount/$maxRetries): $($_.Exception.Message)"
                          Start-Sleep -Seconds 5
                      }
                  }

                  # 下载失败终止
                  if (-not $downloadSuccess) {
                      Write-Error "Download failed after max retries: $fileName"
                      exit 1
                  }
              }

              # 解压分卷（修复大括号匹配）
              Write-Host "Extracting split archives: $groupName"
              $7zFirstFile = Get-ChildItem "$env:GITHUB_WORKSPACE\Temp_Win_Image\*.7z.001" | Where-Object { $_.Name -match $groupName } | Select-Object -First 1
              if (-not $7zFirstFile) {
                  Write-Error "No 7z start file found for $groupName (.7z.001)"
                  exit 1
              }

              # 执行解压
              & "C:\Program Files\7-Zip\7z.exe" x -y -o"$env:GITHUB_WORKSPACE\Temp_Win_Image" $7zFirstFile.FullName | Out-Null
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Extract failed for $groupName (7-Zip exit code: $LASTEXITCODE)"
                  exit 1
              }
              Write-Host "Extract success: $groupName"

              # 提取ISO中的install.esd
              Write-Host "Extracting install.esd from ISO: $groupName"
              $isoFile = Get-ChildItem "$env:GITHUB_WORKSPACE\Temp_Win_Image\*.iso" | Where-Object { $_.Name -match $groupName } | Select-Object -First 1
              if (-not $isoFile) {
                  Write-Error "No ISO file found for $groupName"
                  exit 1
              }

              # 解压install.esd
              & "C:\Program Files\7-Zip\7z.exe" x -y -o"$env:GITHUB_WORKSPACE\Temp_Win_Image" $isoFile.FullName "sources/install.esd" | Out-Null
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "install.esd not found in ISO for $groupName"
                  exit 1
              }

              # 验证install.esd
              $esdFile = "$env:GITHUB_WORKSPACE\Temp_Win_Image\sources\install.esd"
              if (-not (Test-Path $esdFile)) {
                  Write-Error "install.esd extraction failed: $esdFile not exists"
                  exit 1
              }
              Write-Host "install.esd extract success: $esdFile"

              # 导出映像到WIM（修复&转义：用`&转义保留字符）
              Write-Host "Exporting image 1 to WIM: $groupName"
              $targetWim = "$env:GITHUB_WORKSPACE\Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.wim"
              $dismArgs = @(
                  "/export-image",
                  "/sourceimagefile:$esdFile",
                  "/sourceindex:1",
                  "/destinationimagefile:`"$targetWim`"",
                  "/compress:max",
                  "/checkintegrity",
                  "/quiet"
              )

              # 首次导出创建WIM，后续追加
              if (-not (Test-Path $targetWim)) {
                  dism @dismArgs
              } else {
                  dism @dismArgs + @("/destinationindex:2")
              }

              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Image export failed for $groupName (DISM exit code: $LASTEXITCODE)"
                  exit 1
              }
              Write-Host "Image export success: $groupName"

              # 清理临时文件（英文日志，修复大括号）
              Write-Host "Cleaning temporary files for $groupName"
              Remove-Item "$env:GITHUB_WORKSPACE\Temp_Win_Image\*.7z.*" -Force -ErrorAction SilentlyContinue
              Remove-Item $isoFile.FullName -Force -ErrorAction SilentlyContinue
              Remove-Item "$env:GITHUB_WORKSPACE\Temp_Win_Image\sources" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "Temporary files cleaned for $groupName"
          } # 闭合foreach ($group in $downloadGroups)
        shell: powershell

      # 转换WIM为ESD（修复&转义）
      - name: Convert WIM to ESD (recovery compression)
        run: |
          $targetWim = "$env:GITHUB_WORKSPACE\Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.wim"
          $targetEsd = "$env:GITHUB_WORKSPACE\Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.esd"
          
          if (-not (Test-Path $targetWim)) {
              Write-Error "Target WIM file not exists: $targetWim"
              exit 1
          }

          Write-Host "Converting WIM to ESD (recovery compression)"
          dism /export-image `
              /sourceimagefile:$targetWim `
              /sourceindex:all `
              /destinationimagefile:$targetEsd `
              /compress:recovery `
              /checkintegrity `
              /quiet

          if ($LASTEXITCODE -ne 0) {
              Write-Error "WIM to ESD convert failed (DISM exit code: $LASTEXITCODE)"
              exit 1
          }
          Write-Host "WIM to ESD convert success: $targetEsd"
        shell: powershell

      # 分卷压缩ESD（修复&转义）
      - name: Split ESD into 1950MB volumes (7z)
        run: |
          $targetEsd = "$env:GITHUB_WORKSPACE\Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.esd"
          $splitPrefix = "$env:GITHUB_WORKSPACE\Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.7z"
          
          if (-not (Test-Path $targetEsd)) {
              Write-Error "Target ESD file not exists: $targetEsd"
              exit 1
          }

          Write-Host "Splitting ESD into 1950MB volumes"
          & "C:\Program Files\7-Zip\7z.exe" a `
              -t7z `
              -mx9 `
              -v1950m `
              -bb1 `
              $splitPrefix `
              $targetEsd

          if ($LASTEXITCODE -ne 0) {
              Write-Error "ESD split failed (7-Zip exit code: $LASTEXITCODE)"
              exit 1
          }

          # 验证分卷
          $splitFiles = Get-ChildItem "$env:GITHUB_WORKSPACE\*.7z.001"
          if (-not $splitFiles) {
              Write-Error "No split files generated"
              exit 1
          }
          Write-Host "ESD split success, generated files:"
          Get-ChildItem "$env:GITHUB_WORKSPACE\*.7z.*" | ForEach-Object { Write-Host " - $($_.Name)" }
        shell: powershell

      # 发布到Releases（修复&转义）
      - name: Publish split files to GitHub Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $releaseName = "Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025"
          $splitFiles = Get-ChildItem "$env:GITHUB_WORKSPACE\*.7z.*" | Sort-Object Name
          
          if (-not $splitFiles) {
              Write-Error "No split files to publish"
              exit 1
          }

          # 登录GitHub CLI
          Write-Host "Logging in to GitHub CLI..."
          echo $env:GITHUB_TOKEN | gh auth login --with-token
          
          # 检查Release是否存在
          $releaseExists = $false
          if (gh release view $releaseName 2>$null) {
              $releaseExists = $true
              Write-Host "Release exists: $releaseName, overwrite existing files"
          } else {
              Write-Host "Release not exists, create new release: $releaseName"
          }

          # 发布文件
          if ($releaseExists) {
              foreach ($file in $splitFiles) {
                  gh release upload $releaseName $file.FullName --clobber
                  if ($LASTEXITCODE -ne 0) {
                      Write-Error "Upload failed: $($file.Name)"
                      exit 1
                  }
                  Write-Host "Upload success: $($file.Name)"
              }
          } else {
              gh release create $releaseName `
                  $splitFiles.FullName `
                  --title $releaseName `
                  --notes "Auto-built Windows LTSC ESD (split into 1950MB volumes)"
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Create release and upload failed"
                  exit 1
              }
              Write-Host "New release created and uploaded success"
          }
        shell: powershell

      # 清理临时文件（英文日志）
      - name: Cleanup all temporary files
        if: always()
        run: |
          Write-Host "Cleaning all temporary files..."
          Remove-Item "$env:GITHUB_WORKSPACE\Temp_Win_Image" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:GITHUB_WORKSPACE\*.wim" -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:GITHUB_WORKSPACE\*.esd" -Force -ErrorAction SilentlyContinue
          Write-Host "Temporary files cleanup completed"
        shell: powershell
