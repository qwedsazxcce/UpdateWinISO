name: Windows_10-11_ESD

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run PowerShell script
        shell: pwsh
        env:
          # Environment variables for download URLs
          WIN10_X86_URL_001: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001
          WIN10_X86_URL_002: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002
          WIN10_X64_URL_001: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001
          WIN10_X64_URL_002: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002
          WIN10_X64_URL_003: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003
          WIN11_X64_URL_001: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001
          WIN11_X64_URL_002: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002
          WIN11_X64_URL_003: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003
        run: |
          # Actual code
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"  # Avoid PowerShell progress bars interfering with curl

          # Function to download with curl
          function Download-File {
              param([string]$Url, [string]$Output)
              Write-Host "Downloading $Url to $Output"
              curl.exe -L -o "$Output" "$Url" --progress-bar
          }

          # Function to extract 7z
          function Extract-7z {
              param([string]$Archive)
              Write-Host "Extracting $Archive"
              & "C:\Program Files\7-Zip\7z.exe" x "$Archive" -y
          }

          # Function to mount ISO and get install.esd path
          function Get-InstallEsdPath {
              param([string]$IsoPath)
              $mount = Mount-DiskImage -ImagePath "$IsoPath" -PassThru
              $driveLetter = ($mount | Get-Volume).DriveLetter
              $esdPath = "${driveLetter}:\sources\install.esd"
              return $esdPath, $mount
          }

          # Function to extract image to WIM
          function Extract-Image {
              param([string]$EsdPath, [string]$WimPath, [bool]$Append = $false)
              if ($Append) {
                  dism /export-image /sourceimagefile:"$EsdPath" /sourceindex:1 /destinationimagefile:"$WimPath" /append
              } else {
                  dism /export-image /sourceimagefile:"$EsdPath" /sourceindex:1 /destinationimagefile:"$WimPath"
              }
          }

          # Function to unmount ISO
          function Unmount-Iso {
              param($Mount)
              Dismount-DiskImage -ImagePath $Mount.ImagePath
          }

          # Function to clean up temp files
          function Clean-Temp {
              param([string[]]$Files)
              foreach ($file in $Files) {
                  if (Test-Path $file) { Remove-Item $file -Force -Recurse }
              }
          }

          # Set working directory
          Set-Location $env:GITHUB_WORKSPACE

          # Output WIM path
          $wimPath = "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim"

          # Process Win10 x86
          Write-Host "Processing Windows 10 LTSC 2021 x86"
          Download-File $env:WIN10_X86_URL_001 "win10_x86.7z.001"
          Download-File $env:WIN10_X86_URL_002 "win10_x86.7z.002"
          Extract-7z "win10_x86.7z.001"
          $isoPath = Get-ChildItem -Filter "*.iso" | Select-Object -First 1 -ExpandProperty FullName
          $esdPath, $mount = Get-InstallEsdPath $isoPath
          Extract-Image $esdPath $wimPath
          Unmount-Iso $mount
          Clean-Temp @("win10_x86.7z.001", "win10_x86.7z.002", $isoPath, $esdPath)

          # Process Win10 x64
          Write-Host "Processing Windows 10 LTSC 2021 x64"
          Download-File $env:WIN10_X64_URL_001 "win10_x64.7z.001"
          Download-File $env:WIN10_X64_URL_002 "win10_x64.7z.002"
          Download-File $env:WIN10_X64_URL_003 "win10_x64.7z.003"
          Extract-7z "win10_x64.7z.001"
          $isoPath = Get-ChildItem -Filter "*.iso" | Select-Object -First 1 -ExpandProperty FullName
          $esdPath, $mount = Get-InstallEsdPath $isoPath
          Extract-Image $esdPath $wimPath $true
          Unmount-Iso $mount
          Clean-Temp @("win10_x64.7z.001", "win10_x64.7z.002", "win10_x64.7z.003", $isoPath, $esdPath)

          # Process Win11 x64
          Write-Host "Processing Windows 11 LTSC 2024 x64"
          Download-File $env:WIN11_X64_URL_001 "win11_x64.7z.001"
          Download-File $env:WIN11_X64_URL_002 "win11_x64.7z.002"
          Download-File $env:WIN11_X64_URL_003 "win11_x64.7z.003"
          Extract-7z "win11_x64.7z.001"
          $isoPath = Get-ChildItem -Filter "*.iso" | Select-Object -First 1 -ExpandProperty FullName
          $esdPath, $mount = Get-InstallEsdPath $isoPath
          Extract-Image $esdPath $wimPath $true
          Unmount-Iso $mount
          Clean-Temp @("win11_x64.7z.001", "win11_x64.7z.002", "win11_x64.7z.003", $isoPath, $esdPath)

          # Convert WIM to ESD
          Write-Host "Converting WIM to ESD"
          $esdPath = "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd"
          dism /export-image /sourceimagefile:"$wimPath" /sourceindex:* /destinationimagefile:"$esdPath" /compress:recovery
          Remove-Item $wimPath -Force

          # Split ESD into 1950M volumes
          Write-Host "Splitting ESD into 1950M volumes"
          & "C:\Program Files\7-Zip\7z.exe" a -v1950m "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.7z" "$esdPath"

          # Clean up ESD
          Remove-Item $esdPath -Force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          repository: qwedsazxcce/Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025
          tag_name: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025
          name: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025
          files: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.7z.*
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
