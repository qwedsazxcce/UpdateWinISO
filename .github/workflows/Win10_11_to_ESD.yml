name: Windows_LTSC_ESD

on:
  workflow_dispatch:

jobs:
  build-esd:
    runs-on: windows-2022
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install 7-Zip
        run: |
          if (-not (Test-Path "C:\Program Files\7-Zip\7z.exe")) {
            Write-Host "7-Zip not installed, installing via choco..."
            choco install 7zip -y --no-progress
          } else {
            Write-Host "7-Zip is already installed"
          }
        shell: powershell

      - name: Install GitHub CLI (gh)
        run: |
          if (-not (Get-Command "gh" -ErrorAction SilentlyContinue)) {
            Write-Host "GitHub CLI not installed, installing via choco..."
            choco install gh -y --no-progress
          } else {
            Write-Host "GitHub CLI is already installed"
          }
        shell: powershell

      - name: Create temporary directory
        run: |
          $tempDir = "$env:GITHUB_WORKSPACE\Temp_Win_Image"
          if (-not (Test-Path $tempDir)) {
            New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
            Write-Host "Temporary directory created: $tempDir"
          } else {
            Write-Host "Temporary directory already exists: $tempDir"
          }
        shell: powershell

      - name: Download ISO split archives (curl)
        run: |
          # 定义下载分组
          $downloadGroups = @(
              @{
                  Name = "Win10LTSC2021_x86"
                  Urls = @(
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002"
                  )
              },
              @{
                  Name = "Win10LTSC2021_amd64"
                  Urls = @(
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003"
                  )
              },
              @{
                  Name = "Win11LTSC2024_amd64"
                  Urls = @(
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002",
                      "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003"
                  )
              }
          )

          # 遍历下载分组
          foreach ($group in $downloadGroups) {
              $groupName = $group.Name
              $tempDir = "$env:GITHUB_WORKSPACE\Temp_Win_Image" # 明确临时目录路径
              Write-Host "`n=== Processing group: $groupName ==="
              
              # 下载所有分卷
              foreach ($url in $group.Urls) {
                  $fileName = $url.Split('/')[-1]
                  $savePath = Join-Path -Path $tempDir -ChildPath $fileName # 用Join-Path避免路径拼接错误
                  
                  # 检查文件是否已存在
                  if (Test-Path $savePath) {
                    Write-Host "File already exists, skip download: $fileName"
                    continue
                  }

                  # curl下载逻辑
                  $retryCount = 0
                  $maxRetries = 3
                  $downloadSuccess = $false
                  
                  while ($retryCount -lt $maxRetries -and -not $downloadSuccess) {
                      Write-Host "`nDownload attempt ${retryCount + 1}/${maxRetries}: $fileName"
                      
                      curl.exe -L -o "$savePath" `
                          --progress-bar `
                          --retry 2 `
                          --retry-delay 5 `
                          --connect-timeout 30 `
                          --max-time 600 `
                          $url
                      
                      if ($LASTEXITCODE -eq 0) {
                          $downloadSuccess = $true
                          Write-Host "`nDownload success: $fileName"
                          # 验证文件是否真的存在
                          if (-not (Test-Path $savePath)) {
                              Write-Warning "File download reported success but not found: $savePath"
                              $downloadSuccess = $false
                              $retryCount++
                              Start-Sleep -Seconds 5
                          }
                      } else {
                          $retryCount++
                          Write-Warning "Download failed (curl exit code: $LASTEXITCODE), attempt ${retryCount}/${maxRetries}, retrying in 5 seconds..."
                          if (Test-Path $savePath) { Remove-Item $savePath -Force }
                          Start-Sleep -Seconds 5
                      }
                  }

                  if (-not $downloadSuccess) {
                      Write-Error "Download failed after ${maxRetries} retries: $fileName"
                      exit 1
                  }
              }

              # ========== 修复：解压逻辑（核心修改） ==========
              Write-Host "Extracting split archives: $groupName"
              # 1. 输出临时目录下的所有文件，便于调试
              Write-Host "Files in temp directory ($tempDir):"
              Get-ChildItem -Path $tempDir -Name | ForEach-Object { Write-Host " - $_" }
              
              # 2. 明确查找路径+用Contains替代match（更稳定的字符串包含匹配）
              $7zFirstFile = Get-ChildItem -Path $tempDir -Filter "*.7z.001" | 
                              Where-Object { $_.Name.Contains($groupName) } | 
                              Select-Object -First 1
              
              # 3. 更详细的错误提示
              if (-not $7zFirstFile) {
                  Write-Error "`nERROR: No .7z.001 file found for $groupName in $tempDir`nCheck if the file was downloaded correctly (see file list above)."
                  exit 1
              }

              Write-Host "Found 7z start file: $($7zFirstFile.FullName)"
              # 执行解压（明确7z路径）
              & "C:\Program Files\7-Zip\7z.exe" x -y -o"$tempDir" $7zFirstFile.FullName | Out-Null
              
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Extract failed for $groupName (7-Zip exit code: $LASTEXITCODE)"
                  exit 1
              }
              Write-Host "Extract success: $groupName"

              # ========== 提取install.esd（同步修复路径） ==========
              Write-Host "Extracting install.esd from ISO: $groupName"
              $isoFile = Get-ChildItem -Path $tempDir -Filter "*.iso" | 
                          Where-Object { $_.Name.Contains($groupName) } | 
                          Select-Object -First 1
              
              if (-not $isoFile) {
                  Write-Error "No ISO file found for $groupName in $tempDir"
                  exit 1
              }

              Write-Host "Found ISO file: $($isoFile.FullName)"
              & "C:\Program Files\7-Zip\7z.exe" x -y -o"$tempDir" $isoFile.FullName "sources/install.esd" | Out-Null
              
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "install.esd not found in ISO for $groupName (7-Zip exit code: $LASTEXITCODE)"
                  exit 1
              }

              $esdFile = Join-Path -Path $tempDir -ChildPath "sources/install.esd"
              if (-not (Test-Path $esdFile)) {
                  Write-Error "install.esd extraction failed: $esdFile not exists"
                  exit 1
              }
              Write-Host "install.esd extract success: $esdFile"

              # ========== 导出映像（同步修复路径） ==========
              Write-Host "Exporting image 1 to WIM: $groupName"
              $targetWim = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.wim"
              $dismArgs = @(
                  "/export-image",
                  "/sourceimagefile:$esdFile",
                  "/sourceindex:1",
                  "/destinationimagefile:`"$targetWim`"",
                  "/compress:max",
                  "/checkintegrity",
                  "/quiet"
              )

              if (-not (Test-Path $targetWim)) {
                  dism @dismArgs
              } else {
                  dism @dismArgs + @("/destinationindex:2")
              }

              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Image export failed for $groupName (DISM exit code: $LASTEXITCODE)"
                  exit 1
              }
              Write-Host "Image export success: $groupName"

              # ========== 清理临时文件 ==========
              Write-Host "Cleaning temporary files for $groupName"
              Remove-Item -Path $tempDir -Filter "*.7z.*" -Force -ErrorAction SilentlyContinue
              Remove-Item -Path $isoFile.FullName -Force -ErrorAction SilentlyContinue
              Remove-Item -Path (Join-Path $tempDir "sources") -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "Temporary files cleaned for $groupName"
          }
        shell: powershell

      # 转换WIM为ESD（无修改，仅同步路径写法）
      - name: Convert WIM to ESD (recovery compression)
        run: |
          $targetWim = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.wim"
          $targetEsd = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.esd"
          
          if (-not (Test-Path $targetWim)) {
              Write-Error "Target WIM file not exists: $targetWim"
              exit 1
          }

          Write-Host "Converting WIM to ESD (recovery compression)"
          dism /export-image `
              /sourceimagefile:$targetWim `
              /sourceindex:all `
              /destinationimagefile:$targetEsd `
              /compress:recovery `
              /checkintegrity `
              /quiet

          if ($LASTEXITCODE -ne 0) {
              Write-Error "WIM to ESD convert failed (DISM exit code: $LASTEXITCODE)"
              exit 1
          }
          Write-Host "WIM to ESD convert success: $targetEsd"
        shell: powershell

      # 分卷压缩ESD（同步路径写法）
      - name: Split ESD into 1950MB volumes (7z)
        run: |
          $targetEsd = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.esd"
          $splitPrefix = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025.7z"
          
          if (-not (Test-Path $targetEsd)) {
              Write-Error "Target ESD file not exists: $targetEsd"
              exit 1
          }

          Write-Host "Splitting ESD into 1950MB volumes"
          & "C:\Program Files\7-Zip\7z.exe" a `
              -t7z `
              -mx9 `
              -v1950m `
              -bb1 `
              $splitPrefix `
              $targetEsd

          if ($LASTEXITCODE -ne 0) {
              Write-Error "ESD split failed (7-Zip exit code: $LASTEXITCODE)"
              exit 1
          }

          $splitFiles = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "*.7z.001"
          if (-not $splitFiles) {
              Write-Error "No split files generated"
              exit 1
          }
          Write-Host "ESD split success, generated files:"
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "*.7z.*" | ForEach-Object { Write-Host " - $($_.Name)" }
        shell: powershell

      # 发布到Releases（同步路径写法）
      - name: Publish split files to GitHub Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $releaseName = "Windows10_LTSC_2021_32`&64_Windows_11_LTSC_2025"
          $splitFiles = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "*.7z.*" | Sort-Object Name
          
          if (-not $splitFiles) {
              Write-Error "No split files to publish"
              exit 1
          }

          Write-Host "Logging in to GitHub CLI..."
          echo $env:GITHUB_TOKEN | gh auth login --with-token
          
          $releaseExists = $false
          if (gh release view $releaseName 2>$null) {
              $releaseExists = $true
              Write-Host "Release exists: $releaseName, overwrite existing files"
          } else {
              Write-Host "Release not exists, create new release: $releaseName"
          }

          if ($releaseExists) {
              foreach ($file in $splitFiles) {
                  gh release upload $releaseName $file.FullName --clobber
                  if ($LASTEXITCODE -ne 0) {
                      Write-Error "Upload failed: $($file.Name)"
                      exit 1
                  }
                  Write-Host "Upload success: $($file.Name)"
              }
          } else {
              gh release create $releaseName `
                  $splitFiles.FullName `
                  --title $releaseName `
                  --notes "Auto-built Windows LTSC ESD (split into 1950MB volumes)"
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Create release and upload failed"
                  exit 1
              }
              Write-Host "New release created and uploaded success"
          }
        shell: powershell

      # 清理临时文件
      - name: Cleanup all temporary files
        if: always()
        run: |
          $tempDir = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Temp_Win_Image"
          Write-Host "Cleaning all temporary files..."
          Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path (Join-Path $env:GITHUB_WORKSPACE "*.wim") -Force -ErrorAction SilentlyContinue
          Remove-Item -Path (Join-Path $env:GITHUB_WORKSPACE "*.esd") -Force -ErrorAction SilentlyContinue
          Write-Host "Temporary files cleanup completed"
        shell: powershell
