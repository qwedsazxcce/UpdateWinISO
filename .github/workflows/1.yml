name: Test Delete Release

"on":
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name to delete'
        required: true
        default: 'Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025'

jobs:
  test-delete:
    runs-on: windows-latest
    steps:
    - name: Test deleting release and tag
      run: |
        $releaseName = "${{ github.event.inputs.release_name }}"
        
        Write-Host "Testing deletion of release: $releaseName"
        
        # Check if release exists and delete it
        $releaseExists = gh release view "$releaseName" --json id --jq ".id" 2>$null
        $exitCode = $LASTEXITCODE
        if ($exitCode -eq 0) {
            Write-Host "Release $releaseName exists, attempting to delete..."
            try {
                gh release delete "$releaseName" --cleanup-tag --yes
                Write-Host "Successfully deleted release $releaseName"
            } catch {
                Write-Host "Failed to delete release: $_"
            }
        } else {
            Write-Host "Release $releaseName does not exist, nothing to delete"
        }
        
        # Check if tag exists and delete it
        $tagExists = git ls-remote --tags origin "$releaseName" 2>$null
        $gitExitCode = $LASTEXITCODE
        if ($gitExitCode -eq 0 -and $tagExists) {
            Write-Host "Tag $releaseName exists, attempting to delete..."
            try {
                git push origin --delete refs/tags/"$releaseName"
                Write-Host "Successfully deleted tag $releaseName"
            } catch {
                Write-Host "Failed to delete tag: $_"
            }
        } else {
            Write-Host "Tag $releaseName does not exist, nothing to delete"
        }
        
        # Exit with success code
        exit 0
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
