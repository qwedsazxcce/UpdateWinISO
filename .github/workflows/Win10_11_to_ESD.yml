name: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025

env:
  # Download URL environment variables - for easy replacement later
  WIN10_X86_URL_001: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001
  WIN10_X86_URL_002: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002
  WIN10_X86_URL_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/Misc/test.txt
  WIN10_AMD64_URL_001: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001
  WIN10_AMD64_URL_002: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002
  WIN10_AMD64_URL_003: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003
  WIN11_AMD64_URL_001: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001
  WIN11_AMD64_URL_002: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002
  WIN11_AMD64_URL_003: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/Windows_10-11_ESD.yml'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup 7-Zip
      run: |
        # First try chocolatey
        choco install 7zip -y
        if ($LASTEXITCODE -ne 0) {
            Write-Host "Chocolatey install failed, trying winget..."
            # Try winget as fallback
            winget install 7zip.7zip
            if ($LASTEXITCODE -ne 0) {
                Write-Host "Winget install failed, downloading directly..."
                # Download and install 7-Zip directly as last resort
                $url = "https://www.7-zip.org/a/7z2408-x64.msi"
                $output = "$env:TEMP\7z-installer.msi"
                Invoke-WebRequest -Uri $url -OutFile $output
                Start-Process msiexec.exe -ArgumentList "/i", $output, "/quiet", "/norestart" -Wait
                # Add to PATH
                echo "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            } else {
                echo "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            }
        } else {
            echo "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }
        
    - name: Create working directory
      run: |
        mkdir workdir
        cd workdir
        
    # Process Windows 10 x86 LTSC 2021
    - name: Download Windows 10 x86 LTSC 2021 part 1
      run: |
        cd workdir
        curl -L -o Windows10_LTSC2021_x86.7z.001 ${{ env.WIN10_X86_URL_001 }}
        
    - name: Download Windows 10 x86 LTSC 2021 part 2
      run: |
        cd workdir
        curl -L -o Windows10_LTSC2021_x86.7z.002 ${{ env.WIN10_X86_URL_002 }}
    
    - name: Download Windows 10 x86 LTSC 2021 part 3
      run: |
        cd workdir
        curl -L -o Windows10_LTSC2021_x86.7z.003 ${{ env.WIN10_X86_URL_003 }}
        
    - name: Extract Windows 10 x86 LTSC 2021 archive
      run: |
        cd workdir
        7z x Windows10_LTSC2021_x86.7z.001 -oWindows10_x86
        if ($LASTEXITCODE -ne 0) {
            throw "Failed to extract Windows 10 x86 archive"
        }
        
    - name: Find and extract ISO file
      run: |
        cd workdir\Windows10_x86
        $isoFile = Get-ChildItem -Path . -Filter "*.iso" -Recurse | Select-Object -First 1
        if ($isoFile -and (Test-Path $isoFile.FullName)) {
            Write-Host "Found ISO file: $($isoFile.Name)"
            7z x "$($isoFile.FullName)" -osources_extract
            if ($LASTEXITCODE -ne 0) {
                throw "Failed to extract ISO file"
            }
        } else {
            throw "No ISO file found in archive"
        }
        
    - name: Extract install.esd and create initial WIM
      run: |
        cd workdir\Windows10_x86\sources_extract
        # Handle case sensitivity for sources directory
        if (Test-Path "sources") {
            $sourcesPath = "sources"
        } elseif (Test-Path "Sources") {
            $sourcesPath = "Sources"
        } else {
            throw "Sources directory not found"
        }
        
        Write-Host "Searching for install.esd in: $sourcesPath"
        
        # Handle case sensitivity for install.esd file
        $esdFiles = Get-ChildItem -Path $sourcesPath -Filter "install.esd" -ErrorAction SilentlyContinue
        if (-not $esdFiles) {
            $esdFiles = Get-ChildItem -Path $sourcesPath -Filter "Install.esd" -ErrorAction SilentlyContinue
        }
        if (-not $esdFiles) {
            $esdFiles = Get-ChildItem -Path $sourcesPath -Filter "INSTALL.ESD" -ErrorAction SilentlyContinue
        }
        
        if ($esdFiles -and $esdFiles.Count -gt 0) {
            $esdFile = $esdFiles[0]
            Write-Host "Found ESD file: $($esdFile.Name)"
            
            if (Test-Path $esdFile.FullName) {
                # Copy the ESD file to extracted_esd directory since DISM needs the original file
                mkdir extracted_esd -ErrorAction SilentlyContinue
                Copy-Item $esdFile.FullName -Destination "extracted_esd\install.esd"
                
                cd extracted_esd
                if (Test-Path "install.esd") {
                    # Export first image to new WIM file
                    $destWim = "..\..\..\Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim"
                    dism /Export-Image /SourceImageFile:install.esd /SourceIndex:1 /DestinationImageFile:"$destWim" /Compress:max
                    if ($LASTEXITCODE -ne 0) {
                        throw "Failed to export WIM image"
                    }
                    Write-Host "Successfully created initial WIM file"
                } else {
                    throw "install.esd not found after copying"
                }
            } else {
                throw "ESD file path does not exist: $($esdFile.FullName)"
            }
        } else {
            throw "No install.esd file found in sources directory"
        }
        
    - name: Cleanup Windows 10 x86 temporary files
      run: |
        cd workdir
        Remove-Item Windows10_LTSC2021_x86.7z.001 -Force
        Remove-Item Windows10_LTSC2021_x86.7z.002 -Force
        Remove-Item Windows10_LTSC2021_x86.7z.003 -Force
        Remove-Item Windows10_x86 -Recurse -Force
        $wimFile = "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim"
        if (Test-Path "$wimFile") {
            Write-Host "Initial WIM created successfully"
        }
        
    # Process Windows 10 amd64 LTSC 2021
    - name: Download Windows 10 amd64 LTSC 2021 part 1
      run: |
        cd workdir
        curl -L -o Windows10_LTSC2021_amd64.7z.001 ${{ env.WIN10_AMD64_URL_001 }}
        
    - name: Download Windows 10 amd64 LTSC 2021 part 2
      run: |
        cd workdir
        curl -L -o Windows10_LTSC2021_amd64.7z.002 ${{ env.WIN10_AMD64_URL_002 }}
        
    - name: Download Windows 10 amd64 LTSC 2021 part 3
      run: |
        cd workdir
        curl -L -o Windows10_LTSC2021_amd64.7z.003 ${{ env.WIN10_AMD64_URL_003 }}
        
    - name: Extract Windows 10 amd64 LTSC 2021 archive
      run: |
        cd workdir
        7z x Windows10_LTSC2021_amd64.7z.001 -oWindows10_amd64
        if ($LASTEXITCODE -ne 0) {
            throw "Failed to extract Windows 10 amd64 archive"
        }
        
    - name: Find and extract ISO file for amd64
      run: |
        cd workdir\Windows10_amd64
        $isoFile = Get-ChildItem -Path . -Filter "*.iso" -Recurse | Select-Object -First 1
        if ($isoFile -and (Test-Path $isoFile.FullName)) {
            Write-Host "Found ISO file: $($isoFile.Name)"
            7z x "$($isoFile.FullName)" -osources_extract
            if ($LASTEXITCODE -ne 0) {
                throw "Failed to extract ISO file"
            }
        } else {
            throw "No ISO file found in archive"
        }
        
    - name: Extract install.esd and append to existing WIM
      run: |
        cd workdir\Windows10_amd64\sources_extract
        # Handle case sensitivity for sources directory
        if (Test-Path "sources") {
            $sourcesPath = "sources"
        } elseif (Test-Path "Sources") {
            $sourcesPath = "Sources"
        } else {
            throw "Sources directory not found"
        }
        
        Write-Host "Searching for install.esd in: $sourcesPath"
        
        # Handle case sensitivity for install.esd file
        $esdFiles = Get-ChildItem -Path $sourcesPath -Filter "install.esd" -ErrorAction SilentlyContinue
        if (-not $esdFiles) {
            $esdFiles = Get-ChildItem -Path $sourcesPath -Filter "Install.esd" -ErrorAction SilentlyContinue
        }
        if (-not $esdFiles) {
            $esdFiles = Get-ChildItem -Path $sourcesPath -Filter "INSTALL.ESD" -ErrorAction SilentlyContinue
        }
        
        if ($esdFiles -and $esdFiles.Count -gt 0) {
            $esdFile = $esdFiles[0]
            Write-Host "Found ESD file: $($esdFile.Name)"
            
            if (Test-Path $esdFile.FullName) {
                # Copy the ESD file to extracted_esd directory since DISM needs the original file
                mkdir extracted_esd -ErrorAction SilentlyContinue
                Copy-Item $esdFile.FullName -Destination "extracted_esd\install.esd"
                
                cd extracted_esd
                if (Test-Path "install.esd") {
                    # Export first image to temporary WIM file
                    dism /Export-Image /SourceImageFile:install.esd /SourceIndex:1 /DestinationImageFile:install.wim /Compress:max
                    if ($LASTEXITCODE -ne 0) {
                        throw "Failed to export temporary WIM image"
                    }
                    
                    # Verify temporary WIM was created
                    if (Test-Path "install.wim") {
                        # Append to existing WIM file
                        $destWim = "..\..\..\Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim"
                        dism /Export-Image /SourceImageFile:install.wim /SourceIndex:1 /DestinationImageFile:"$destWim" /DestinationName:"Windows 10 LTSC 2021 amd64" /Compress:max
                        if ($LASTEXITCODE -ne 0) {
                            throw "Failed to append WIM image"
                        }
                        Write-Host "Successfully appended Windows 10 amd64 image"
                    } else {
                        throw "Temporary WIM file was not created"
                    }
                } else {
                    throw "install.esd not found after copying"
                }
            } else {
                throw "ESD file path does not exist: $($esdFile.FullName)"
            }
        } else {
            throw "No install.esd file found in sources directory"
        }
        
    - name: Cleanup Windows 10 amd64 temporary files
      run: |
        cd workdir
        Remove-Item Windows10_LTSC2021_amd64.7z.001 -Force
        Remove-Item Windows10_LTSC2021_amd64.7z.002 -Force
        Remove-Item Windows10_LTSC2021_amd64.7z.003 -Force
        Remove-Item Windows10_amd64 -Recurse -Force
        Remove-Item install.wim -ErrorAction SilentlyContinue
        
    # Process Windows 11 amd64 LTSC 2024
    - name: Download Windows 11 amd64 LTSC 2024 part 1
      run: |
        cd workdir
        curl -L -o Windows11_LTSC2024_amd64.7z.001 ${{ env.WIN11_AMD64_URL_001 }}
        
    - name: Download Windows 11 amd64 LTSC 2024 part 2
      run: |
        cd workdir
        curl -L -o Windows11_LTSC2024_amd64.7z.002 ${{ env.WIN11_AMD64_URL_002 }}
        
    - name: Download Windows 11 amd64 LTSC 2024 part 3
      run: |
        cd workdir
        curl -L -o Windows11_LTSC2024_amd64.7z.003 ${{ env.WIN11_AMD64_URL_003 }}
        
    - name: Extract Windows 11 amd64 LTSC 2024 archive
      run: |
        cd workdir
        7z x Windows11_LTSC2024_amd64.7z.001 -oWindows11_amd64
        if ($LASTEXITCODE -ne 0) {
            throw "Failed to extract Windows 11 amd64 archive"
        }
        
    - name: Find and extract ISO file for Windows 11
      run: |
        cd workdir\Windows11_amd64
        $isoFile = Get-ChildItem -Path . -Filter "*.iso" -Recurse | Select-Object -First 1
        if ($isoFile -and (Test-Path $isoFile.FullName)) {
            Write-Host "Found ISO file: $($isoFile.Name)"
            7z x "$($isoFile.FullName)" -osources_extract
            if ($LASTEXITCODE -ne 0) {
                throw "Failed to extract ISO file"
            }
        } else {
            throw "No ISO file found in archive"
        }
        
    - name: Extract install.esd and append to existing WIM
      run: |
        cd workdir\Windows11_amd64\sources_extract
        # Handle case sensitivity for sources directory
        if (Test-Path "sources") {
            $sourcesPath = "sources"
        } elseif (Test-Path "Sources") {
            $sourcesPath = "Sources"
        } else {
            throw "Sources directory not found"
        }
        
        Write-Host "Searching for install.esd in: $sourcesPath"
        
        # Handle case sensitivity for install.esd file
        $esdFiles = Get-ChildItem -Path $sourcesPath -Filter "install.esd" -ErrorAction SilentlyContinue
        if (-not $esdFiles) {
            $esdFiles = Get-ChildItem -Path $sourcesPath -Filter "Install.esd" -ErrorAction SilentlyContinue
        }
        if (-not $esdFiles) {
            $esdFiles = Get-ChildItem -Path $sourcesPath -Filter "INSTALL.ESD" -ErrorAction SilentlyContinue
        }
        
        if ($esdFiles -and $esdFiles.Count -gt 0) {
            $esdFile = $esdFiles[0]
            Write-Host "Found ESD file: $($esdFile.Name)"
            
            if (Test-Path $esdFile.FullName) {
                # Copy the ESD file to extracted_esd directory since DISM needs the original file
                mkdir extracted_esd -ErrorAction SilentlyContinue
                Copy-Item $esdFile.FullName -Destination "extracted_esd\install.esd"
                
                cd extracted_esd
                if (Test-Path "install.esd") {
                    # Export first image to temporary WIM file
                    dism /Export-Image /SourceImageFile:install.esd /SourceIndex:1 /DestinationImageFile:install.wim /Compress:max
                    if ($LASTEXITCODE -ne 0) {
                        throw "Failed to export temporary WIM image"
                    }
                    
                    # Verify temporary WIM was created
                    if (Test-Path "install.wim") {
                        # Append to existing WIM file
                        $destWim = "..\..\..\Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim"
                        dism /Export-Image /SourceImageFile:install.wim /SourceIndex:1 /DestinationImageFile:"$destWim" /DestinationName:"Windows 11 LTSC 2024 amd64" /Compress:max
                        if ($LASTEXITCODE -ne 0) {
                            throw "Failed to append WIM image"
                        }
                        Write-Host "Successfully appended Windows 11 amd64 image"
                    } else {
                        throw "Temporary WIM file was not created"
                    }
                } else {
                    throw "install.esd not found after copying"
                }
            } else {
                throw "ESD file path does not exist: $($esdFile.FullName)"
            }
        } else {
            throw "No install.esd file found in sources directory"
        }
        
    - name: Cleanup Windows 11 amd64 temporary files
      run: |
        cd workdir
        Remove-Item Windows11_LTSC2024_amd64.7z.001 -Force
        Remove-Item Windows11_LTSC2024_amd64.7z.002 -Force
        Remove-Item Windows11_LTSC2024_amd64.7z.003 -Force
        Remove-Item Windows11_amd64 -Recurse -Force
        Remove-Item install.wim -ErrorAction SilentlyContinue
        
    # Convert final WIM to ESD
    - name: Convert WIM to ESD with maximum compression
      run: |
        cd workdir
        # Verify source WIM file exists
        $wimFile = "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim"
        if (-not (Test-Path "$wimFile")) {
            throw "Source WIM file not found"
        }
        
        Write-Host "Converting WIM to ESD with maximum compression..."
        $esdFile = "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd"
        
        # First check how many images are in the WIM file
        Write-Host "Checking WIM file info..."
        dism /Get-WimInfo /WimFile:"$wimFile"
        if ($LASTEXITCODE -ne 0) {
            throw "Failed to get WIM info"
        }
        
        # Parse the WIM info to get image count
        # Look for lines containing "Index :" to count images
        $wimInfo = dism /Get-WimInfo /WimFile:"$wimFile"
        $wimInfoLines = $wimInfo -split "`n"
        $imageCount = ($wimInfoLines | Where-Object { $_ -match "Index\s*:\s*\d+" }).Count
        
        if ($imageCount -eq 0) {
            # Fallback method: try to get image count from log or assume 3
            Write-Host "Could not parse image count, assuming 3 images based on build process"
            $imageCount = 3
        }
        
        Write-Host "Found $imageCount images in WIM file"
        
        # Export images one by one to the same ESD file
        for ($i = 1; $i -le $imageCount; $i++) {
            Write-Host "Exporting image $i of $imageCount..."
            
            if ($i -eq 1) {
                # First image: create new ESD file
                dism /Export-Image /SourceImageFile:"$wimFile" /SourceIndex:$i /DestinationImageFile:"$esdFile" /Compress:recovery /CheckIntegrity
            } else {
                # Subsequent images: append to existing ESD file
                dism /Export-Image /SourceImageFile:"$wimFile" /SourceIndex:$i /DestinationImageFile:"$esdFile" /Compress:recovery /CheckIntegrity
            }
            
            if ($LASTEXITCODE -ne 0) {
                throw "Failed to export image $i to ESD"
            }
        }
        
        Write-Host "Successfully exported all $imageCount images to ESD format"
        
        # Verify ESD file was created
        if (Test-Path "$esdFile") {
            Write-Host "Successfully converted to ESD format"
            $esdSize = (Get-Item "$esdFile").Length
            Write-Host "ESD file size: $($esdSize / 1GB) GB"
        } else {
            throw "ESD file was not created"
        }
        
    - name: Split ESD file into 1950MB volumes
      run: |
        cd workdir
        # Verify ESD file exists before splitting
        $esdFile = "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd"
        if (-not (Test-Path "$esdFile")) {
            throw "ESD file not found for splitting"
        }
        
        Write-Host "Splitting ESD file into 1950MB volumes..."
        $outputArchive = "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.7z"
        7z a -v1950M "$outputArchive" "$esdFile"
        if ($LASTEXITCODE -ne 0) {
            throw "Failed to split ESD file"
        }
        
        Write-Host "Verifying split archive integrity..."
        7z t "$outputArchive.001"
        if ($LASTEXITCODE -ne 0) {
            throw "Split archive integrity check failed"
        }
        
        # Verify split files were created
        $splitFiles = Get-ChildItem -Path . -Filter "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.7z.*"
        if ($splitFiles -and $splitFiles.Count -gt 0) {
            Write-Host "Created $($splitFiles.Count) volume files:"
            foreach ($file in $splitFiles) {
                Write-Host "  $($file.Name) - $($file.Length / 1MB) MB"
            }
        } else {
            throw "No split volume files were created"
        }

    # ========== 删除Release/Tag步骤 ==========
    - name: Delete existing release and tag
      shell: pwsh
      run: |
        $targetName = "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025"
        
        # 检查并删除Release
        try {
            $releaseId = gh release view "$targetName" --json id --jq ".id" 2>&1
            if ($LASTEXITCODE -eq 0) {
                Write-Host "Found existing release: $targetName, deleting..."
                gh release delete "$targetName" --cleanup-tag --yes
            } else {
                Write-Host "No existing release found for: $targetName"
            }
        }
        catch {
            Write-Host "No existing release found for: $targetName (error: $_)"
        }

        # 兜底检查并删除Tag
        try {
            git ls-remote --tags origin "refs/tags/$targetName" 2>&1 | Out-Null
            if ($LASTEXITCODE -eq 0) {
                Write-Host "Found existing tag: $targetName, deleting..."
                git push origin --delete "refs/tags/$targetName"
            } else {
                Write-Host "No existing tag found for: $targetName"
            }
        }
        catch {
            Write-Host "No existing tag found for: $targetName (error: $_)"
        }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ========== 上传Release资产步骤（修改为通用匹配） ==========
    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        name: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025
        tag_name: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025
        files: |
          workdir/*.7z.*
        draft: false
        prerelease: false
        make_latest: true
        overwrite: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
