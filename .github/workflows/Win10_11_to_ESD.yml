name: Win10_11_to_ESD
<#
Win10/11 LTSC 映像合并发布脚本
核心功能：7z分卷下载→解压→WIM合并→ESD转换→分卷→GitHub Releases发布
特性：纯英文日志、实时下载进度、逐源清理临时文件、UTF-8编码规避非ASCII问题
#>

# ====================== 第一层：固定名称配置 ======================
$releaseName = "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025"
$targetWimName = "$releaseName.wim"
$targetEsdName = "$releaseName.esd"
$splitSize = "1950M"          # 分卷大小
$artifactRetentionDays = 3    # Artifact保留天数

# ====================== 第二层：环境变量（下载地址，可直接替换） ======================
$downloadSources = @(
    @{
        Name = "Win10_LTSC2021_x86"
        Urls = @(
            "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001",
            "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002"
        )
    },
    @{
        Name = "Win10_LTSC2021_x64"
        Urls = @(
            "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001",
            "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002",
            "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003"
        )
    },
    @{
        Name = "Win11_LTSC2024_x64"
        Urls = @(
            "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001",
            "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002",
            "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003"
        )
    }
)

# ====================== 第三层：核心业务代码 ======================
# 全局配置
Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8  # 规避非ASCII编码问题
$workDir = Join-Path -Path $PWD.Path -ChildPath "WinLTSC_WorkDir"
$tempDir = Join-Path -Path $workDir -ChildPath "Temp"
$outputDir = Join-Path -Path $workDir -ChildPath "Output"
New-Item -ItemType Directory -Path $tempDir, $outputDir -Force | Out-Null
$targetWimPath = Join-Path -Path $outputDir -ChildPath $targetWimName
$targetEsdPath = Join-Path -Path $outputDir -ChildPath $targetEsdName

# 1. 下载文件（原生curl，显示进度/速度）
function Download-File {
    param(
        [string]$Url,
        [string]$OutputPath
    )
    try {
        Write-Host "`nDownloading: $Url" -ForegroundColor Cyan
        & curl.exe -L -o $OutputPath -# $Url  # -# 显示进度条，原生curl确保速度/进度展示
        if ($LASTEXITCODE -ne 0) { throw "Download failed (exit code: $LASTEXITCODE)" }
        Write-Host "Download completed: $OutputPath" -ForegroundColor Green
    }
    catch {
        Write-Host "Error downloading $Url : $_" -ForegroundColor Red
        exit 1
    }
}

# 2. 解压7z分卷（自动识别分卷，规避路径语法错误）
function Extract-7zVolumes {
    param(
        [array]$7zFiles,
        [string]$ExtractDir
    )
    try {
        New-Item -ItemType Directory -Path $ExtractDir -Force | Out-Null
        Write-Host "`nExtracting 7z volumes to: $ExtractDir" -ForegroundColor Cyan
        $first7z = $7zFiles | Sort-Object | Select-Object -First 1  # 7z只需指定第一个分卷即可解压全部
        & 7z.exe x -y -o"$ExtractDir" "$first7z"  # -y 自动确认，-o指定输出目录（规避路径语法坑）
        if ($LASTEXITCODE -ne 0) { throw "7z extraction failed (exit code: $LASTEXITCODE)" }
        Write-Host "7z extraction completed" -ForegroundColor Green
    }
    catch {
        Write-Host "Error extracting 7z: $_" -ForegroundColor Red
        exit 1
    }
}

# 3. 从ISO提取install.esd
function Extract-InstallEsdFromIso {
    param(
        [string]$IsoPath,
        [string]$OutputDir
    )
    try {
        New-Item -ItemType Directory -Path $OutputDir -Force | Out-Null
        Write-Host "`nMounting ISO: $IsoPath" -ForegroundColor Cyan
        $mount = Mount-DiskImage -ImagePath $IsoPath -PassThru
        $drive = ($mount | Get-Volume | Get-Partition).DriveLetter + ":"
        $esdSource = Join-Path -Path $drive -ChildPath "sources\install.esd"
        $esdOutput = Join-Path -Path $OutputDir -ChildPath "install.esd"
        
        Copy-Item -Path $esdSource -Destination $esdOutput -Force
        if (-not (Test-Path $esdOutput)) { throw "install.esd not found in ISO" }
        
        Dismount-DiskImage -ImagePath $IsoPath -Confirm:$false
        Write-Host "Extracted install.esd: $esdOutput" -ForegroundColor Green
        return $esdOutput
    }
    catch {
        if ($mount) { Dismount-DiskImage -ImagePath $IsoPath -Confirm:$false -ErrorAction SilentlyContinue }
        Write-Host "Error extracting ESD: $_" -ForegroundColor Red
        exit 1
    }
}

# 4. 合并映像到WIM（首次创建，后续追加）
function Add-ImageToWim {
    param(
        [string]$EsdPath,
        [string]$TargetWimPath,
        [bool]$IsFirstImage
    )
    try {
        Write-Host "`nProcessing image from ESD: $EsdPath" -ForegroundColor Cyan
        # 验证ESD包含索引1的映像
        & dism.exe /Get-ImageInfo /ImageFile:"$EsdPath" | Select-String "Image Index: 1" -ErrorAction Stop
        
        # 合并映像（首次创建，后续追加）
        if ($IsFirstImage) {
            & dism.exe /Export-Image /SourceImageFile:"$EsdPath" /SourceIndex:1 /DestinationImageFile:"$TargetWimPath" /Compress:max /CheckIntegrity
        }
        else {
            & dism.exe /Export-Image /SourceImageFile:"$EsdPath" /SourceIndex:1 /DestinationImageFile:"$TargetWimPath" /Compress:max /CheckIntegrity /Append
        }
        
        if ($LASTEXITCODE -ne 0) { throw "DISM merge failed (exit code: $LASTEXITCODE)" }
        Write-Host "Image merged to WIM successfully" -ForegroundColor Green
    }
    catch {
        Write-Host "Error merging image: $_" -ForegroundColor Red
        exit 1
    }
}

# 5. 清理临时文件（逐源清理，节省空间）
function Cleanup-TempFiles {
    param(
        [array]$FilesToDelete
    )
    try {
        Write-Host "`nCleaning temporary files..." -ForegroundColor Cyan
        foreach ($file in $FilesToDelete) {
            if (Test-Path $file) {
                Remove-Item -Path $file -Recurse -Force -ErrorAction SilentlyContinue
                Write-Host "Deleted: $file" -ForegroundColor Yellow
            }
        }
    }
    catch { Write-Host "Warning: Cleanup error - $_" -ForegroundColor Yellow }
}

# 6. 转换WIM到高压缩ESD
function Convert-WimToEsd {
    param(
        [string]$WimPath,
        [string]$EsdPath
    )
    try {
        Write-Host "`nConverting WIM to ESD (high compression)..." -ForegroundColor Cyan
        # 获取WIM中的映像数量
        $imageCount = (& dism.exe /Get-ImageInfo /ImageFile:"$WimPath" | Select-String "Image Index: (\d+)").Count
        
        # 转换第一个映像（创建ESD）
        & dism.exe /Export-Image /SourceImageFile:"$WimPath" /SourceIndex:1 /DestinationImageFile:"$EsdPath" /Compress:recovery /CheckIntegrity
        
        # 追加剩余映像
        for ($i=2; $i -le $imageCount; $i++) {
            & dism.exe /Export-Image /SourceImageFile:"$WimPath" /SourceIndex:$i /DestinationImageFile:"$EsdPath" /Compress:recovery /CheckIntegrity /Append
        }
        
        if ($LASTEXITCODE -ne 0) { throw "ESD conversion failed (exit code: $LASTEXITCODE)" }
        Write-Host "WIM converted to ESD successfully" -ForegroundColor Green
    }
    catch {
        Write-Host "Error converting ESD: $_" -ForegroundColor Red
        exit 1
    }
}

# 7. 1950M分卷压缩
function Split-FileToVolumes {
    param(
        [string]$SourceFile,
        [string]$OutputPrefix,
        [string]$VolumeSize
    )
    try {
        Write-Host "`nSplitting file to $VolumeSize volumes..." -ForegroundColor Cyan
        & 7z.exe a -t7z -mx=9 -v$VolumeSize -y "$OutputPrefix.7z" "$SourceFile"  # -mx=9最高压缩，-v指定分卷大小
        if ($LASTEXITCODE -ne 0) { throw "7z split failed (exit code: $LASTEXITCODE)" }
        $splitFiles = Get-ChildItem -Path "$OutputPrefix.7z.*"
        Write-Host "Split completed: $($splitFiles.Count) volumes created" -ForegroundColor Green
        return $splitFiles.FullName
    }
    catch {
        Write-Host "Error splitting file: $_" -ForegroundColor Red
        exit 1
    }
}

# 8. 发布到GitHub Releases（仅发布最终分卷）
function Publish-GitHubRelease {
    param(
        [string]$ReleaseName,
        [string]$Tag,
        [array]$FilesToUpload,
        [int]$RetentionDays
    )
    try {
        Write-Host "`nPublishing to GitHub Releases..." -ForegroundColor Cyan
        # 验证环境变量
        if (-not $env:GITHUB_TOKEN) { throw "GITHUB_TOKEN not set" }
        if (-not $env:GITHUB_REPOSITORY) { throw "GITHUB_REPOSITORY not set (e.g., owner/repo)" }
        
        # 构建请求头
        $headers = @{
            "Authorization" = "token $($env:GITHUB_TOKEN)"
            "Accept" = "application/vnd.github.v3+json"
        }

        # 创建Release
        $releaseBody = "Merged Win10 LTSC2021 (x86/x64) + Win11 LTSC2024 (x64) ESD, split into $splitSize volumes`nArtifact retention: $RetentionDays days"
        $releaseData = @{
            tag_name = $Tag
            name = $ReleaseName
            body = $releaseBody
            draft = $false
            prerelease = $false
        } | ConvertTo-Json
        
        $release = Invoke-RestMethod -Uri "https://api.github.com/repos/$($env:GITHUB_REPOSITORY)/releases" -Method Post -Headers $headers -Body $releaseData -ContentType "application/json"
        $uploadUrl = $release.upload_url -replace '\{.*\}', ''

        # 上传分卷文件（仅上传最终成果）
        foreach ($file in $FilesToUpload) {
            $fileName = [System.IO.Path]::GetFileName($file)
            Write-Host "Uploading: $fileName" -ForegroundColor Cyan
            $fileBytes = [System.IO.File]::ReadAllBytes($file)
            Invoke-RestMethod -Uri "$uploadUrl?name=$fileName" -Method Post -Headers $headers -Body $fileBytes -ContentType "application/octet-stream"
            Write-Host "Uploaded: $fileName" -ForegroundColor Green
        }

        # 提示Artifact保留期配置（GitHub Actions需配合workflow设置）
        Write-Host "`nNote: Set artifact retention to $RetentionDays days in GitHub Actions workflow" -ForegroundColor Yellow
        Write-Host "Release published: $($release.html_url)" -ForegroundColor Green
    }
    catch {
        Write-Host "Error publishing release: $_" -ForegroundColor Red
        exit 1
    }
}

# ====================== 主执行流程 ======================
$isFirstImage = $true  # 标记是否为第一个要合并的映像
foreach ($source in $downloadSources) {
    Write-Host "`n==================================================" -ForegroundColor Magenta
    Write-Host "Processing: $($source.Name)" -ForegroundColor Magenta
    Write-Host "==================================================" -ForegroundColor Magenta

    # 1. 下载7z分卷
    $7zFiles = @()
    foreach ($url in $source.Urls) {
        $fileName = [System.IO.Path]::GetFileName($url)
        $outputPath = Join-Path -Path $tempDir -ChildPath $fileName
        Download-File -Url $url -OutputPath $outputPath
        $7zFiles += $outputPath
    }

    # 2. 解压7z分卷
    $7zExtractDir = Join-Path -Path $tempDir -ChildPath "$($source.Name)_7zExtract"
    Extract-7zVolumes -7zFiles $7zFiles -ExtractDir $7zExtractDir

    # 3. 找到ISO文件
    $isoFile = Get-ChildItem -Path $7zExtractDir -Filter "*.iso" -Recurse | Select-Object -First 1
    if (-not $isoFile) { throw "No ISO found in $7zExtractDir" }
    $isoPath = $isoFile.FullName

    # 4. 提取install.esd
    $esdExtractDir = Join-Path -Path $tempDir -ChildPath "$($source.Name)_EsdExtract"
    $esdPath = Extract-InstallEsdFromIso -IsoPath $isoPath -OutputDir $esdExtractDir

    # 5. 合并映像到WIM
    Add-ImageToWim -EsdPath $esdPath -TargetWimPath $targetWimPath -IsFirstImage $isFirstImage
    $isFirstImage = $false

    # 6. 逐源清理临时文件（7z/ISO/ESD）
    $tempFiles = $7zFiles + $isoPath + $esdPath + $7zExtractDir + $esdExtractDir
    Cleanup-TempFiles -FilesToDelete $tempFiles
}

# 转换WIM到ESD
Convert-WimToEsd -WimPath $targetWimPath -EsdPath $targetEsdPath
Cleanup-TempFiles -FilesToDelete @($targetWimPath)  # 清理WIM，仅保留ESD

# 分卷压缩ESD
$splitPrefix = Join-Path -Path $outputDir -ChildPath $releaseName
$splitFiles = Split-FileToVolumes -SourceFile $targetEsdPath -OutputPrefix $splitPrefix -VolumeSize $splitSize

# 发布到GitHub Releases
Publish-GitHubRelease -ReleaseName $releaseName -Tag $releaseName -FilesToUpload $splitFiles -RetentionDays $artifactRetentionDays

# 最终提示
Write-Host "`n==================================================" -ForegroundColor Green
Write-Host "All tasks completed successfully!" -ForegroundColor Green
Write-Host "Final files: $($splitFiles -join '; ')" -ForegroundColor Green
Write-Host "==================================================" -ForegroundColor Green
