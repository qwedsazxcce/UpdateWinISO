name: Windows_LTSC_ESD

# 下载地址集中配置（这次绝对能传递成功）
env:
  WIN10_X86_001_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001"
  WIN10_X86_002_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002"
  WIN10_X64_001_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001"
  WIN10_X64_002_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002"
  WIN10_X64_003_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003"
  WIN11_X64_001_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001"
  WIN11_X64_002_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002"
  WIN11_X64_003_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003"

on:
  workflow_dispatch:

jobs:
  build-esd:
    runs-on: windows-2022
    timeout-minutes: 360
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies (7-Zip + GH CLI)
        shell: pwsh
        run: |
          # 安装7-Zip
          if (-not (Test-Path "C:\Program Files\7-Zip\7z.exe")) {
            Write-Host "Installing 7-Zip..."
            choco install 7zip -y --no-progress
          }
          # 安装GitHub CLI
          if (-not (Get-Command "gh" -ErrorAction SilentlyContinue)) {
            Write-Host "Installing GitHub CLI..."
            choco install gh -y --no-progress
          }

      - name: Create temp directory
        shell: pwsh
        run: |
          $tempDir = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Temp_Win_Image"
          if (-not (Test-Path $tempDir)) {
            New-Item -ItemType Directory -Path $tempDir | Out-Null
            Write-Host "Temp dir created: $tempDir"
          }

      - name: Download & Extract files (核心逻辑，PowerShell无变量坑)
        shell: pwsh
        run: |
          # 调试：打印所有URL变量（确认传递成功）
          Write-Host "=== 调试：打印配置的URL ==="
          Write-Host "WIN10_X86_001_URL: $env:WIN10_X86_001_URL"
          Write-Host "WIN10_X86_002_URL: $env:WIN10_X86_002_URL"
          
          # 基础路径
          $tempDir = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Temp_Win_Image"
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          $targetWim = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32&64_Windows_11_LTSC2025.wim"

          # 下载函数（PowerShell版，稳定无坑）
          function Download-File {
            param(
              [Parameter(Mandatory=$true)]
              [string]$Url,
              [Parameter(Mandatory=$true)]
              [string]$SaveDir
            )

            # 强制校验URL非空
            if ([string]::IsNullOrEmpty($Url)) {
              Write-Error "传入的URL为空！"
              exit 1
            }

            # 提取文件名
            $fileName = [System.IO.Path]::GetFileName($Url)
            $savePath = Join-Path -Path $SaveDir -ChildPath $fileName

            # 跳过已存在的文件
            if (Test-Path $savePath) {
              Write-Host "文件已存在，跳过：$savePath"
              return
            }

            # 下载（带进度，重试3次）
            $retryCount = 0
            $maxRetry = 3
            while ($retryCount -lt $maxRetry) {
              try {
                Write-Host "下载尝试 $($retryCount+1)/$maxRetry：$Url"
                Invoke-WebRequest -Uri $Url -OutFile $savePath -TimeoutSec 600 -UseBasicParsing
                Write-Host "下载成功：$savePath"
                return
              }
              catch {
                $retryCount++
                Write-Warning "下载失败（$($_.Exception.Message)），5秒后重试..."
                Start-Sleep -Seconds 5
                if (Test-Path $savePath) { Remove-Item $savePath -Force }
              }
            }

            Write-Error "下载失败（重试$maxRetry次）：$Url"
            exit 1
          }

          # ========== 下载Win10 x86分卷 ==========
          Write-Host "`n=== 处理Win10 LTSC2021 x86 ==="
          Download-File -Url $env:WIN10_X86_001_URL -SaveDir $tempDir
          Download-File -Url $env:WIN10_X86_002_URL -SaveDir $tempDir

          # ========== 解压7z分卷 ==========
          Write-Host "`n=== 解压分卷 ==="
          $7zFile = Get-ChildItem -Path $tempDir -Filter "Windows10_LTSC2021_x86*.7z.001" | Select-Object -First 1
          if (-not $7zFile) {
            Write-Error "未找到7z分卷文件：$tempDir\Windows10_LTSC2021_x86*.7z.001"
            exit 1
          }
          Write-Host "解压文件：$($7zFile.FullName)"
          & $7zPath x -y -o"$tempDir" $7zFile.FullName | Out-Null
          if ($LASTEXITCODE -ne 0) {
            Write-Error "解压失败"
            exit 1
          }

          # ========== 提取install.esd ==========
          Write-Host "`n=== 提取install.esd ==="
          $isoFile = Get-ChildItem -Path $tempDir -Filter "Windows10_LTSC2021_x86*.iso" | Select-Object -First 1
          if (-not $isoFile) {
            Write-Error "未找到ISO文件"
            exit 1
          }
          & $7zPath x -y -o"$tempDir" $isoFile.FullName "sources/install.esd" | Out-Null
          $esdFile = Join-Path -Path $tempDir -ChildPath "sources/install.esd"
          if (-not (Test-Path $esdFile)) {
            Write-Error "install.esd提取失败：$esdFile"
            exit 1
          }

          # ========== 导出WIM ==========
          Write-Host "`n=== 导出WIM ==="
          if (-not (Test-Path $targetWim)) {
            dism /export-image /sourceimagefile:"$esdFile" /sourceindex:1 /destinationimagefile:"$targetWim" /compress:max /checkintegrity /quiet
          }
          else {
            dism /export-image /sourceimagefile:"$esdFile" /sourceindex:1 /destinationimagefile:"$targetWim" /destinationindex:2 /compress:max /checkintegrity /quiet
          }
          if ($LASTEXITCODE -ne 0) {
            Write-Error "WIM导出失败"
            exit 1
          }

          # ========== 清理临时文件 ==========
          Write-Host "`n=== 清理临时文件 ==="
          Remove-Item -Path (Join-Path $tempDir "Windows10_LTSC2021_x86*.7z.*") -Force -ErrorAction SilentlyContinue
          Remove-Item -Path $isoFile.FullName -Force -ErrorAction SilentlyContinue
          Remove-Item -Path (Join-Path $tempDir "sources") -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "清理完成"

      - name: Convert WIM to ESD
        shell: pwsh
        run: |
          $targetWim = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32&64_Windows_11_LTSC2025.wim"
          $targetEsd = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32&64_Windows_11_LTSC2025.esd"
          
          if (-not (Test-Path $targetWim)) {
            Write-Error "WIM文件不存在：$targetWim"
            exit 1
          }
          
          Write-Host "转换WIM为ESD..."
          dism /export-image /sourceimagefile:"$targetWim" /sourceindex:all /destinationimagefile:"$targetEsd" /compress:recovery /checkintegrity /quiet
          if ($LASTEXITCODE -ne 0) {
            Write-Error "ESD转换失败"
            exit 1
          }

      - name: Split ESD to 7z volumes
        shell: pwsh
        run: |
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          $targetEsd = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32&64_Windows_11_LTSC2025.esd"
          $splitPrefix = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Windows10_LTSC_2021_32&64_Windows_11_LTSC2025.7z"
          
          if (-not (Test-Path $targetEsd)) {
            Write-Error "ESD文件不存在：$targetEsd"
            exit 1
          }
          
          Write-Host "分卷压缩ESD（1950MB/卷）..."
          & $7zPath a -t7z -mx9 -v1950m -bb1 $splitPrefix $targetEsd
          if ($LASTEXITCODE -ne 0) {
            Write-Error "分卷压缩失败"
            exit 1
          }

      - name: Publish to GitHub Releases
        shell: pwsh
        run: |
          $releaseName = "Windows10_LTSC_2021_32&64_Windows_11_LTSC2025"
          $splitFiles = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "*.7z.*"
          
          if (-not $splitFiles) {
            Write-Error "无分卷文件可发布"
            exit 1
          }
          
          # 登录GH CLI
          Write-Host "登录GitHub CLI..."
          echo $env:GITHUB_TOKEN | gh auth login --with-token
          
          # 发布/更新Release
          $releaseExists = $false
          gh release view $releaseName 2>&1 | Out-Null
          if ($LASTEXITCODE -eq 0) {
            $releaseExists = $true
            Write-Host "更新已有Release：$releaseName"
            gh release delete-asset $releaseName *.7z.* -y 2>&1 | Out-Null
          }
          else {
            Write-Host "创建新Release：$releaseName"
          }
          
          $filePaths = $splitFiles | ForEach-Object { $_.FullName }
          if ($releaseExists) {
            gh release upload $releaseName $filePaths --clobber
          }
          else {
            gh release create $releaseName $filePaths --title $releaseName --notes "Auto-built Windows LTSC ESD"
          }
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Release发布失败"
            exit 1
          }

      - name: Cleanup all temp files
        if: always()
        shell: pwsh
        run: |
          $tempDir = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "Temp_Win_Image"
          Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path (Join-Path $env:GITHUB_WORKSPACE "*.wim") -Force -ErrorAction SilentlyContinue
          Remove-Item -Path (Join-Path $env:GITHUB_WORKSPACE "*.esd") -Force -ErrorAction SilentlyContinue
          Write-Host "所有临时文件清理完成"
