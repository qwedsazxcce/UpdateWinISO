name: Windows_10-11_ESD

# 定义工作流触发条件
on:
  workflow_dispatch:

# 环境变量：集中管理下载链接和关键文件名
env:
  # 核心目标文件名
  TARGET_WIM_NAME: "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim"
  TARGET_ESD_NAME: "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd"
  RELEASE_TAG: "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025"
  
  # 分卷大小（1950MB）
  SPLIT_SIZE: "1950M"

  # 真正的curl路径（解决PowerShell别名问题）
  CURL_PATH: "C:\\Program Files\\Git\\mingw64\\bin\\curl.exe"

  # Win10 x86 LTSC2021 7z分卷下载链接
  WIN10_X86_URLS: |
    https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001
    https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002

  # Win10 x64 LTSC2021 7z分卷下载链接
  WIN10_X64_URLS: |
    https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001
    https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002
    https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003

  # Win11 x64 LTSC2024 7z分卷下载链接
  WIN11_X64_URLS: |
    https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001
    https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002
    https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003

# 工作流核心任务
jobs:
  build-and-release:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
        working-directory: ${{ github.workspace }}

    steps:
      # 步骤1：初始化环境（验证curl路径、安装7zip、设置编码）
      - name: Initialize environment
        run: |
          # 设置PowerShell输出编码为UTF8
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8
          
          # 验证curl路径是否存在
          if (-not (Test-Path $env:CURL_PATH)) {
            throw "Real curl.exe not found at $($env:CURL_PATH)"
          }
          & $env:CURL_PATH --version
          
          # 安装7zip
          choco install 7zip -y --no-progress
          
          # 验证7z和DISM可用性
          7z --version
          dism /? | Out-Null
          Write-Host "Environment initialized successfully"

      # 步骤2：处理Win10 x86 LTSC2021镜像
      - name: Process Win10 x86 LTSC2021
        run: |
          Write-Host "=== Processing Win10 x86 LTSC2021 ==="
          
          # 1. 下载7z分卷（使用真正的curl.exe）
          $urls = $env:WIN10_X86_URLS -split "`n" | ForEach-Object { $_.Trim() }
          foreach ($url in $urls) {
            $filename = [System.IO.Path]::GetFileName($url)
            Write-Host "Downloading $filename from $url"
            & $env:CURL_PATH -L -o "$filename" "$url"
            if (-not (Test-Path $filename)) {
              throw "Failed to download $filename"
            }
          }
          
          # 2. 解压7z分卷
          $7zFiles = Get-ChildItem -Path *.7z.001 | Select-Object -First 1
          if (-not $7zFiles) { throw "7z split files not found" }
          $7zBaseName = $7zFiles.BaseName -replace '\.7z$', ''
          Write-Host "Extracting 7z files to ISO: $7zBaseName"
          7z x -y "$($7zFiles.FullName)" -o"." | Out-Host
          
          # 3. 找到解压后的ISO文件
          $isoFile = Get-ChildItem -Path *.iso | Select-Object -First 1
          if (-not $isoFile) { throw "ISO file not found after extraction" }
          Write-Host "Found ISO file: $($isoFile.FullName)"
          
          # 4. 解压ISO中的sources\install.esd
          Write-Host "Extracting install.esd from ISO"
          7z x -y "$($isoFile.FullName)" "sources\install.esd" -o"." | Out-Host
          if (-not (Test-Path "install.esd")) { throw "install.esd not extracted from ISO" }
          
          # 5. 提取install.esd第一个映像到目标WIM
          Write-Host "Exporting first image from install.esd to $($env:TARGET_WIM_NAME)"
          dism /export-image `
            /sourceimagefile:install.esd `
            /sourceindex:1 `
            /destinationimagefile:$($env:TARGET_WIM_NAME) `
            /compress:max `
            /checkintegrity
          
          # 6. 清理临时文件
          Write-Host "Cleaning temporary files for Win10 x86 LTSC2021"
          Remove-Item -Path *.7z.* -Force -ErrorAction SilentlyContinue
          Remove-Item -Path $isoFile.FullName -Force -ErrorAction SilentlyContinue
          Remove-Item -Path install.esd -Force -ErrorAction SilentlyContinue
          Write-Host "Win10 x86 LTSC2021 processed successfully"

      # 步骤3：处理Win10 x64 LTSC2021镜像
      - name: Process Win10 x64 LTSC2021
        run: |
          Write-Host "=== Processing Win10 x64 LTSC2021 ==="
          
          # 1. 下载7z分卷（使用真正的curl.exe）
          $urls = $env:WIN10_X64_URLS -split "`n" | ForEach-Object { $_.Trim() }
          foreach ($url in $urls) {
            $filename = [System.IO.Path]::GetFileName($url)
            Write-Host "Downloading $filename from $url"
            & $env:CURL_PATH -L -o "$filename" "$url"
            if (-not (Test-Path $filename)) {
              throw "Failed to download $filename"
            }
          }
          
          # 2. 解压7z分卷
          $7zFiles = Get-ChildItem -Path *.7z.001 | Select-Object -First 1
          if (-not $7zFiles) { throw "7z split files not found" }
          $7zBaseName = $7zFiles.BaseName -replace '\.7z$', ''
          Write-Host "Extracting 7z files to ISO: $7zBaseName"
          7z x -y "$($7zFiles.FullName)" -o"." | Out-Host
          
          # 3. 找到ISO并解压install.esd
          $isoFile = Get-ChildItem -Path *.iso | Select-Object -First 1
          if (-not $isoFile) { throw "ISO file not found after extraction" }
          Write-Host "Extracting install.esd from ISO: $($isoFile.FullName)"
          7z x -y "$($isoFile.FullName)" "sources\install.esd" -o"." | Out-Host
          if (-not (Test-Path "install.esd")) { throw "install.esd not extracted from ISO" }
          
          # 4. 提取第一个映像到临时install.wim
          Write-Host "Exporting first image from install.esd to temp install.wim"
          dism /export-image `
            /sourceimagefile:install.esd `
            /sourceindex:1 `
            /destinationimagefile:install.wim `
            /compress:max `
            /checkintegrity
          
          # 5. 追加临时WIM到目标WIM
          Write-Host "Appending install.wim to $($env:TARGET_WIM_NAME)"
          dism /append-image `
            /imagefile:$($env:TARGET_WIM_NAME) `
            /sourceimagefile:install.wim `
            /sourceindex:1 `
            /checkintegrity
          
          # 6. 清理临时文件
          Write-Host "Cleaning temporary files for Win10 x64 LTSC2021"
          Remove-Item -Path *.7z.* -Force -ErrorAction SilentlyContinue
          Remove-Item -Path $isoFile.FullName -Force -ErrorAction SilentlyContinue
          Remove-Item -Path install.esd -Force -ErrorAction SilentlyContinue
          Remove-Item -Path install.wim -Force -ErrorAction SilentlyContinue
          Write-Host "Win10 x64 LTSC2021 processed successfully"

      # 步骤4：处理Win11 x64 LTSC2024镜像
      - name: Process Win11 x64 LTSC2024
        run: |
          Write-Host "=== Processing Win11 x64 LTSC2024 ==="
          
          # 1. 下载7z分卷（使用真正的curl.exe）
          $urls = $env:WIN11_X64_URLS -split "`n" | ForEach-Object { $_.Trim() }
          foreach ($url in $urls) {
            $filename = [System.IO.Path]::GetFileName($url)
            Write-Host "Downloading $filename from $url"
            & $env:CURL_PATH -L -o "$filename" "$url"
            if (-not (Test-Path $filename)) {
              throw "Failed to download $filename"
            }
          }
          
          # 2. 解压7z分卷
          $7zFiles = Get-ChildItem -Path *.7z.001 | Select-Object -First 1
          if (-not $7zFiles) { throw "7z split files not found" }
          $7zBaseName = $7zFiles.BaseName -replace '\.7z$', ''
          Write-Host "Extracting 7z files to ISO: $7zBaseName"
          7z x -y "$($7zFiles.FullName)" -o"." | Out-Host
          
          # 3. 找到ISO并解压install.esd
          $isoFile = Get-ChildItem -Path *.iso | Select-Object -First 1
          if (-not $isoFile) { throw "ISO file not found after extraction" }
          Write-Host "Extracting install.esd from ISO: $($isoFile.FullName)"
          7z x -y "$($isoFile.FullName)" "sources\install.esd" -o"." | Out-Host
          if (-not (Test-Path "install.esd")) { throw "install.esd not extracted from ISO" }
          
          # 4. 提取第一个映像到临时install.wim
          Write-Host "Exporting first image from install.esd to temp install.wim"
          dism /export-image `
            /sourceimagefile:install.esd `
            /sourceindex:1 `
            /destinationimagefile:install.wim `
            /compress:max `
            /checkintegrity
          
          # 5. 追加临时WIM到目标WIM
          Write-Host "Appending install.wim to $($env:TARGET_WIM_NAME)"
          dism /append-image `
            /imagefile:$($env:TARGET_WIM_NAME) `
            /sourceimagefile:install.wim `
            /sourceindex:1 `
            /checkintegrity
          
          # 6. 清理临时文件
          Write-Host "Cleaning temporary files for Win11 x64 LTSC2024"
          Remove-Item -Path *.7z.* -Force -ErrorAction SilentlyContinue
          Remove-Item -Path $isoFile.FullName -Force -ErrorAction SilentlyContinue
          Remove-Item -Path install.esd -Force -ErrorAction SilentlyContinue
          Remove-Item -Path install.wim -Force -ErrorAction SilentlyContinue
          Write-Host "Win11 x64 LTSC2024 processed successfully"

      # 步骤5：将合并后的WIM转换为高压缩ESD
      - name: Convert WIM to ESD (high compression)
        run: |
          Write-Host "=== Converting WIM to ESD ==="
          if (-not (Test-Path $env:TARGET_WIM_NAME)) {
            throw "Target WIM file $($env:TARGET_WIM_NAME) not found"
          }
          
          # 转换WIM到ESD
          dism /export-image `
            /sourceimagefile:$($env:TARGET_WIM_NAME) `
            /sourceindex:1 `
            /destinationimagefile:$($env:TARGET_ESD_NAME) `
            /compress:recovery `
            /checkintegrity
          
          # 验证ESD文件生成
          if (-not (Test-Path $env:TARGET_ESD_NAME)) {
            throw "ESD conversion failed: $($env:TARGET_ESD_NAME) not created"
          }
          
          # 清理原始WIM文件
          Remove-Item -Path $env:TARGET_WIM_NAME -Force -ErrorAction SilentlyContinue
          Write-Host "Successfully converted WIM to ESD: $($env:TARGET_ESD_NAME)"

      # 步骤6：7z分卷压缩ESD（1950M/卷）
      - name: Split ESD with 7z (1950M per volume)
        run: |
          Write-Host "=== Splitting ESD into $($env:SPLIT_SIZE) volumes ==="
          if (-not (Test-Path $env:TARGET_ESD_NAME)) {
            throw "ESD file $($env:TARGET_ESD_NAME) not found"
          }
          
          # 7z分卷压缩
          7z a -y -t7z -mx=9 -v$($env:SPLIT_SIZE) "$($env:TARGET_ESD_NAME).7z" "$($env:TARGET_ESD_NAME)" | Out-Host
          
          # 验证分卷生成
          $splitFiles = Get-ChildItem -Path "$($env:TARGET_ESD_NAME).7z.*"
          if (-not $splitFiles) {
            throw "7z split volumes not created"
          }
          
          # 清理原始ESD文件
          Remove-Item -Path $env:TARGET_ESD_NAME -Force -ErrorAction SilentlyContinue
          Write-Host "Successfully split ESD into $($splitFiles.Count) volumes"

      # 步骤7：发布到GitHub Releases
      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          files: |
            ${{ github.workspace }}/${{ env.TARGET_ESD_NAME }}.7z.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
