name: 从OneDrive下载文件→保留原名→发布到指定Release
on:
  workflow_dispatch:  # 手动触发，避免误执行

jobs:
  download-upload:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：创建目录存放下载的文件
      - name: 创建文件存储目录
        run: mkdir -p ./onedrive-downloads

      # 步骤2：下载OneDrive文件（修正curl参数，解决--timeout报错）
      - name: 从OneDrive下载并保留原文件名
        run: |
          # OneDrive公开分享链接
          ONEDRIVE_URL="https://1drv.ms/f/c/371b320e0c098119/IgDA0vyfMhr-Q5daEnkYtiWvAXe-9LfPzICx8GITsOQkDqY?e=6pViqC"
          
          # 修正后的curl参数（兼容所有版本）
          # --max-time 300：替代--timeout，设置5分钟超时（核心修正）
          # -L：跟随重定向 | -O：保留原文件名 | -J：遵从服务器文件名
          # --retry 10：重试10次 | --retry-delay 5：重试间隔5秒
          curl -L -O -J --retry 10 --retry-delay 5 --max-time 300 \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            "${ONEDRIVE_URL}" --output-dir ./onedrive-downloads/  # 兼容写法：指定下载目录
          
          # 验证下载结果
          echo "下载的文件列表："
          ls -lh ./onedrive-downloads/

      # 步骤3：发布到Server_2022-2025标签的Releases
      - name: 上传到指定Release标签
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Server_2022-2025
          release_name: Windows Server 2022 + 2025 镜像文件
          files: ./onedrive-downloads/*
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
