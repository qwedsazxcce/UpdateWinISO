name: Windows_LTSC_ESD

on:
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  LC_ALL: C.UTF-8
  LANG: C.UTF-8
  DOWNLOAD_URLS_1: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002
  DOWNLOAD_URLS_2: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003
  DOWNLOAD_URLS_3: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003
  TARGET_WIM: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim
  TARGET_ESD: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd

jobs:
  build-esd:
    runs-on: windows-latest
    timeout-minutes: 180
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Force Global UTF8 Encoding
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.UTF8Encoding]::UTF8
          $PSDefaultParameterValues['*:Encoding'] = 'utf8'
          Write-Host "Console Encoding: $([Console]::OutputEncoding.EncodingName)"

      - name: Install 7-Zip
        shell: powershell
        run: |
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $7zPath)) {
              choco install 7zip -y --no-progress --ignore-checksums --force
              if (-not (Test-Path $7zPath)) { throw "7-Zip installation failed" }
          }
          $env:PATH += ";C:\Program Files\7-Zip"
          Write-Host "7-Zip path: $7zPath"

      - name: Process All Files (100% Working Split)
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::UTF8

          function Process-7z-ISO {
              param(
                  [string]$UrlCsv,
                  [string]$TargetWim
              )

              $urls = $UrlCsv -split ',' | ForEach-Object { $_.Trim() } | Where-Object { $_ }
              if ($urls.Count -eq 0) { throw "URL list is empty" }
              Write-Host "`n=== Processing: $($urls.Count) volumes ==="

              $tempDir = New-Item -Path "$env:GITHUB_WORKSPACE\temp_$(Get-Random)" -ItemType Directory -Force
              $dlDir = New-Item -Path "$tempDir\downloads" -ItemType Directory -Force
              $extractDir = New-Item -Path "$tempDir\extract" -ItemType Directory -Force

              try {
                  # Download volumes
                  foreach ($url in $urls) {
                      $fileName = [System.IO.Path]::GetFileName($url)
                      $savePath = "$dlDir\$fileName"
                      Write-Host "Downloading: $fileName"
                      curl.exe --progress-bar -L -f -o "$savePath" "$url"
                      if (-not (Test-Path $savePath) -or (Get-Item $savePath).Length -lt 1024) {
                          throw "Download failed: $fileName"
                      }
                      Write-Host "Downloaded: $fileName ($([math]::Round((Get-Item $savePath).Length/1GB,2)) GB)"
                  }

                  # Extract 7z
                  $7z001 = Get-ChildItem -Path $dlDir -Filter "*.7z.001" | Select-Object -First 1
                  if (-not $7z001) { throw "7z.001 not found" }
                  Write-Host "`nExtracting: $($7z001.Name)"
                  & "C:\Program Files\7-Zip\7z.exe" x -y -bb1 -o"$extractDir" "$($7z001.FullName)"
                  if ($LASTEXITCODE -ne 0) { throw "7z extract failed (code: $LASTEXITCODE)" }

                  # Find ISO
                  $isoFiles = Get-ChildItem -Path $extractDir -Filter "*.iso" -Recurse
                  if ($isoFiles.Count -eq 0) {
                      Get-ChildItem -Path $extractDir -Recurse | ForEach-Object { Write-Host " - $($_.FullName)" }
                      throw "ISO not found"
                  }
                  $isoFile = $isoFiles | Select-Object -First 1
                  Write-Host "Found ISO: $($isoFile.FullName)"

                  # Extract install.esd
                  $isoExtractDir = New-Item -Path "$tempDir\iso_extract" -ItemType Directory -Force
                  Write-Host "`nExtracting install.esd..."
                  & "C:\Program Files\7-Zip\7z.exe" x -y -o"$isoExtractDir" "$isoFile.FullName" "sources\install.esd"
                  $esdFile = "$isoExtractDir\sources\install.esd"
                  if (-not (Test-Path $esdFile)) { throw "install.esd not found" }
                  Write-Host "Found install.esd: $esdFile"

                  # Export to WIM
                  Write-Host "`nExporting image to WIM..."
                  if (-not (Test-Path $TargetWim)) {
                      dism /Export-Image `
                          /SourceImageFile:"$esdFile" `
                          /SourceIndex:1 `
                          /DestinationImageFile:"$TargetWim" `
                          /Compress:max `
                          /CheckIntegrity
                      if ($LASTEXITCODE -ne 0) { throw "DISM export failed (code: $LASTEXITCODE)" }
                  } else {
                      dism /Export-Image `
                          /SourceImageFile:"$esdFile" `
                          /SourceIndex:1 `
                          /DestinationImageFile:"$TargetWim" `
                          /Compress:max `
                          /CheckIntegrity
                      if ($LASTEXITCODE -ne 0) { throw "DISM append failed (code: $LASTEXITCODE)" }
                  }

                  # Verify WIM
                  if (-not (Test-Path $TargetWim) -or (Get-Item $TargetWim).Length -lt 1024) {
                      throw "WIM file is empty or missing"
                  }
                  Write-Host "WIM export success: $TargetWim (Size: $([math]::Round((Get-Item $TargetWim).Length/1GB,2)) GB)"

              } finally {
                  Write-Host "`nCleaning temp dir: $tempDir"
                  Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
              }
          }

          # Process all groups
          $finalWim = "$env:GITHUB_WORKSPACE\$env:TARGET_WIM"
          Process-7z-ISO -UrlCsv $env:DOWNLOAD_URLS_1 -TargetWim $finalWim
          Process-7z-ISO -UrlCsv $env:DOWNLOAD_URLS_2 -TargetWim $finalWim
          Process-7z-ISO -UrlCsv $env:DOWNLOAD_URLS_3 -TargetWim $finalWim

          # Convert WIM to ESD
          Write-Host "`n=== Converting WIM to ESD ==="
          $esdFile = "$env:GITHUB_WORKSPACE\$env:TARGET_ESD"
          
          # Force DISM English output + regex match
          $env:DISM_LOG_LEVEL = 4
          $env:DISM_OUTPUT_LANGUAGE = "en-US"
          $dismOutput = dism /Get-WimInfo /WimFile:$finalWim 2>&1 | Out-String
          $imgMatches = [regex]::Matches($dismOutput, '(Index|索引)\s*\:\s*(\d+)')
          $imgTotal = $imgMatches.Count
          
          if ($imgTotal -eq 0) {
              Write-Warning "Fallback to export index 1"
              $imgTotal = 1
          }
          Write-Host "Found $imgTotal images in WIM"

          # Export to ESD
          for ($i=1; $i -le $imgTotal; $i++) {
              Write-Host "Exporting image $i/$imgTotal to ESD..."
              dism /Export-Image `
                  /SourceImageFile:$finalWim `
                  /SourceIndex:$i `
                  /DestinationImageFile:$esdFile `
                  /Compress:recovery `
                  /CheckIntegrity
              if ($LASTEXITCODE -ne 0) { throw "ESD export failed (image $i, code: $LASTEXITCODE)" }
          }

          # Verify ESD
          if (-not (Test-Path $esdFile)) { throw "ESD file not created" }
          Write-Host "ESD created successfully (Size: $([math]::Round((Get-Item $esdFile).Length/1GB,2)) GB)"
          Remove-Item -Path $finalWim -Force

          # ========== 核心修复：直接硬编码1950M，彻底规避变量解析问题 ==========
          Write-Host "`n=== Splitting ESD (1950M) ==="
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          $splitOutput = "$esdFile.7z"
          
          # 关键：直接使用 -v1950M，不使用任何变量，7-Zip能100%识别
          Write-Host "Running 7-Zip command: $7zPath a -y -mx=9 -v1950M ""$splitOutput"" ""$esdFile"""
          & $7zPath a -y -mx=9 -v1950M "$splitOutput" "$esdFile"
          
          if ($LASTEXITCODE -ne 0) { 
              throw "7z split failed (code: $LASTEXITCODE)" 
          }

          # Verify split files
          $splitFiles = Get-ChildItem -Path "$env:GITHUB_WORKSPACE" -Filter "$($env:TARGET_ESD).7z.*" | Sort-Object Name
          if ($splitFiles.Count -eq 0) { throw "No split files created" }
          Write-Host "Split success: $($splitFiles.Count) volumes created"
          foreach ($file in $splitFiles) {
              Write-Host " - $($file.Name) ($([math]::Round($file.Length/1GB,2)) GB)"
          }

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TARGET_WIM }}
          name: ${{ env.TARGET_WIM }}
          files: ${{ github.workspace }}/${{ env.TARGET_ESD }}.7z.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Final Cleanup
        if: always()
        shell: powershell
        run: |
          Write-Host "=== Final Cleanup ==="
          Remove-Item -Path "$env:GITHUB_WORKSPACE\temp_*" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Cleanup completed!"
