name: 稳定下载Server2025 ISO→同名分卷压缩→发布到Release
on:
  workflow_dispatch:  # 手动触发，避免误执行

jobs:
  download-compress-upload:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：安装7z压缩工具
      - name: 安装p7zip-full
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      # 步骤2：创建存储目录（区分原始ISO和压缩分卷）
      - name: 创建目录
        run: |
          mkdir -p ./server-iso  # 存放重命名后的ISO
          mkdir -p ./server-7z-split  # 存放同名压缩分卷

      # 步骤3：换wget下载（解决curl重试失败，加稳连参数）
      - name: 稳定下载并命名为指定ISO文件名
        run: |
          # 定义目标文件名（严格匹配你的要求）
          ISO_NAME="zh-X23-81954_26100.1742.240906-0331.ge_release_svc_refresh_SERVER_OEMRET_x64FRE_zh-cn.iso"
          # 下载链接（双引号包裹特殊字符）
          DOWNLOAD_URL="https://oemsoc.download.prss.microsoft.com/dbazure/X23-81954_26100.1742.240906-0331.ge_release_svc_refresh_SERVER_OEMRET_x64FRE_zh-cn.iso_c0a03233-3c87-4c90-9fac-9cbf668255c1?t=fdfcc05d-ef3b-45a4-8f87-cd492f6d10de&P1=102817441905&P2=601&P3=2&P4=phtRoTOxQBx%2bH5nhSijWBQw9deo3wwkODOj9HbwaH1%2fC%2bYTg5C7FrUUduOXIC9TzweFPlCY0YlpXM1ZD%2fj3dYrYwBbRnCeeDOvzHTjIMoZvtjfKHH%2bfI3IdPFJBa6gv5sL69QQFUUmaWqRHCTT81p6IYcNwuwOUrNW9u3BVttXiQNIAX9XrrYbWAHHmfkLW3wR2YdstEsFxF8sIQ4w1V6Znm3B7NO7Rv%2fjk3nyhQ9zzMjZFjdIlkZg4NbAhYE12EZr9pHHR0AHQeW2%2fN%2fVhGjoaYWYjHMTtfNV48EJbeQoQKrrfdLTQ%2fHk6%2bGUxO5D8xCPfkr0vpr7oBo2uICepJ3w%3d%3d"
          
          # 核心：wget稳连参数（解决重试失败）
          # --retry-connrefused：连接被拒也重试
          # --waitretry=5：重试间隔5秒
          # --timeout=600：超时时间10分钟（应对大文件）
          # --continue：断点续传（断了能接着下）
          # --user-agent：模拟浏览器UA（避免服务器拦截）
          # -O：强制命名为指定文件名
          wget --retry-connrefused --waitretry=5 --timeout=600 --tries=20 --continue --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" -O ./server-iso/${ISO_NAME} "${DOWNLOAD_URL}"
          
          # 验证下载结果：查看文件名+大小，确认下载成功
          ls -lh ./server-iso/

      # 步骤4：同名分卷压缩（1950M/卷，去掉.iso后缀）
      - name: 1950M分卷压缩（与ISO同名）
        run: |
          ISO_NAME="zh-X23-81954_26100.1742.240906-0331.ge_release_svc_refresh_SERVER_OEMRET_x64FRE_zh-cn.iso"
          # 压缩包名=ISO名去掉.iso后缀 → 分卷名=xxx.7z.001/002...
          COMPRESS_NAME="${ISO_NAME%.iso}"
          # 7z参数：-v1950M=1950M/卷，-mx=9=最高压缩，-bb1=显示压缩进度
          7z a -v1950M -mx=9 -bb1 ./server-7z-split/${COMPRESS_NAME}.7z ./server-iso/${ISO_NAME}
          
          # 验证压缩结果：查看分卷文件名
          ls -lh ./server-7z-split/

      # 步骤5：发布到server 2022-2025标签的Releases
      - name: 上传到指定Release标签
        uses: softprops/action-gh-release@v2
        with:
          tag_name: server 2022-2025  # 目标Release标签
          release_name: Windows Server 2022 + 2025 原版镜像分卷
          files: ./server-7z-split/*  # 上传所有压缩分卷
          overwrite: true  # 追加/覆盖已有文件，保留标签下其他内容
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动提供，无需配置
