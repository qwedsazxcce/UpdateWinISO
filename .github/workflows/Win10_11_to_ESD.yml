name: Windows_LTSC_ESD

env:
  WIN10_LTSC_X86_URLS: 'https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001;https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002'
  WIN10_LTSC_AMD64_URLS: 'https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001;https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002;https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003'
  WIN11_LTSC_AMD64_URLS: 'https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001;https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002;https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003'
  TARGET_WIM: 'Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim'
  TARGET_ESD: 'Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd'
  RELEASE_NAME: 'Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025'

jobs:
  build-and-publish:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and process Windows 10 x86
        run: |
          $urls = $env:WIN10_LTSC_X86_URLS -split ';'
          foreach ($url in $urls) {
            $filename = [System.IO.Path]::GetFileName($url)
            Write-Host "Downloading $filename..."
            curl -L -O -# $url
          }
          
          $firstFile = $urls[0]
          $zipName = [System.IO.Path]::GetFileNameWithoutExtension($firstFile)
          Write-Host "Extracting $zipName.001..."
          7z x "$zipName.001" -o. -y
          
          $isoFile = Get-ChildItem -Path . -Filter "*.iso" -Recurse | Select-Object -First 1
          if (-not $isoFile) { throw "ISO file not found" }
          
          Write-Host "Extracting install.esd from $isoFile..."
          7z x $isoFile.FullName -o. "sources\install.esd"
          
          Write-Host "Exporting first image to $env:TARGET_WIM..."
          if (-not (Test-Path $env:TARGET_WIM)) {
            dism /Export-Image /SourceImageFile:"sources\install.esd" /SourceIndex:1 /DestinationImageFile:$env:TARGET_WIM
          } else {
            dism /Export-Image /SourceImageFile:"sources\install.esd" /SourceIndex:1 /DestinationImageFile:$env:TARGET_WIM /Append
          }
          
          Write-Host "Cleaning temporary files..."
          Remove-Item $urls -Force
          Remove-Item $isoFile.FullName -Force
          Remove-Item "sources\install.esd" -Force

      - name: Download and process Windows 10 AMD64
        run: |
          $urls = $env:WIN10_LTSC_AMD64_URLS -split ';'
          foreach ($url in $urls) {
            $filename = [System.IO.Path]::GetFileName($url)
            Write-Host "Downloading $filename..."
            curl -L -O -# $url
          }
          
          $firstFile = $urls[0]
          $zipName = [System.IO.Path]::GetFileNameWithoutExtension($firstFile)
          Write-Host "Extracting $zipName.001..."
          7z x "$zipName.001" -o. -y
          
          $isoFile = Get-ChildItem -Path . -Filter "*.iso" -Recurse | Select-Object -First 1
          if (-not $isoFile) { throw "ISO file not found" }
          
          Write-Host "Extracting install.esd from $isoFile..."
          7z x $isoFile.FullName -o. "sources\install.esd"
          
          Write-Host "Exporting first image to $env:TARGET_WIM..."
          dism /Export-Image /SourceImageFile:"sources\install.esd" /SourceIndex:1 /DestinationImageFile:$env:TARGET_WIM /Append
          
          Write-Host "Cleaning temporary files..."
          Remove-Item $urls -Force
          Remove-Item $isoFile.FullName -Force
          Remove-Item "sources\install.esd" -Force

      - name: Download and process Windows 11 LTSC
        run: |
          $urls = $env:WIN11_LTSC_AMD64_URLS -split ';'
          foreach ($url in $urls) {
            $filename = [System.IO.Path]::GetFileName($url)
            Write-Host "Downloading $filename..."
            curl -L -O -# $url
          }
          
          $firstFile = $urls[0]
          $zipName = [System.IO.Path]::GetFileNameWithoutExtension($firstFile)
          Write-Host "Extracting $zipName.001..."
          7z x "$zipName.001" -o. -y
          
          $isoFile = Get-ChildItem -Path . -Filter "*.iso" -Recurse | Select-Object -First 1
          if (-not $isoFile) { throw "ISO file not found" }
          
          Write-Host "Extracting install.esd from $isoFile..."
          7z x $isoFile.FullName -o. "sources\install.esd"
          
          Write-Host "Exporting first image to $env:TARGET_WIM..."
          dism /Export-Image /SourceImageFile:"sources\install.esd" /SourceIndex:1 /DestinationImageFile:$env:TARGET_WIM /Append
          
          Write-Host "Cleaning temporary files..."
          Remove-Item $urls -Force
          Remove-Item $isoFile.FullName -Force
          Remove-Item "sources\install.esd" -Force

      - name: Convert WIM to ESD
        run: |
          Write-Host "Converting $env:TARGET_WIM to $env:TARGET_ESD..."
          dism /Export-Image /SourceImageFile:$env:TARGET_WIM /SourceIndex:1 /DestinationImageFile:$env:TARGET_ESD
          Remove-Item $env:TARGET_WIM -Force

      - name: Split ESD into 1950MB chunks
        run: |
          Write-Host "Splitting $env:TARGET_ESD into 1950MB chunks..."
          7z a -v1950m "$env:RELEASE_NAME.7z" $env:TARGET_ESD
          Remove-Item $env:TARGET_ESD -Force

      - name: Upload release assets
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_name: ${{ env.RELEASE_NAME }}.7z.001
          asset_path: ${{ env.RELEASE_NAME }}.7z.001

      - name: Upload release assets (continuation)
        if: ${{ github.event_name == 'release' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_name: ${{ env.RELEASE_NAME }}.7z.002
          asset_path: ${{ env.RELEASE_NAME }}.7z.002

      - name: Upload release assets (final)
        if: ${{ github.event_name == 'release' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_name: ${{ env.RELEASE_NAME }}.7z.003
          asset_path: ${{ env.RELEASE_NAME }}.7z.003
