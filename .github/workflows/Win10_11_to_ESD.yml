name: Windows10_11_LTSC (Resumable)

on:
  workflow_dispatch:

env:
  # åŸºç¡€ç¼–ç é…ç½®
  PYTHONIOENCODING: utf-8
  LC_ALL: C.UTF-8
  LANG: C.UTF-8
  # ç›®æ ‡æ–‡ä»¶å‘½å
  TARGET_WIM: Windows10_LTSC2021_32&64.wim
  TARGET_ESD: Windows10_LTSC2021_32&64.esd
  RELEASE_TAG: Windows10_LTSC2021_32&64
  # Win10/11å‹ç¼©åŒ…URL + å¯¹åº”æ˜ åƒç´¢å¼•ï¼ˆæ›¿æ¢ä¸ºä½ å®é™…çš„URLï¼‰
  URLS_WIN10_X86: >
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows10x86LTSC2021-26.1.15/install_Windows10x86LTSC2021-26.1.15.7z.001,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows10x86LTSC2021-26.1.15/install_Windows10x86LTSC2021-26.1.15.7z.002,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows10x86LTSC2021-26.1.15/install_Windows10x86LTSC2021-26.1.15.7z.003
  IMG_INDEX_WIN10_X86: 5
  URLS_WIN10_X64: >
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows10x64LTSC2021-26.1.15/install_Windows10x64LTSC2021-26.1.15.7z.001,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows10x64LTSC2021-26.1.15/install_Windows10x64LTSC2021-26.1.15.7z.002,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows10x64LTSC2021-26.1.15/install_Windows10x64LTSC2021-26.1.15.7z.003
  IMG_INDEX_WIN10_X64: 4
  URLS_WIN11_X64: >
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows11x64LTSC2024-26.1.15/install_Windows11x64LTSC2024-26.1.15.7z.001,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows11x64LTSC2024-26.1.15/install_Windows11x64LTSC2024-26.1.15.7z.002
  IMG_INDEX_WIN11_X64: 1

# æ‹†åˆ†4ä¸ªç‹¬ç«‹Jobï¼Œæ¯æ­¥ä¿ç•™æˆæœï¼Œå‡ºé”™ä¸ä¸¢æ–‡ä»¶
jobs:
  # Job1: ä¸‹è½½+è§£å‹+å¯¼å‡ºæŒ‡å®šæ˜ åƒâ†’åˆå¹¶ä¸ºç›®æ ‡WIMï¼ˆæ ¸å¿ƒè€—æ—¶æ­¥éª¤ï¼‰
  build-wim:
    runs-on: windows-latest
    timeout-minutes: 180
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Force Global UTF8 Encoding
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.UTF8Encoding]::UTF8
          $PSDefaultParameterValues['*:Encoding'] = 'utf8'
          Write-Host "âœ… UTF8ç¼–ç å·²å¯ç”¨"

      - name: Install 7-Zip
        shell: powershell
        run: |
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $7zPath)) {
              Write-Host "ğŸ”§ æ­£åœ¨å®‰è£…7-Zip..."
              choco install 7zip -y --no-progress --ignore-checksums --force
          }
          if (-not (Test-Path $7zPath)) { throw "âŒ 7-Zipå®‰è£…å¤±è´¥" }
          $env:PATH += ";C:\Program Files\7-Zip"
          Write-Host "âœ… 7-Zipå®‰è£…å®Œæˆ: $7zPath"

      - name: æ„å»ºç›®æ ‡WIMï¼ˆä¸‹è½½+è§£å‹+å¯¼å‡ºæŒ‡å®šæ˜ åƒï¼‰
        shell: powershell
        run: |
          # æ ¸å¿ƒå‡½æ•°ï¼šå¤„ç†å•ç»„åˆ†å·â†’è§£å‹â†’å¯¼å‡ºæŒ‡å®šæ˜ åƒâ†’æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          function Process-7z-Export-Image {
              param(
                  [string]$UrlCsv,
                  [int]$ImageIndex,
                  [string]$VolumeName,
                  [string]$TargetWim
              )

              Write-Host "`n====================================="
              Write-Host "ğŸ”„ å¤„ç†: $VolumeName (æ˜ åƒç´¢å¼•: $ImageIndex)"
              Write-Host "====================================="

              # 1. æ¸…ç†æ—§ä¸´æ—¶æ–‡ä»¶ï¼ˆé˜²æ­¢æ®‹ç•™ï¼‰
              $tempRoot = "$env:GITHUB_WORKSPACE\temp_$VolumeName"
              if (Test-Path $tempRoot) {
                  Write-Host "ğŸ§¹ æ¸…ç†æ—§ä¸´æ—¶ç›®å½•: $tempRoot"
                  Remove-Item -Path $tempRoot -Recurse -Force -ErrorAction SilentlyContinue
              }

              # 2. åˆ›å»ºä¸´æ—¶ç›®å½•ï¼ˆç”¨FullNameç¡®ä¿è·¯å¾„æ­£ç¡®ï¼‰
              $dlDir = New-Item -Path "$tempRoot\downloads" -ItemType Directory -Force
              $extractDir = New-Item -Path "$tempRoot\extract" -ItemType Directory -Force
              Write-Host "ğŸ“ ä¸´æ—¶ç›®å½•åˆ›å»ºå®Œæˆ: $($tempRoot.FullName)"

              try {
                  # 3. æ‹†åˆ†å¹¶æ¸…æ´—URLï¼ˆå»é™¤ç©ºæ ¼/æ¢è¡Œï¼‰
                  $urls = $UrlCsv -split ',' | ForEach-Object { $_.Trim() } | Where-Object { $_ }
                  if ($urls.Count -eq 0) { throw "âŒ $VolumeNameçš„URLåˆ—è¡¨ä¸ºç©º" }
                  Write-Host "ğŸ“¥ å¼€å§‹ä¸‹è½½$($urls.Count)ä¸ªåˆ†å·..."

                  # 4. ä¸‹è½½æ‰€æœ‰åˆ†å·ï¼ˆåŠ è¶…æ—¶+é‡è¯•ï¼Œé¿å…ç½‘ç»œé—®é¢˜ï¼‰
                  foreach ($url in $urls) {
                      $fileName = [System.IO.Path]::GetFileName($url)
                      # å…³é”®ä¿®å¤ï¼šç”¨Join-Pathæ‹¼æ¥è·¯å¾„ï¼Œé¿å…åˆ†éš”ç¬¦é”™è¯¯
                      $savePath = Join-Path -Path $dlDir.FullName -ChildPath $fileName
                      
                      Write-Host "â¬‡ï¸ ä¸‹è½½: $fileName â†’ $savePath"
                      # curlå¢å¼ºï¼šè¶…æ—¶300ç§’ï¼Œé‡è¯•3æ¬¡
                      curl.exe --progress-bar -L -f -o "$savePath" "$url" --max-time 300 --retry 3
                      
                      # ä¸¥æ ¼éªŒè¯ä¸‹è½½ç»“æœ
                      if (-not (Test-Path $savePath)) {
                          throw "âŒ ä¸‹è½½å¤±è´¥ï¼š$fileName æœªæ‰¾åˆ°ï¼Œè·¯å¾„: $savePath"
                      }
                      $fileSize = (Get-Item $savePath).Length
                      if ($fileSize -lt 1024) {
                          throw "âŒ ä¸‹è½½å¤±è´¥ï¼š$fileName ä¸ºç©ºæ–‡ä»¶ï¼ˆå¤§å°: $fileSize å­—èŠ‚ï¼‰"
                      }
                      $fileSizeGB = [math]::Round($fileSize/1GB,2)
                      Write-Host "âœ… ä¸‹è½½å®Œæˆ: $fileName ($fileSizeGB GB)"
                  }

                  # 5. æŸ¥æ‰¾7z.001åˆ†å·ï¼ˆå…³é”®ä¿®å¤ï¼šæ­£ç¡®è·å–æ–‡ä»¶è·¯å¾„ï¼‰
                  Write-Host "ğŸ” æŸ¥æ‰¾7z.001åˆ†å·åœ¨: $($dlDir.FullName)"
                  $7z001Files = Get-ChildItem -Path $dlDir.FullName -Filter "*.7z.001"
                  if ($7z001Files.Count -eq 0) {
                      # åˆ—å‡ºç›®å½•å†…å®¹ï¼Œæ–¹ä¾¿æ’æŸ¥
                      Write-Host "âŒ æœªæ‰¾åˆ°7z.001åˆ†å·ï¼ä¸‹è½½ç›®å½•å†…å®¹ï¼š"
                      Get-ChildItem -Path $dlDir.FullName | ForEach-Object { 
                          Write-Host " - $($_.FullName) (å¤§å°: $([math]::Round($_.Length/1GB,2)) GB)" 
                      }
                      throw "âŒ $VolumeNameçš„7z.001åˆ†å·æœªæ‰¾åˆ°"
                  }
                  $7z001 = $7z001Files | Select-Object -First 1
                  $7z001Path = $7z001.FullName  # å…³é”®ä¿®å¤ï¼šæ­£ç¡®è·å–FullNameå±æ€§
                  Write-Host "ğŸ—œï¸ å¼€å§‹è§£å‹7zåˆ†å·: $7z001Path"
                  
                  # 6. è§£å‹7zåˆ†å·ï¼ˆè·¯å¾„å¼•ç”¨å®Œå…¨æ­£ç¡®ï¼‰
                  & "C:\Program Files\7-Zip\7z.exe" x -y -bb1 -o"$($extractDir.FullName)" "$7z001Path"
                  if ($LASTEXITCODE -ne 0) { throw "âŒ 7zè§£å‹å¤±è´¥ï¼ˆé”™è¯¯ç : $LASTEXITCODEï¼‰" }
                  Write-Host "âœ… è§£å‹å®Œæˆåˆ°: $($extractDir.FullName)"

                  # 7. æŸ¥æ‰¾è§£å‹åçš„WIMæ–‡ä»¶
                  Write-Host "ğŸ” æŸ¥æ‰¾è§£å‹åçš„WIMæ–‡ä»¶..."
                  $wimFiles = Get-ChildItem -Path $extractDir.FullName -Filter "*.wim" -Recurse
                  if ($wimFiles.Count -eq 0) {
                      Write-Host "âŒ æœªæ‰¾åˆ°WIMæ–‡ä»¶ï¼è§£å‹ç›®å½•å†…å®¹ï¼š"
                      Get-ChildItem -Path $extractDir.FullName -Recurse | ForEach-Object { 
                          Write-Host " - $($_.FullName)" 
                      }
                      throw "âŒ $VolumeNameè§£å‹åæœªæ‰¾åˆ°WIMæ–‡ä»¶"
                  }
                  $sourceWim = $wimFiles | Select-Object -First 1
                  Write-Host "âœ… æ‰¾åˆ°æºWIMæ–‡ä»¶: $($sourceWim.FullName)"

                  # 8. å¯¼å‡ºæŒ‡å®šç´¢å¼•çš„æ˜ åƒåˆ°ç›®æ ‡WIM
                  Write-Host "ğŸ“¤ å¯¼å‡ºæ˜ åƒ $ImageIndex åˆ° $TargetWim..."
                  if (-not (Test-Path $TargetWim)) {
                      # é¦–æ¬¡å¯¼å‡ºï¼šåˆ›å»ºæ–°WIM
                      dism /Export-Image `
                          /SourceImageFile:"$($sourceWim.FullName)" `
                          /SourceIndex:$ImageIndex `
                          /DestinationImageFile:"$TargetWim" `
                          /Compress:max `
                          /CheckIntegrity
                  } else {
                      # è¿½åŠ å¯¼å‡ºï¼šåˆå¹¶åˆ°ç°æœ‰WIM
                      dism /Export-Image `
                          /SourceImageFile:"$($sourceWim.FullName)" `
                          /SourceIndex:$ImageIndex `
                          /DestinationImageFile:"$TargetWim" `
                          /Compress:max `
                          /CheckIntegrity
                  }
                  
                  if ($LASTEXITCODE -ne 0) { throw "âŒ DISMå¯¼å‡ºå¤±è´¥ï¼ˆé”™è¯¯ç : $LASTEXITCODEï¼‰" }
                  Write-Host "âœ… æ˜ åƒ $ImageIndex å¯¼å‡ºå®Œæˆåˆ° $TargetWim"

              } catch {
                  Write-Host "âŒ å¤„ç†å¤±è´¥: $_" -ForegroundColor Red
                  throw $_
              } finally {
                  # 9. å¼ºåˆ¶åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼ˆæ¯æ­¥å¿…æ¸…ï¼‰
                  Write-Host "ğŸ§¹ åˆ é™¤ä¸´æ—¶ç›®å½•: $tempRoot"
                  Remove-Item -Path $tempRoot -Recurse -Force -ErrorAction SilentlyContinue
                  Write-Host "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
              }
          }

          # ========== å¤„ç†Win10/11å‹ç¼©åŒ… ==========
          $finalWim = "$env:GITHUB_WORKSPACE\$env:TARGET_WIM"

          # 1. å¤„ç†Win10 x86 LTSC2021ï¼ˆç´¢å¼•5ï¼‰
          Process-7z-Export-Image `
              -UrlCsv $env:URLS_WIN10_X86 `
              -ImageIndex $env:IMG_INDEX_WIN10_X86 `
              -VolumeName "Windows10x86LTSC2021" `
              -TargetWim $finalWim

          # 2. å¤„ç†Win10 x64 LTSC2021ï¼ˆç´¢å¼•4ï¼‰
          Process-7z-Export-Image `
              -UrlCsv $env:URLS_WIN10_X64 `
              -ImageIndex $env:IMG_INDEX_WIN10_X64 `
              -VolumeName "Windows10x64LTSC2021" `
              -TargetWim $finalWim

          # 3. å¤„ç†Win11 x64 LTSC2024ï¼ˆç´¢å¼•1ï¼‰
          Process-7z-Export-Image `
              -UrlCsv $env:URLS_WIN11_X64 `
              -ImageIndex $env:IMG_INDEX_WIN11_X64 `
              -VolumeName "Windows11x64LTSC2024" `
              -TargetWim $finalWim

          # ========== éªŒè¯æœ€ç»ˆWIM ==========
          if (-not (Test-Path $finalWim) -or (Get-Item $finalWim).Length -lt 1024) {
              throw "âŒ æœ€ç»ˆWIMæ–‡ä»¶ä¸ºç©ºæˆ–ç¼ºå¤±"
          }
          $wimSize = [math]::Round((Get-Item $finalWim).Length/1GB,2)
          Write-Host "âœ… æœ€ç»ˆWIMæ–‡ä»¶åˆ›å»ºæˆåŠŸï¼"
          Write-Host "ğŸ“„ æ–‡ä»¶è·¯å¾„: $finalWim"
          Write-Host "ğŸ“ æ–‡ä»¶å¤§å°: $wimSize GB"

          # ========== æ¸…ç†æ®‹ç•™ä¸´æ—¶æ–‡ä»¶ ==========
          $allTempDirs = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "temp_*" -Directory
          foreach ($dir in $allTempDirs) {
              Write-Host "ğŸ§¹ æ¸…ç†æ®‹ç•™ä¸´æ—¶ç›®å½•: $($dir.FullName)"
              Remove-Item -Path $dir.FullName -Recurse -Force -ErrorAction SilentlyContinue
          }

      # ä¸Šä¼ WIMåˆ°Artifactï¼ˆé˜²æˆæœä¸¢å¤±ï¼‰
      - name: æ˜¾ç¤ºWIMä¸Šä¼ ä¿¡æ¯
        shell: powershell
        run: |
          Write-Host "`nğŸ“¤ å‡†å¤‡ä¸Šä¼ WIMåˆ°Artifact..."
          $wimPath = "${{ env.TARGET_WIM }}"
          $wimSize = [math]::Round((Get-Item $wimPath).Length/1GB,2)
          Write-Host "æ–‡ä»¶è·¯å¾„: $wimPath"
          Write-Host "æ–‡ä»¶å¤§å°: $wimSize GB"
          Write-Host "Artifactåç§°: windows10-11-target-wim"

      - name: ä¸Šä¼ WIM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows10-11-target-wim
          path: ${{ env.TARGET_WIM }}
          retention-days: 90
        env:
          ACTIONS_STEP_DEBUG: true

  # Job2: è½¬æ¢WIMâ†’ESDï¼ˆä¾èµ–Job1ï¼Œå¤ç”¨WIM Artifactï¼‰
  build-esd:
    needs: build-wim
    runs-on: windows-latest
    timeout-minutes: 90
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: æ˜¾ç¤ºWIMä¸‹è½½ä¿¡æ¯
        shell: powershell
        run: |
          Write-Host "ğŸ“¥ å‡†å¤‡ä¸‹è½½WIM Artifact..."
          $wimPath = "${{ github.workspace }}\${{ env.TARGET_WIM }}"
          Write-Host "é¢„æœŸWIMè·¯å¾„: $wimPath"

      - name: ä¸‹è½½WIM Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows10-11-target-wim
          path: ${{ github.workspace }}

      - name: éªŒè¯WIMä¸‹è½½ç»“æœ
        shell: powershell
        run: |
          $wimPath = "${{ github.workspace }}\${{ env.TARGET_WIM }}"
          if (-not (Test-Path $wimPath)) { throw "âŒ WIM Artifactæœªæ‰¾åˆ°: $wimPath" }
          Write-Host "âœ… WIMä¸‹è½½æˆåŠŸ: $wimPath"

      - name: å¯ç”¨UTF8ç¼–ç 
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::UTF8
          Write-Host "âœ… UTF8ç¼–ç å·²å¯ç”¨"

      - name: è½¬æ¢WIMåˆ°ESDï¼ˆé«˜å‹ç¼©æ¯”ï¼‰
        shell: powershell
        run: |
          $finalWim = "$env:GITHUB_WORKSPACE\$env:TARGET_WIM"
          $finalEsd = "$env:GITHUB_WORKSPACE\$env:TARGET_ESD"

          # 1. è·å–WIMä¸­çš„æ˜ åƒæ•°é‡ï¼ˆå…¼å®¹ä¸­è‹±æ–‡ï¼‰
          Write-Host "ğŸ” è·å–WIMä¸­çš„æ˜ åƒæ•°é‡..."
          $env:DISM_OUTPUT_LANGUAGE = "en-US"
          $dismOutput = dism /Get-WimInfo /WimFile:$finalWim 2>&1 | Out-String
          $imgMatches = [regex]::Matches($dismOutput, '(Index|ç´¢å¼•)\s*\:\s*(\d+)')
          $imgTotal = $imgMatches.Count
          
          if ($imgTotal -eq 0) {
              Write-Host "âš ï¸ æœªæ£€æµ‹åˆ°æ˜ åƒæ•°é‡ï¼Œé»˜è®¤å¯¼å‡º1-3ä¸ªæ˜ åƒ"
              $imgTotal = 3
          }
          Write-Host "âœ… æ£€æµ‹åˆ°WIMä¸­æœ‰$imgTotalä¸ªæ˜ åƒ"

          # 2. è½¬æ¢æ‰€æœ‰æ˜ åƒåˆ°ESDï¼ˆRecoveryå‹ç¼©ï¼Œä½“ç§¯æœ€å°ï¼‰
          Write-Host "ğŸ—œï¸ è½¬æ¢WIMåˆ°ESDï¼ˆRecoveryé«˜å‹ç¼©ï¼‰..."
          for ($i=1; $i -le $imgTotal; $i++) {
              Write-Host "ğŸ“¤ å¯¼å‡ºæ˜ åƒ $i/$imgTotal åˆ°ESD..."
              dism /Export-Image `
                  /SourceImageFile:$finalWim `
                  /SourceIndex:$i `
                  /DestinationImageFile:$finalEsd `
                  /Compress:recovery `
                  /CheckIntegrity
              
              if ($LASTEXITCODE -ne 0) { throw "âŒ ESDå¯¼å‡ºå¤±è´¥ï¼ˆæ˜ åƒ$iï¼Œé”™è¯¯ç : $LASTEXITCODEï¼‰" }
              Write-Host "âœ… æ˜ åƒ$iå¯¼å‡ºå®Œæˆ"
          }

          # 3. éªŒè¯ESDæ–‡ä»¶
          if (-not (Test-Path $finalEsd) -or (Get-Item $finalEsd).Length -lt 1024) {
              throw "âŒ æœ€ç»ˆESDæ–‡ä»¶ä¸ºç©ºæˆ–ç¼ºå¤±"
          }
          $esdSize = [math]::Round((Get-Item $finalEsd).Length/1GB,2)
          Write-Host "âœ… ESDæ–‡ä»¶åˆ›å»ºæˆåŠŸï¼"
          Write-Host "ğŸ“„ æ–‡ä»¶è·¯å¾„: $finalEsd"
          Write-Host "ğŸ“ æ–‡ä»¶å¤§å°: $esdSize GB"

          # 4. åˆ é™¤æºWIMï¼ˆèŠ‚çœç©ºé—´ï¼‰
          Write-Host "ğŸ§¹ åˆ é™¤æºWIMæ–‡ä»¶..."
          Remove-Item -Path $finalWim -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… WIMæ–‡ä»¶å·²åˆ é™¤"

      # ä¸Šä¼ ESDåˆ°Artifact
      - name: æ˜¾ç¤ºESDä¸Šä¼ ä¿¡æ¯
        shell: powershell
        run: |
          Write-Host "`nğŸ“¤ å‡†å¤‡ä¸Šä¼ ESDåˆ°Artifact..."
          $esdPath = "${{ github.workspace }}\${{ env.TARGET_ESD }}"
          $esdSize = [math]::Round((Get-Item $esdPath).Length/1GB,2)
          Write-Host "æ–‡ä»¶è·¯å¾„: $esdPath"
          Write-Host "æ–‡ä»¶å¤§å°: $esdSize GB"
          Write-Host "Artifactåç§°: windows10-11-target-esd"

      - name: ä¸Šä¼ ESD Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows10-11-target-esd
          path: ${{ env.TARGET_ESD }}
          retention-days: 90

  # Job3: åˆ†å·å‹ç¼©ESDï¼ˆ1950Mï¼Œä¾èµ–Job2ï¼‰
  split-esd:
    needs: build-esd
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: æ˜¾ç¤ºESDä¸‹è½½ä¿¡æ¯
        shell: powershell
        run: |
          Write-Host "ğŸ“¥ å‡†å¤‡ä¸‹è½½ESD Artifact..."
          $esdPath = "${{ github.workspace }}\${{ env.TARGET_ESD }}"
          Write-Host "é¢„æœŸESDè·¯å¾„: $esdPath"

      - name: ä¸‹è½½ESD Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows10-11-target-esd
          path: ${{ github.workspace }}

      - name: éªŒè¯ESDä¸‹è½½ç»“æœ
        shell: powershell
        run: |
          $esdPath = "${{ github.workspace }}\${{ env.TARGET_ESD }}"
          if (-not (Test-Path $esdPath)) { throw "âŒ ESD Artifactæœªæ‰¾åˆ°: $esdPath" }
          $esdSize = [math]::Round((Get-Item $esdPath).Length/1GB,2)
          Write-Host "âœ… ESDä¸‹è½½æˆåŠŸ: $esdPath ($esdSize GB)"

      - name: å®‰è£…7-Zip
        shell: powershell
        run: |
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $7zPath)) {
              Write-Host "ğŸ”§ æ­£åœ¨å®‰è£…7-Zip..."
              choco install 7zip -y --no-progress --ignore-checksums --force
          }
          if (-not (Test-Path $7zPath)) { throw "âŒ 7-Zipå®‰è£…å¤±è´¥" }
          Write-Host "âœ… 7-Zipå®‰è£…å®Œæˆ: $7zPath"

      - name: åˆ†å·å‹ç¼©ESDï¼ˆ1950Mï¼Œç¡¬ç¼–ç é¿å…å˜é‡é”™è¯¯ï¼‰
        shell: powershell
        run: |
          $esdFile = "$env:GITHUB_WORKSPACE\$env:TARGET_ESD"
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          $splitOutput = "$esdFile.7z"

          # éªŒè¯ESDå­˜åœ¨
          if (-not (Test-Path $esdFile)) { throw "âŒ ESDæ–‡ä»¶æœªæ‰¾åˆ°: $esdFile" }

          # åˆ†å·å‹ç¼©ï¼ˆç¡¬ç¼–ç 1950Mï¼Œ100%é¿å…å˜é‡è§£æé”™è¯¯ï¼‰
          Write-Host "ğŸ—œï¸ åˆ†å·å‹ç¼©ESDåˆ°1950M..."
          Write-Host "æ‰§è¡Œå‘½ä»¤: $7zPath a -y -mx=9 -v1950M ""$splitOutput"" ""$esdFile"""
          & $7zPath a -y -mx=9 -v1950M "$splitOutput" "$esdFile"
          
          if ($LASTEXITCODE -ne 0) { throw "âŒ 7zåˆ†å·å¤±è´¥ï¼ˆé”™è¯¯ç : $LASTEXITCODEï¼‰" }

          # éªŒè¯åˆ†å·æ–‡ä»¶
          $splitFiles = Get-ChildItem -Path "$env:GITHUB_WORKSPACE" -Filter "$($env:TARGET_ESD).7z.*" | Sort-Object Name
          if ($splitFiles.Count -eq 0) { throw "âŒ æœªç”Ÿæˆåˆ†å·æ–‡ä»¶" }
          
          Write-Host "âœ… åˆ†å·å‹ç¼©å®Œæˆï¼"
          Write-Host "ğŸ“Š æ€»åˆ†å·æ•°: $($splitFiles.Count)"
          foreach ($file in $splitFiles) {
              $fileSize = [math]::Round($file.Length/1GB,2)
              Write-Host " - $($file.Name): $fileSize GB"
          }

          # åˆ é™¤æºESDï¼ˆèŠ‚çœç©ºé—´ï¼‰
          Write-Host "ğŸ§¹ åˆ é™¤æºESDæ–‡ä»¶..."
          Remove-Item -Path $esdFile -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… ESDæ–‡ä»¶å·²åˆ é™¤"

      # ä¸Šä¼ åˆ†å·æ–‡ä»¶åˆ°Artifactï¼ˆå¤‡ç”¨ï¼‰
      - name: æ˜¾ç¤ºåˆ†å·ä¸Šä¼ ä¿¡æ¯
        shell: powershell
        run: |
          Write-Host "`nğŸ“¤ å‡†å¤‡ä¸Šä¼ åˆ†å·æ–‡ä»¶åˆ°Artifact..."
          $splitFiles = Get-ChildItem -Path "${{ github.workspace }}" -Filter "${{ env.TARGET_ESD }}.7z.*"
          Write-Host "âœ… å¾…ä¸Šä¼ åˆ†å·æ•°: $($splitFiles.Count)"

      - name: ä¸Šä¼ åˆ†å·Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows10-11-split-volumes
          path: ${{ github.workspace }}/${{ env.TARGET_ESD }}.7z.*
          retention-days: 90

  # Job4: å‘å¸ƒåˆ°GitHub Releasesï¼ˆä¾èµ–Job3ï¼‰
  publish-release:
    needs: split-esd
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: æ˜¾ç¤ºåˆ†å·ä¸‹è½½ä¿¡æ¯
        shell: powershell
        run: |
          Write-Host "ğŸ“¥ å‡†å¤‡ä¸‹è½½åˆ†å·æ–‡ä»¶..."
          $splitPattern = "${{ env.TARGET_ESD }}.7z.*"
          Write-Host "é¢„æœŸåˆ†å·æ ¼å¼: $splitPattern"

      - name: ä¸‹è½½åˆ†å·Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows10-11-split-volumes
          path: ${{ github.workspace }}

      - name: éªŒè¯åˆ†å·æ–‡ä»¶
        shell: powershell
        run: |
          $splitFiles = Get-ChildItem -Path "${{ github.workspace }}" -Filter "${{ env.TARGET_ESD }}.7z.*"
          if ($splitFiles.Count -eq 0) { throw "âŒ åˆ†å·æ–‡ä»¶æœªæ‰¾åˆ°" }
          Write-Host "âœ… åˆ†å·æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œæ•°é‡: $($splitFiles.Count)"

      - name: å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          files: ${{ github.workspace }}/${{ env.TARGET_ESD }}.7z.*
          draft: false
          prerelease: false
          body: |
            # Windows10_LTSC2021_32&64 + Windows11_LTSC2024
            - ESDæ–‡ä»¶åˆ†å·ä¸º1950Mï¼Œä¾¿äºä¼ è¾“
            - åŒ…å«æ˜ åƒï¼š
              - Windows10x86LTSC2021ï¼ˆç´¢å¼•5ï¼‰
              - Windows10x64LTSC2021ï¼ˆç´¢å¼•4ï¼‰
              - Windows11x64LTSC2024ï¼ˆç´¢å¼•1ï¼‰
            - å‹ç¼©æ ¼å¼ï¼šRecoveryï¼ˆæœ€é«˜å‹ç¼©æ¯”ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æœ€ç»ˆæ¸…ç†
      - name: æœ€ç»ˆæ¸…ç†
        if: always()
        shell: powershell
        run: |
          Write-Host "ğŸ§¹ æ‰§è¡Œæœ€ç»ˆæ¸…ç†..."
          $tempDirs = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "temp_*" -Directory
          foreach ($dir in $tempDirs) {
              Remove-Item -Path $dir.FullName -Recurse -Force -ErrorAction SilentlyContinue
          }
          Write-Host "âœ… æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆï¼"
          Write-Host "ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
