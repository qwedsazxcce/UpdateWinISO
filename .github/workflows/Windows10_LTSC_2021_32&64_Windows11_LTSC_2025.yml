name: Windows10_LTSC_2021_32&64_Windows11_LTSC_2025
on:
  push:
    branches: ["main"]
    paths:
      - '.github/workflows/Windows10_LTSC_2021_32&64_Windows11_LTSC_2025.yml'

jobs:
  build-and-upload-esd:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      # Windows 10/11 LTSC 下载链接配置
      Windows10_LTSC2021_x86_001: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001
      Windows10_LTSC2021_x86_002: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002
      Windows10_LTSC2021_x86_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/Misc/test.txt
      Windows10_LTSC2021_amd64_001: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001
      Windows10_LTSC2021_amd64_002: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002
      Windows10_LTSC2021_amd64_003: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003
      Windows11_LTSC2024_amd64_001: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001
      Windows11_LTSC2024_amd64_002: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002
      Windows11_LTSC2024_amd64_003: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003
      # 核心配置
      WORK_DIR: ${{ github.workspace }}
      ESD_MAIN_FILE: Windows10_LTSC_2021_32&64_Windows11_LTSC_2025.esd
      SPLIT_SIZE: 1950M
      RETRY_COUNT: 10
      RETRY_INTERVAL: 30
      RELEASE_NAME: Windows10_LTSC_2021_32&64_Windows11_LTSC_2025

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delete existing Release and Tag (with full log)
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          $releaseName = $env:RELEASE_NAME
          Write-Host "===== 开始清理旧版本：$releaseName ====="
          
          # 列出当前所有Release/Tag（便于排查）
          Write-Host "当前仓库的Release列表："
          $releaseList = gh release list 2>&1
          if ($LASTEXITCODE -eq 0) { Write-Host $releaseList } else { Write-Host "暂无Release" }
          
          Write-Host "当前本地Tag列表："
          $localTags = git tag --list
          if ($localTags) { Write-Host $localTags } else { Write-Host "暂无本地Tag" }
          
          Write-Host "当前远程Tag列表（筛选$releaseName）："
          $remoteTags = git ls-remote --tags origin | FindStr $releaseName 2>&1
          if ($remoteTags) { Write-Host $remoteTags } else { Write-Host "暂无远程Tag: $releaseName" }

          # 删除Release（包括Draft）
          Write-Host "`n[1/3] 删除Release..."
          $releaseExists = gh release view "$releaseName" 2>&1
          if ($LASTEXITCODE -eq 0) {
            gh release delete "$releaseName" -y
            Write-Host "[成功] Release '$releaseName' 已删除"
          } else {
            Write-Host "[信息] Release '$releaseName' 不存在，跳过删除"
          }

          # 删除远程Tag
          Write-Host "`n[2/3] 删除远程Tag..."
          $tagRef = "refs/tags/$releaseName"
          $remoteTagExists = git ls-remote --tags origin "$tagRef" 2>&1
          if ($remoteTagExists) {
            git push origin --delete "$tagRef"
            Write-Host "[成功] 远程Tag '$releaseName' 已删除"
          } else {
            Write-Host "[信息] 远程Tag '$releaseName' 不存在，跳过删除"
          }

          # 删除本地Tag
          Write-Host "`n[3/3] 删除本地Tag..."
          if (git tag --list "$releaseName") {
            git tag -d "$releaseName"
            Write-Host "[成功] 本地Tag '$releaseName' 已删除"
          } else {
            Write-Host "[信息] 本地Tag '$releaseName' 不存在，跳过删除"
          }

          Write-Host "`n===== 清理旧版本完成 =====`n"

      - name: Process each Windows version
        shell: pwsh
        run: |
          # 定义版本列表：Prefix=变量前缀, IsAppend=是否追加到主ESD
          $versions = @(
            @{ Prefix = "Windows10_LTSC2021_x86"; IsAppend = $false },
            @{ Prefix = "Windows10_LTSC2021_amd64"; IsAppend = $true },
            @{ Prefix = "Windows11_LTSC2024_amd64"; IsAppend = $true }
          )
          
          $mainEsdPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:ESD_MAIN_FILE
          $isFirstVersion = $true

          foreach ($version in $versions) {
            $prefix = $version.Prefix
            $isAppend = $version.IsAppend
            Write-Host "===== 开始处理版本：$prefix ====="

            # 1. 下载7z分卷（带重试）
            Write-Host "下载 $prefix 分卷"
            $volumes = @("001", "002", "003")
            foreach ($vol in $volumes) {
              $varName = "$prefix`_$vol"
              $url = [Environment]::GetEnvironmentVariable($varName)
              if (-not $url) {
                Write-Warning "变量 $varName 未定义，跳过该分卷"
                continue
              }
              $fileName = "$prefix.7z.$vol"
              $filePath = Join-Path -Path $env:WORK_DIR -ChildPath $fileName
              
              # 下载重试逻辑（最多5次）
              $downloadSuccess = $false
              for ($i=1; $i -le 5; $i++) {
                curl.exe -L -o "$filePath" "$url"
                if ($LASTEXITCODE -eq 0) {
                  $downloadSuccess = $true
                  break
                }
                Write-Warning "第$i次下载失败，10秒后重试..."
                Start-Sleep -Seconds 10
              }
              if (-not $downloadSuccess) {
                throw "下载 $fileName 失败，curl退出码：$LASTEXITCODE"
              }
              
              # 验证文件非空
              $fileSize = (Get-Item "$filePath").Length
              if ($fileSize -eq 0) {
                throw "$fileName 下载后为空文件"
              }
              Write-Host "$fileName 下载成功（大小：$([math]::Round($fileSize/1MB,2)) MB）"
            }

            # 2. 创建解压目录
            Write-Host "创建解压目录"
            $extractDir = Join-Path -Path $env:WORK_DIR -ChildPath "extract_$prefix"
            if (Test-Path $extractDir) {
              Remove-Item -Path $extractDir -Recurse -Force
            }
            New-Item -ItemType Directory -Path $extractDir -Force | Out-Null
            Write-Host "解压目录：$extractDir"

            # 3. 解压7z分卷
            Write-Host "开始解压 $prefix 分卷"
            $firstVol = Join-Path -Path $env:WORK_DIR -ChildPath "$prefix.7z.001"
            7z x -y -bb1 -o"$extractDir" "$firstVol"
            if ($LASTEXITCODE -ge 2) {
              throw "解压 $prefix 失败，7z退出码：$LASTEXITCODE"
            }

            # 4. 查找ISO文件
            Write-Host "查找ISO文件"
            $isoFiles = Get-ChildItem -Path $extractDir -Filter "*.iso" -Recurse
            if ($isoFiles.Count -eq 0) {
              throw "在 $extractDir 中未找到ISO文件"
            }
            $isoPath = $isoFiles[0].FullName
            Write-Host "找到ISO文件：$isoPath"

            # 5. 从ISO提取install.esd（核心修正：7z e 无视目录结构）
            Write-Host "从ISO提取install.esd（无视目录结构）"
            $esdExtractPath = Join-Path -Path $extractDir -ChildPath "esd_temp"
            New-Item -ItemType Directory -Path $esdExtractPath -Force | Out-Null
            
            # 关键修正：7z e 替代 7z x，直接提取到目标目录根，不保留sources子目录
            7z e -y -bb1 -o"$esdExtractPath" "$isoPath" "sources/install.esd"
            if ($LASTEXITCODE -ge 2) {
              throw "从ISO提取install.esd失败，7z退出码：$LASTEXITCODE"
            }
            
            # 修正后路径：直接在esd_temp根目录，无sources子目录
            $tempEsdPath = Join-Path -Path $esdExtractPath -ChildPath "install.esd"
            if (-not (Test-Path $tempEsdPath)) {
              throw "未从ISO中提取到install.esd，路径：$tempEsdPath"
            }
            Write-Host "成功提取install.esd：$tempEsdPath"

            # 6. 处理主ESD文件（创建/追加）
            Write-Host "处理主ESD文件（IsAppend=$isAppend, IsFirst=$isFirstVersion）"
            if ($isFirstVersion -and -not $isAppend) {
              # 第一个版本（Win10 x86）直接作为主ESD
              Copy-Item -Path $tempEsdPath -Destination $mainEsdPath -Force
              Write-Host "已将 $prefix 的install.esd设为主ESD文件"
              $isFirstVersion = $false
            } elseif ($isAppend) {
              # Win10 x64/Win11 x64：提取第一索引转WIM后追加到主ESD
              $tempWimPath = Join-Path -Path $extractDir -ChildPath "temp_install.wim"
              
              # 6.1 ESD转WIM（提取第一索引）
              $dismExportCmd = "dism /export-image /sourceimagefile:`"$tempEsdPath`" /sourceindex:1 /destinationimagefile:`"$tempWimPath`" /compress:fast"
              cmd /c $dismExportCmd
              if ($LASTEXITCODE -ne 0) {
                throw "DISM提取ESD索引失败，退出码：$LASTEXITCODE"
              }
              Write-Host "成功提取ESD第一索引到临时WIM：$tempWimPath"

              # 6.2 WIM追加到主ESD
              $dismAppendCmd = "dism /export-image /sourceimagefile:`"$tempWimPath`" /sourceindex:1 /destinationimagefile:`"$mainEsdPath`" /compress:recovery /checkintegrity"
              cmd /c $dismAppendCmd
              if ($LASTEXITCODE -ne 0) {
                throw "DISM追加到主ESD失败，退出码：$LASTEXITCODE"
              }
              Write-Host "成功将 $prefix 追加到主ESD文件"

              # 删除临时WIM
              Remove-Item -Path $tempWimPath -Force -ErrorAction SilentlyContinue
            }

            # 7. 清理当前版本临时文件
            Write-Host "清理 $prefix 临时文件"
            # 删除7z分卷
            foreach ($vol in $volumes) {
              $fileName = "$prefix.7z.$vol"
              $filePath = Join-Path -Path $env:WORK_DIR -ChildPath $fileName
              if (Test-Path $filePath) {
                Remove-Item -Path $filePath -Force
              }
            }
            # 删除解压目录
            if (Test-Path $extractDir) {
              Remove-Item -Path $extractDir -Recurse -Force
            }

            Write-Host "===== 完成处理版本：$prefix ====="
          }

          # 最终验证主ESD文件
          if (-not (Test-Path $mainEsdPath) -or (Get-Item $mainEsdPath).Length -eq 0) {
            throw "主ESD文件创建失败，路径：$mainEsdPath"
          }
          Write-Host "主ESD文件创建成功，大小：$([math]::Round((Get-Item $mainEsdPath).Length/1GB,2)) GB"

      - name: Split compress ESD file
        shell: pwsh
        run: |
          Write-Host "分卷压缩 ESD 文件（单卷大小：$env:SPLIT_SIZE）"
          $esdPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:ESD_MAIN_FILE
          $splitOutput = Join-Path -Path $env:WORK_DIR -ChildPath "$($env:ESD_MAIN_FILE).7z"
          $volParam = "-v$($env:SPLIT_SIZE)"
          
          # 7z分卷压缩
          7z a -y $volParam "$splitOutput" "$esdPath"
          if ($LASTEXITCODE -ge 2) {
            throw "7z分卷压缩失败，退出码：$LASTEXITCODE"
          }
          
          # 删除原ESD节省空间
          Remove-Item -Path $esdPath -Force
          Write-Host "分卷压缩完成，生成文件数：$(Get-ChildItem "$splitOutput.*" | Measure-Object).Count 个"

      - name: Upload via GitHub CLI with retry
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          $releaseName = $env:RELEASE_NAME
          $splitFiles = Get-ChildItem -LiteralPath "$env:WORK_DIR" -Filter "$($env:ESD_MAIN_FILE).7z.*" -ErrorAction Stop
          $retryCount = [int]$env:RETRY_COUNT
          $retryInterval = [int]$env:RETRY_INTERVAL

          if ($splitFiles.Count -eq 0) {
            throw "未找到分卷压缩文件！路径：$env:WORK_DIR\$($env:ESD_MAIN_FILE).7z.*"
          }

          # 上传重试逻辑
          $uploadSuccess = $false
          for ($i=1; $i -le $retryCount; $i++) {
            try {
              Write-Host "第 $i 次上传（共 $retryCount 次），文件数：$($splitFiles.Count)"
              gh release create "$releaseName" `
                --title "$releaseName" `
                --notes "Auto-built Windows 10 LTSC 2021 (32/64) + Windows 11 LTSC 2025 (64) ESD" `
                --latest `
                $splitFiles.FullName
              $uploadSuccess = $true
              Write-Host "上传成功"
              break
            }
            catch {
              Write-Warning "第 $i 次上传失败：$($_.Exception.Message)"
              if ($i -lt $retryCount) {
                Write-Host "等待 $retryInterval 秒后重试..."
                Start-Sleep -Seconds $retryInterval
              }
            }
          }

          if (-not $uploadSuccess) {
            throw "重试 $retryCount 次后仍上传失败"
          }

      - name: Final cleanup
        shell: pwsh
        if: always()
        run: |
          Write-Host "执行最终清理"
          # 删除所有解压残留目录
          Get-ChildItem -Path $env:WORK_DIR -Filter "extract_*" -Directory | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          # 删除7z分卷残留
          Get-ChildItem -Path $env:WORK_DIR -Filter "Windows*.7z.00*" | Remove-Item -Force -ErrorAction SilentlyContinue
          Write-Host "清理完成"
