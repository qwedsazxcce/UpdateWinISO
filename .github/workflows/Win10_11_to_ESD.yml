name: Windows_10-11_ESD

on:
  workflow_dispatch:
  schedule:
    # 设置定期运行（可选）
    - cron: '0 0 1 * *'

env:
  # 下载地址环境变量 - 便于以后替换
  WIN10_X86_URL_1: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001
  WIN10_X86_URL_2: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002
  
  WIN10_X64_URL_1: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001
  WIN10_X64_URL_2: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002
  WIN10_X64_URL_3: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003
  
  WIN11_X64_URL_1: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001
  WIN11_X64_URL_2: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002
  WIN11_X64_URL_3: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003
  
  OUTPUT_WIM_NAME: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim
  OUTPUT_ESD_NAME: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd
  PART_SIZE: 1950M

jobs:
  merge-images:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup 7-Zip
      run: |
        # 7-Zip should be available on GitHub Actions Windows runners
        Write-Output "Checking for 7-Zip..."
        if (Get-Command 7z -ErrorAction SilentlyContinue) {
          Write-Output "7-Zip found"
          & 7z
        } else {
          Write-Output "Installing 7-Zip..."
          choco install 7zip
        }

    - name: Setup DISM tools
      run: |
        Write-Output "DISM tools should be available on Windows runners"
        dism /?
        
    - name: Create working directory
      run: |
        New-Item -ItemType Directory -Force -Path "$env:TEMP\merge_process"
        Set-Location "$env:TEMP\merge_process"
        Write-Output "Working directory: $(Get-Location)"

    # Process Win10 x86 LTSC 2021
    - name: Download Win10 x86 7z parts
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Downloading Win10 x86 7z parts..."
        
        # Download first part
        Write-Output "Downloading part 1..."
        curl -L -o "Windows10_LTSC2021_x86-19044.6811.7z.001" "$env:WIN10_X86_URL_1"
        
        # Download second part
        Write-Output "Downloading part 2..."
        curl -L -o "Windows10_LTSC2021_x86-19044.6811.7z.002" "$env:WIN10_X86_URL_2"
        
        Write-Output "Download completed for Win10 x86"

    - name: Extract Win10 x86 ISO and process
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Extracting Win10 x86 archive..."
        & 7z x "Windows10_LTSC2021_x86-19044.6811.7z.001" -o"x86_extract"
        
        # Find the ISO file
        $isoFile = Get-ChildItem -Path "x86_extract" -Filter "*.iso" | Select-Object -First 1
        if ($null -eq $isoFile) {
            throw "ISO file not found in x86 extraction"
        }
        
        Write-Output "Found ISO: $($isoFile.FullName)"
        
        # Mount ISO to extract install.esd
        $mountResult = Mount-DiskImage -ImagePath $isoFile.FullName -PassThru
        $driveLetter = ($mountResult | Get-Volume).DriveLetter
        
        # Copy sources\install.esd to working directory
        $sourceEsd = "${driveLetter}:\sources\install.esd"
        if (Test-Path $sourceEsd) {
            Write-Output "Copying install.esd from ISO..."
            Copy-Item $sourceEsd -Destination "x86_install.esd"
            
            # Export first image from x86 install.esd to WIM (this creates the file)
            Write-Output "Exporting first image from x86 install.esd..."
            dism /Export-Image /SourceImageFile:"x86_install.esd" /SourceIndex:1 /DestinationImageFile:"$env:OUTPUT_WIM_NAME" /Compress:fast /CheckIntegrity
                            
            Write-Output "Successfully exported first image from x86 install.esd"
        } else {
            throw "install.esd not found in ISO sources folder"
        }
        
        # Dismount ISO
        Dismount-DiskImage -ImagePath $isoFile.FullName
        
        # Clean up temporary files
        Write-Output "Cleaning up Win10 x86 temporary files..."
        Remove-Item "Windows10_LTSC2021_x86-19044.6811.7z.001" -Force
        Remove-Item "Windows10_LTSC2021_x86-19044.6811.7z.002" -Force
        Remove-Item $isoFile.FullName -Force
        Remove-Item "x86_install.esd" -Force
        Remove-Item "x86_extract" -Recurse -Force

    # Process Win10 x64 LTSC 2021
    - name: Download Win10 x64 7z parts
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Downloading Win10 x64 7z parts..."
        
        # Download first part
        Write-Output "Downloading part 1..."
        curl -L -o "Windows10_LTSC2021_amd64-19044.6811.7z.001" "$env:WIN10_X64_URL_1"
        
        # Download second part
        Write-Output "Downloading part 2..."
        curl -L -o "Windows10_LTSC2021_amd64-19044.6811.7z.002" "$env:WIN10_X64_URL_2"
        
        # Download third part
        Write-Output "Downloading part 3..."
        curl -L -o "Windows10_LTSC2021_amd64-19044.6811.7z.003" "$env:WIN10_X64_URL_3"
        
        Write-Output "Download completed for Win10 x64"

    - name: Extract Win10 x64 ISO and process
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Extracting Win10 x64 archive..."
        & 7z x "Windows10_LTSC2021_amd64-19044.6811.7z.001" -o"x64_extract"
        
        # Find the ISO file
        $isoFile = Get-ChildItem -Path "x64_extract" -Filter "*.iso" | Select-Object -First 1
        if ($null -eq $isoFile) {
            throw "ISO file not found in x64 extraction"
        }
        
        Write-Output "Found ISO: $($isoFile.FullName)"
        
        # Mount ISO to extract install.esd
        $mountResult = Mount-DiskImage -ImagePath $isoFile.FullName -PassThru
        $driveLetter = ($mountResult | Get-Volume).DriveLetter
        
        # Copy sources\install.esd to working directory
        $sourceEsd = "${driveLetter}:\sources\install.esd"
        if (Test-Path $sourceEsd) {
            Write-Output "Copying install.esd from ISO..."
            Copy-Item $sourceEsd -Destination "x64_install.esd"
            
            # Export first image from x64 install.esd and append to existing WIM
            Write-Output "Exporting first image from x64 install.esd and appending to existing WIM..."
            dism /Export-Image /SourceImageFile:"x64_install.esd" /SourceIndex:1 /DestinationImageFile:"$env:OUTPUT_WIM_NAME" /Compress:fast /CheckIntegrity
                    
            Write-Output "Successfully exported and appended first image from x64 install.esd"
        } else {
            throw "install.esd not found in ISO sources folder"
        }
        
        # Dismount ISO
        Dismount-DiskImage -ImagePath $isoFile.FullName
        
        # Clean up temporary files
        Write-Output "Cleaning up Win10 x64 temporary files..."
        Remove-Item "Windows10_LTSC2021_amd64-19044.6811.7z.001" -Force
        Remove-Item "Windows10_LTSC2021_amd64-19044.6811.7z.002" -Force
        Remove-Item "Windows10_LTSC2021_amd64-19044.6811.7z.003" -Force
        Remove-Item $isoFile.FullName -Force
        Remove-Item "x64_install.esd" -Force
        Remove-Item "x64_extract" -Recurse -Force

    # Process Win11 x64 LTSC 2024
    - name: Download Win11 x64 7z parts
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Downloading Win11 x64 7z parts..."
        
        # Download first part
        Write-Output "Downloading part 1..."
        curl -L -o "Windows11_LTSC2024_amd64-26200.7627.7z.001" "$env:WIN11_X64_URL_1"
        
        # Download second part
        Write-Output "Downloading part 2..."
        curl -L -o "Windows11_LTSC2024_amd64-26200.7627.7z.002" "$env:WIN11_X64_URL_2"
        
        # Download third part
        Write-Output "Downloading part 3..."
        curl -L -o "Windows11_LTSC2024_amd64-26200.7627.7z.003" "$env:WIN11_X64_URL_3"
        
        Write-Output "Download completed for Win11 x64"

    - name: Extract Win11 x64 ISO and process
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Extracting Win11 x64 archive..."
        & 7z x "Windows11_LTSC2024_amd64-26200.7627.7z.001" -o"win11_extract"
        
        # Find the ISO file
        $isoFile = Get-ChildItem -Path "win11_extract" -Filter "*.iso" | Select-Object -First 1
        if ($null -eq $isoFile) {
            throw "ISO file not found in Win11 extraction"
        }
        
        Write-Output "Found ISO: $($isoFile.FullName)"
        
        # Mount ISO to extract install.esd
        $mountResult = Mount-DiskImage -ImagePath $isoFile.FullName -PassThru
        $driveLetter = ($mountResult | Get-Volume).DriveLetter
        
        # Copy sources\install.esd to working directory
        $sourceEsd = "${driveLetter}:\sources\install.esd"
        if (Test-Path $sourceEsd) {
            Write-Output "Copying install.esd from ISO..."
            Copy-Item $sourceEsd -Destination "win11_install.esd"
            
            # Export first image from Win11 install.esd and append to existing WIM
            Write-Output "Exporting first image from Win11 install.esd and appending to existing WIM..."
            dism /Export-Image /SourceImageFile:"win11_install.esd" /SourceIndex:1 /DestinationImageFile:"$env:OUTPUT_WIM_NAME" /Compress:fast /CheckIntegrity
                    
            Write-Output "Successfully exported and appended first image from Win11 install.esd"
        } else {
            throw "install.esd not found in ISO sources folder"
        }
        
        # Dismount ISO
        Dismount-DiskImage -ImagePath $isoFile.FullName
        
        # Clean up temporary files
        Write-Output "Cleaning up Win11 x64 temporary files..."
        Remove-Item "Windows11_LTSC2024_amd64-26200.7627.7z.001" -Force
        Remove-Item "Windows11_LTSC2024_amd64-26200.7627.7z.002" -Force
        Remove-Item "Windows11_LTSC2024_amd64-26200.7627.7z.003" -Force
        Remove-Item $isoFile.FullName -Force
        Remove-Item "win11_install.esd" -Force
        Remove-Item "win11_extract" -Recurse -Force

    # Convert WIM to ESD
    - name: Convert WIM to ESD with high compression
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Converting WIM to ESD with high compression..."
        
        # Get image information from the WIM file
        $imageInfo = dism /Get-ImageInfo /ImageFile:"$env:OUTPUT_WIM_NAME"
        $imageCount = 0
        foreach ($line in $imageInfo) {
          if ($line -match "Image Count:") {
            $imageCount = [int]($line -split ":")[1].Trim()
            break
          }
        }
        
        Write-Output "Found $imageCount images in WIM file, processing all..."
        
        # Process each image and export to ESD with maximum compression
        for ($i = 1; $i -le $imageCount; $i++) {
          if ($i -eq 1) {
            # For the first image, create the ESD file
            Write-Output "Processing image $i/$imageCount..."
            dism /Export-Image /SourceImageFile:"$env:OUTPUT_WIM_NAME" /SourceIndex:$i /DestinationImageFile:"$env:OUTPUT_ESD_NAME" /Compress:max /CheckIntegrity
          } else {
            # For subsequent images, append to the existing ESD
            Write-Output "Processing image $i/$imageCount..."
            dism /Export-Image /SourceImageFile:"$env:OUTPUT_WIM_NAME" /SourceIndex:$i /DestinationImageFile:"$env:OUTPUT_ESD_NAME" /Compress:max /CheckIntegrity
          }
        }
        
        Write-Output "Successfully converted WIM to ESD with high compression"

    # Verify generated ESD file
    - name: Verify ESD file
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        if (Test-Path "$env:OUTPUT_ESD_NAME") {
          $esdSize = (Get-Item "$env:OUTPUT_ESD_NAME").Length
          $esdSizeMB = [math]::Round($esdSize / 1MB, 2)
          Write-Output "ESD file created successfully. Size: $esdSizeMB MB"
          
          # Show image information
          dism /Get-ImageInfo /ImageFile:"$env:OUTPUT_ESD_NAME"
        } else {
          throw "ESD file was not created"
        }

    # Split archive to 1950M parts
    - name: Split ESD file to 1950M parts
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Splitting ESD file to ${env:PART_SIZE} parts..."
        
        # Use 7z to split the ESD file
        & 7z a -v${env:PART_SIZE} -m0=lzma2 -mx=9 -ms=on "$env:OUTPUT_ESD_NAME.part" "$env:OUTPUT_ESD_NAME"
        
        Write-Output "Successfully split ESD file to ${env:PART_SIZE} parts"

    # Cleanup original unsplit ESD file
    - name: Cleanup original ESD file
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Removing original ESD file after splitting..."
        Remove-Item "$env:OUTPUT_ESD_NAME" -Force
        
        Write-Output "Original ESD file removed. Keeping only split parts."

    # Display final file list
    - name: List final files
      run: |
        Set-Location "$env:TEMP\merge_process"
        
        Write-Output "Final files:"
        Get-ChildItem -Path . -Filter "$env:OUTPUT_ESD_NAME.part*" | ForEach-Object {
          $sizeMB = [math]::Round($_.Length / 1MB, 2)
          Write-Output "$($_.Name) - Size: $sizeMB MB"
        }

    # Upload to GitHub Releases
    - name: Upload to GitHub Releases
      uses: softprops/action-gh-release@v2
      with:
        name: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025
        tag_name: v1.0.0
        draft: false
        prerelease: false
        files: |
          ${{ env.TEMP }}\merge_process\${{ env.OUTPUT_ESD_NAME }}.part*
        token: ${{ secrets.GITHUB_TOKEN }}
