name: Windows_LTSC_ESD (Resumable)

on:
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  LC_ALL: C.UTF-8
  LANG: C.UTF-8
  DOWNLOAD_URLS_1: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002
  DOWNLOAD_URLS_2: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003
  DOWNLOAD_URLS_3: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003
  TARGET_WIM: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim
  TARGET_ESD: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd

# 拆分成4个独立Job，按顺序执行，每个Job的成果上传Artifact
jobs:
  # Job1：下载+解压+生成WIM（耗时最长，优先保留）
  build-wim:
    runs-on: windows-latest
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Force UTF8
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.UTF8Encoding]::UTF8
          $PSDefaultParameterValues['*:Encoding'] = 'utf8'

      - name: Install 7-Zip
        shell: powershell
        run: |
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $7zPath)) {
              choco install 7zip -y --no-progress --ignore-checksums --force
          }
          $env:PATH += ";C:\Program Files\7-Zip"

      - name: Build WIM File
        shell: powershell
        run: |
          # 核心函数（生成WIM）
          function Process-7z-ISO {
              param([string]$UrlCsv, [string]$TargetWim)
              $urls = $UrlCsv -split ',' | ForEach-Object { $_.Trim() } | Where-Object { $_ }
              $tempDir = New-Item -Path "$env:GITHUB_WORKSPACE\temp" -ItemType Directory -Force
              $dlDir = New-Item -Path "$tempDir\downloads" -ItemType Directory -Force
              $extractDir = New-Item -Path "$tempDir\extract" -ItemType Directory -Force

              try {
                  # 下载分卷
                  foreach ($url in $urls) {
                      $fileName = [System.IO.Path]::GetFileName($url)
                      $savePath = "$dlDir\$fileName"
                      curl.exe --progress-bar -L -f -o "$savePath" "$url"
                      if (-not (Test-Path $savePath) -or (Get-Item $savePath).Length -lt 1024) {
                          throw "Download failed: $fileName"
                      }
                  }

                  # 解压7z
                  $7z001 = Get-ChildItem -Path $dlDir -Filter "*.7z.001" | Select-Object -First 1
                  & "C:\Program Files\7-Zip\7z.exe" x -y -o"$extractDir" "$7z001.FullName"
                  if ($LASTEXITCODE -ne 0) { throw "7z extract failed" }

                  # 提取ESD
                  $isoFile = Get-ChildItem -Path $extractDir -Filter "*.iso" -Recurse | Select-Object -First 1
                  $isoExtractDir = New-Item -Path "$tempDir\iso_extract" -ItemType Directory -Force
                  & "C:\Program Files\7-Zip\7z.exe" x -y -o"$isoExtractDir" "$isoFile.FullName" "sources\install.esd"
                  $esdFile = "$isoExtractDir\sources\install.esd"

                  # 导出WIM
                  if (-not (Test-Path $TargetWim)) {
                      dism /Export-Image /SourceImageFile:"$esdFile" /SourceIndex:1 /DestinationImageFile:"$TargetWim" /Compress:max /CheckIntegrity
                  } else {
                      dism /Export-Image /SourceImageFile:"$esdFile" /SourceIndex:1 /DestinationImageFile:"$TargetWim" /Compress:max /CheckIntegrity
                  }
                  if ($LASTEXITCODE -ne 0) { throw "DISM export failed" }

              } finally {
                  Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
              }
          }

          # 生成WIM
          $finalWim = "$env:GITHUB_WORKSPACE\$env:TARGET_WIM"
          Process-7z-ISO -UrlCsv $env:DOWNLOAD_URLS_1 -TargetWim $finalWim
          Process-7z-ISO -UrlCsv $env:DOWNLOAD_URLS_2 -TargetWim $finalWim
          Process-7z-ISO -UrlCsv $env:DOWNLOAD_URLS_3 -TargetWim $finalWim

          # 验证WIM
          Write-Host "WIM Size: $([math]::Round((Get-Item $finalWim).Length/1GB,2)) GB"

      # 关键：上传WIM到Artifact，保留成果
      - name: Upload WIM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-ltsc-wim-file
          path: ${{ env.TARGET_WIM }}
          retention-days: 90  # 保留90天

  # Job2：转换WIM到ESD（依赖Job1的WIM文件）
  build-esd:
    needs: build-wim  # 只在Job1成功后执行
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 下载Job1上传的WIM文件（复用成果，不用重新生成）
      - name: Download WIM Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-ltsc-wim-file
          path: ${{ github.workspace }}

      - name: Force UTF8
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::UTF8

      - name: Convert WIM to ESD
        shell: powershell
        run: |
          $finalWim = "$env:GITHUB_WORKSPACE\$env:TARGET_WIM"
          $esdFile = "$env:GITHUB_WORKSPACE\$env:TARGET_ESD"

          # 统计WIM映像数量
          $dismOutput = dism /Get-WimInfo /WimFile:$finalWim 2>&1 | Out-String
          $imgMatches = [regex]::Matches($dismOutput, '(Index|索引)\s*\:\s*(\d+)')
          $imgTotal = $imgMatches.Count
          if ($imgTotal -eq 0) { $imgTotal = 1 }

          # 转换ESD
          for ($i=1; $i -le $imgTotal; $i++) {
              dism /Export-Image /SourceImageFile:$finalWim /SourceIndex:$i /DestinationImageFile:$esdFile /Compress:recovery /CheckIntegrity
              if ($LASTEXITCODE -ne 0) { throw "ESD export failed (image $i)" }
          }

          # 验证ESD
          Write-Host "ESD Size: $([math]::Round((Get-Item $esdFile).Length/1GB,2)) GB"

      # 上传ESD到Artifact
      - name: Upload ESD Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-ltsc-esd-file
          path: ${{ env.TARGET_ESD }}
          retention-days: 90

  # Job3：分卷压缩ESD（依赖Job2的ESD文件）
  split-esd:
    needs: build-esd  # 只在Job2成功后执行
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 下载Job2上传的ESD文件
      - name: Download ESD Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-ltsc-esd-file
          path: ${{ github.workspace }}

      - name: Install 7-Zip
        shell: powershell
        run: |
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $7zPath)) {
              choco install 7zip -y --no-progress --ignore-checksums --force
          }

      # 分卷压缩（硬编码1950M，100%成功）
      - name: Split ESD to 1950M Volumes
        shell: powershell
        run: |
          $esdFile = "$env:GITHUB_WORKSPACE\$env:TARGET_ESD"
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          
          # 核心：直接用-v1950M，无变量解析问题
          & $7zPath a -y -mx=9 -v1950M "$esdFile.7z" "$esdFile"
          if ($LASTEXITCODE -ne 0) { throw "7z split failed" }

          # 验证分卷
          $splitFiles = Get-ChildItem -Path "$env:GITHUB_WORKSPACE" -Filter "$($env:TARGET_ESD).7z.*"
          Write-Host "Split success: $($splitFiles.Count) volumes"

      # 上传分卷文件到Artifact（备用）
      - name: Upload Split Volumes
        uses: actions/upload-artifact@v4
        with:
          name: windows-ltsc-split-volumes
          path: ${{ github.workspace }}/${{ env.TARGET_ESD }}.7z.*
          retention-days: 90

  # Job4：发布到Releases（依赖Job3的分卷文件）
  publish-release:
    needs: split-esd  # 只在Job3成功后执行
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 下载分卷文件
      - name: Download Split Volumes
        uses: actions/download-artifact@v4
        with:
          name: windows-ltsc-split-volumes
          path: ${{ github.workspace }}

      # 发布到Releases
      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TARGET_WIM }}
          name: ${{ env.TARGET_WIM }}
          files: ${{ github.workspace }}/${{ env.TARGET_ESD }}.7z.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
