name: Windows_10-11_ESD

on:
  workflow_dispatch: # 手动触发，也可根据需要添加push/tag触发

env:
  # ========== 下载地址（方便后续替换） ==========
  # Win10 LTSC2021 x86 分卷
  WIN10_X86_001_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001"
  WIN10_X86_002_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002"
  
  # Win10 LTSC2021 x64 分卷
  WIN10_X64_001_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001"
  WIN10_X64_002_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002"
  WIN10_X64_003_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003"
  
  # Win11 LTSC2024 x64 分卷
  WIN11_X64_001_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001"
  WIN11_X64_002_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002"
  WIN11_X64_003_URL: "https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003"
  
  # 核心文件名（固定）
  TARGET_WIM_NAME: "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim"
  TARGET_ESD_NAME: "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd"
  RELEASE_TAG: "Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025"

jobs:
  build-and-release:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh # 强制使用PowerShell
        working-directory: ${{ github.workspace }} # 工作目录统一为仓库根目录
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure system encoding (avoid non-ASCII issues)
        run: |
          # 设置PowerShell编码为UTF-8，规避字符串终止符问题
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "System encoding set to UTF-8 successfully"

      # ========== 处理Win10 LTSC2021 x86 ==========
      - name: Download Win10 LTSC2021 x86 7z volumes
        run: |
          Write-Host "Starting download of Win10 LTSC2021 x86 7z volumes..."
          curl -L -o "Windows10_LTSC2021_x86-19044.6811.7z.001" $env:WIN10_X86_001_URL
          curl -L -o "Windows10_LTSC2021_x86-19044.6811.7z.002" $env:WIN10_X86_002_URL
          Write-Host "Win10 LTSC2021 x86 7z volumes downloaded successfully"

      - name: Extract Win10 LTSC2021 x86 7z volumes
        run: |
          Write-Host "Extracting Win10 LTSC2021 x86 7z volumes..."
          7z x "Windows10_LTSC2021_x86-19044.6811.7z.001" -o"./Win10_x86_Extract" -y
          Write-Host "Win10 LTSC2021 x86 7z volumes extracted successfully"

      - name: Extract install.esd from Win10 x86 ISO
        run: |
          Write-Host "Finding Win10 x86 ISO file..."
          $isoFile = Get-ChildItem -Path "./Win10_x86_Extract" -Filter *.iso -Recurse | Select-Object -First 1
          if (-not $isoFile) {
            Write-Error "Win10 x86 ISO file not found!"
            exit 1
          }
          Write-Host "Mounting ISO: $($isoFile.FullName)"
          $mountPoint = "./Win10_x86_Mount"
          New-Item -Path $mountPoint -ItemType Directory -Force | Out-Null
          Mount-DiskImage -ImagePath $isoFile.FullName -PassThru | Out-Null
          $volume = Get-Volume -Path (Get-DiskImage -ImagePath $isoFile.FullName | Get-Volume).DriveLetter`:
          $isoRoot = "$($volume.DriveLetter):\"
          Write-Host "Extracting install.esd from ISO root: $isoRoot"
          Copy-Item -Path "$isoRoot\sources\install.esd" -Destination "./install_x86.esd" -Force
          Write-Host "install.esd extracted successfully"
          # 卸载ISO
          Dismount-DiskImage -ImagePath $isoFile.FullName | Out-Null

      - name: Export first image to target WIM (Win10 x86)
        run: |
          Write-Host "Exporting first image from install_x86.esd to $env:TARGET_WIM_NAME..."
          dism /export-image /sourceimagefile:./install_x86.esd /sourceindex:1 /destinationimagefile:./$env:TARGET_WIM_NAME /compress:max /checkintegrity
          if ($LASTEXITCODE -ne 0) {
            Write-Error "DISM export failed for Win10 x86!"
            exit 1
          }
          Write-Host "Win10 x86 image exported to target WIM successfully"

      - name: Cleanup Win10 x86 temporary files
        run: |
          Write-Host "Cleaning up Win10 x86 temporary files..."
          Remove-Item -Path "Windows10_LTSC2021_x86-19044.6811.7z.001","Windows10_LTSC2021_x86-19044.6811.7z.002" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./Win10_x86_Extract" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./Win10_x86_Mount" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./install_x86.esd" -Force -ErrorAction SilentlyContinue
          Write-Host "Win10 x86 temporary files cleaned up successfully"

      # ========== 处理Win10 LTSC2021 x64 ==========
      - name: Download Win10 LTSC2021 x64 7z volumes
        run: |
          Write-Host "Starting download of Win10 LTSC2021 x64 7z volumes..."
          curl -L -o "Windows10_LTSC2021_amd64-19044.6811.7z.001" $env:WIN10_X64_001_URL
          curl -L -o "Windows10_LTSC2021_amd64-19044.6811.7z.002" $env:WIN10_X64_002_URL
          curl -L -o "Windows10_LTSC2021_amd64-19044.6811.7z.003" $env:WIN10_X64_003_URL
          Write-Host "Win10 LTSC2021 x64 7z volumes downloaded successfully"

      - name: Extract Win10 LTSC2021 x64 7z volumes
        run: |
          Write-Host "Extracting Win10 LTSC2021 x64 7z volumes..."
          7z x "Windows10_LTSC2021_amd64-19044.6811.7z.001" -o"./Win10_x64_Extract" -y
          Write-Host "Win10 LTSC2021 x64 7z volumes extracted successfully"

      - name: Extract install.esd from Win10 x64 ISO
        run: |
          Write-Host "Finding Win10 x64 ISO file..."
          $isoFile = Get-ChildItem -Path "./Win10_x64_Extract" -Filter *.iso -Recurse | Select-Object -First 1
          if (-not $isoFile) {
            Write-Error "Win10 x64 ISO file not found!"
            exit 1
          }
          Write-Host "Mounting ISO: $($isoFile.FullName)"
          $mountPoint = "./Win10_x64_Mount"
          New-Item -Path $mountPoint -ItemType Directory -Force | Out-Null
          Mount-DiskImage -ImagePath $isoFile.FullName -PassThru | Out-Null
          $volume = Get-Volume -Path (Get-DiskImage -ImagePath $isoFile.FullName | Get-Volume).DriveLetter`:
          $isoRoot = "$($volume.DriveLetter):\"
          Write-Host "Extracting install.esd from ISO root: $isoRoot"
          Copy-Item -Path "$isoRoot\sources\install.esd" -Destination "./install_x64.esd" -Force
          Write-Host "install.esd extracted successfully"
          # 卸载ISO
          Dismount-DiskImage -ImagePath $isoFile.FullName | Out-Null

      - name: Export first image to temp WIM (Win10 x64)
        run: |
          Write-Host "Exporting first image from install_x64.esd to temp install.wim..."
          dism /export-image /sourceimagefile:./install_x64.esd /sourceindex:1 /destinationimagefile:./install.wim /compress:max /checkintegrity
          if ($LASTEXITCODE -ne 0) {
            Write-Error "DISM export failed for Win10 x64 (temp WIM)!"
            exit 1
          }
          Write-Host "Win10 x64 image exported to temp WIM successfully"

      - name: Append temp WIM to target WIM (Win10 x64)
        run: |
          Write-Host "Appending temp install.wim to $env:TARGET_WIM_NAME..."
          dism /append-image /imagefile:./$env:TARGET_WIM_NAME /capturedir:./ /sourceimagefile:./install.wim /sourceindex:1 /checkintegrity
          if ($LASTEXITCODE -ne 0) {
            Write-Error "DISM append failed for Win10 x64!"
            exit 1
          }
          Write-Host "Win10 x64 image appended to target WIM successfully"

      - name: Cleanup Win10 x64 temporary files
        run: |
          Write-Host "Cleaning up Win10 x64 temporary files..."
          Remove-Item -Path "Windows10_LTSC2021_amd64-19044.6811.7z.001","Windows10_LTSC2021_amd64-19044.6811.7z.002","Windows10_LTSC2021_amd64-19044.6811.7z.003" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./Win10_x64_Extract" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./Win10_x64_Mount" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./install_x64.esd","./install.wim" -Force -ErrorAction SilentlyContinue
          Write-Host "Win10 x64 temporary files cleaned up successfully"

      # ========== 处理Win11 LTSC2024 x64 ==========
      - name: Download Win11 LTSC2024 x64 7z volumes
        run: |
          Write-Host "Starting download of Win11 LTSC2024 x64 7z volumes..."
          curl -L -o "Windows11_LTSC2024_amd64-26200.7627.7z.001" $env:WIN11_X64_001_URL
          curl -L -o "Windows11_LTSC2024_amd64-26200.7627.7z.002" $env:WIN11_X64_002_URL
          curl -L -o "Windows11_LTSC2024_amd64-26200.7627.7z.003" $env:WIN11_X64_003_URL
          Write-Host "Win11 LTSC2024 x64 7z volumes downloaded successfully"

      - name: Extract Win11 LTSC2024 x64 7z volumes
        run: |
          Write-Host "Extracting Win11 LTSC2024 x64 7z volumes..."
          7z x "Windows11_LTSC2024_amd64-26200.7627.7z.001" -o"./Win11_x64_Extract" -y
          Write-Host "Win11 LTSC2024 x64 7z volumes extracted successfully"

      - name: Extract install.esd from Win11 x64 ISO
        run: |
          Write-Host "Finding Win11 x64 ISO file..."
          $isoFile = Get-ChildItem -Path "./Win11_x64_Extract" -Filter *.iso -Recurse | Select-Object -First 1
          if (-not $isoFile) {
            Write-Error "Win11 x64 ISO file not found!"
            exit 1
          }
          Write-Host "Mounting ISO: $($isoFile.FullName)"
          $mountPoint = "./Win11_x64_Mount"
          New-Item -Path $mountPoint -ItemType Directory -Force | Out-Null
          Mount-DiskImage -ImagePath $isoFile.FullName -PassThru | Out-Null
          $volume = Get-Volume -Path (Get-DiskImage -ImagePath $isoFile.FullName | Get-Volume).DriveLetter`:
          $isoRoot = "$($volume.DriveLetter):\"
          Write-Host "Extracting install.esd from ISO root: $isoRoot"
          Copy-Item -Path "$isoRoot\sources\install.esd" -Destination "./install_11.esd" -Force
          Write-Host "install.esd extracted successfully"
          # 卸载ISO
          Dismount-DiskImage -ImagePath $isoFile.FullName | Out-Null

      - name: Export first image to temp WIM (Win11 x64)
        run: |
          Write-Host "Exporting first image from install_11.esd to temp install.wim..."
          dism /export-image /sourceimagefile:./install_11.esd /sourceindex:1 /destinationimagefile:./install.wim /compress:max /checkintegrity
          if ($LASTEXITCODE -ne 0) {
            Write-Error "DISM export failed for Win11 x64 (temp WIM)!"
            exit 1
          }
          Write-Host "Win11 x64 image exported to temp WIM successfully"

      - name: Append temp WIM to target WIM (Win11 x64)
        run: |
          Write-Host "Appending temp install.wim to $env:TARGET_WIM_NAME..."
          dism /append-image /imagefile:./$env:TARGET_WIM_NAME /capturedir:./ /sourceimagefile:./install.wim /sourceindex:1 /checkintegrity
          if ($LASTEXITCODE -ne 0) {
            Write-Error "DISM append failed for Win11 x64!"
            exit 1
          }
          Write-Host "Win11 x64 image appended to target WIM successfully"

      - name: Cleanup Win11 x64 temporary files
        run: |
          Write-Host "Cleaning up Win11 x64 temporary files..."
          Remove-Item -Path "Windows11_LTSC2024_amd64-26200.7627.7z.001","Windows11_LTSC2024_amd64-26200.7627.7z.002","Windows11_LTSC2024_amd64-26200.7627.7z.003" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./Win11_x64_Extract" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./Win11_x64_Mount" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./install_11.esd","./install.wim" -Force -ErrorAction SilentlyContinue
          Write-Host "Win11 x64 temporary files cleaned up successfully"

      # ========== 转换WIM到高压缩ESD ==========
      - name: Convert WIM to high-compression ESD
        run: |
          Write-Host "Converting $env:TARGET_WIM_NAME to $env:TARGET_ESD_NAME (high compression)..."
          dism /export-image /sourceimagefile:./$env:TARGET_WIM_NAME /sourceindex:1 /destinationimagefile:./$env:TARGET_ESD_NAME /compress:recovery /checkintegrity
          # 循环处理所有映像索引（WIM里有多个索引，需要逐个导出到ESD）
          $wimInfo = dism /get-imageinfo /imagefile:./$env:TARGET_WIM_NAME
          $indexes = ($wimInfo | Select-String -Pattern "Image Index: (\d+)").Matches | ForEach-Object { $_.Groups[1].Value } | Where-Object { $_ -ne 1 }
          foreach ($index in $indexes) {
            Write-Host "Exporting image index $index to ESD..."
            dism /export-image /sourceimagefile:./$env:TARGET_WIM_NAME /sourceindex:$index /destinationimagefile:./$env:TARGET_ESD_NAME /compress:recovery /checkintegrity
            if ($LASTEXITCODE -ne 0) {
              Write-Error "DISM export failed for index $index!"
              exit 1
            }
          }
          Write-Host "WIM converted to high-compression ESD successfully"

      # ========== 1950M分卷压缩ESD ==========
      - name: Split ESD into 1950M volumes
        run: |
          Write-Host "Splitting $env:TARGET_ESD_NAME into 1950M volumes..."
          7z a -v1950M -t7z -mx=9 "./$env:RELEASE_TAG.7z" "./$env:TARGET_ESD_NAME"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "7z volume split failed!"
            exit 1
          }
          Write-Host "ESD split into 1950M volumes successfully"

      # ========== 清理最终临时文件 ==========
      - name: Cleanup final temporary files
        run: |
          Write-Host "Cleaning up final temporary files..."
          Remove-Item -Path "./$env:TARGET_WIM_NAME" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "./$env:TARGET_ESD_NAME" -Force -ErrorAction SilentlyContinue
          Write-Host "Final temporary files cleaned up successfully"

      # ========== 发布到GitHub Releases ==========
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          files: |
            ./${{ env.RELEASE_TAG }}.7z.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
