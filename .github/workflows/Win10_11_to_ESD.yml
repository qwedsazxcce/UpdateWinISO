name: Windows_LTSC_ESD

on:
  workflow_dispatch:

# 核心修复：URL改用单行逗号分隔，避免GitHub Actions多行变量解析异常
env:
  # 单行定义，无换行，避免解析为空
  DOWNLOAD_URLS_1: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.001,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_x86-19044.6811/Windows10_LTSC2021_x86-19044.6811.7z.002
  DOWNLOAD_URLS_2: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.001,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.002,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows10_LTSC2021_amd64-19044.6811/Windows10_LTSC2021_amd64-19044.6811.7z.003
  DOWNLOAD_URLS_3: https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.001,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.002,https://github.com/qwedsazxcce/UpdateWinISO/releases/download/Windows11_LTSC2024_amd64-26200.7627/Windows11_LTSC2024_amd64-26200.7627.7z.003
  
  TARGET_WIM: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.wim
  TARGET_ESD: Windows10_LTSC_2021_32&64_Windows_11_LTSC_2025.esd
  SPLIT_SIZE: 1950M

jobs:
  build-esd:
    runs-on: windows-latest
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 安装7-Zip（极简验证）
      - name: Install 7-Zip
        shell: powershell
        run: |
          if (-not (Test-Path "${env:ProgramFiles}\7-Zip\7z.exe")) {
              choco install 7zip -y --no-progress
              $env:PATH += ";${env:ProgramFiles}\7-Zip"
          }
          # 仅验证存在性，不触发参数错误
          if (-not (Test-Path "${env:ProgramFiles}\7-Zip\7z.exe")) {
              throw "7-Zip安装失败"
          }

      # 核心处理逻辑（极简版，无冗余日志，仅保留核心功能）
      - name: Process All ISO Files
        shell: powershell
        run: |
          # 定义核心函数
          function Process-Group {
              param(
                  [string]$UrlList,
                  [string]$TargetWim
              )
              # 分割URL（核心修复：直接分割，无冗余过滤）
              $urls = $UrlList -split ',' | ForEach-Object { $_.Trim() }
              if ($urls.Count -eq 0) { throw "URL列表为空" }

              # 创建临时目录
              $temp = New-Item -Path "$env:GITHUB_WORKSPACE\temp_$(Get-Random)" -ItemType Directory -Force
              $dlDir = New-Item -Path "$temp\dl" -ItemType Directory -Force

              try {
                  # 下载文件（curl带进度）
                  foreach ($url in $urls) {
                      $fileName = [System.IO.Path]::GetFileName($url)
                      Write-Host "下载: $fileName"
                      curl.exe --progress-bar -L -f -o "$dlDir\$fileName" "$url"
                      if (-not (Test-Path "$dlDir\$fileName")) { throw "下载失败: $fileName" }
                  }

                  # 解压7z（只需要001文件）
                  $7zFile = Get-ChildItem -Path $dlDir -Filter "*.7z.001" | Select-Object -First 1
                  if (-not $7zFile) { throw "未找到7z分卷" }
                  Write-Host "解压: $($7zFile.Name)"
                  7z x -y -o"$temp\extract" "$7zFile.FullName" | Out-Host

                  # 提取ISO中的install.esd
                  $isoFile = Get-ChildItem -Path "$temp\extract" -Filter "*.iso" -Recurse | Select-Object -First 1
                  if (-not $isoFile) { throw "未找到ISO文件" }
                  Write-Host "提取ESD: $($isoFile.Name)"
                  7z x -y -o"$temp\iso" "$isoFile.FullName" "sources\install.esd" | Out-Host

                  # 导出映像到WIM
                  $esdFile = "$temp\iso\sources\install.esd"
                  if (-not (Test-Path $esdFile)) { throw "未找到install.esd" }
                  Write-Host "导出映像到WIM"
                  if (-not (Test-Path $TargetWim)) {
                      dism /Export-Image /SourceImageFile:$esdFile /SourceIndex:1 /DestinationImageFile:$TargetWim /Compress:max | Out-Host
                  } else {
                      $imgCount = (dism /Get-WimInfo /WimFile:$TargetWim | Select-String "Image Index" | Measure-Object).Count + 1
                      dism /Export-Image /SourceImageFile:$esdFile /SourceIndex:1 /DestinationImageFile:$TargetWim /DestinationIndex:$imgCount /Compress:max | Out-Host
                  }
              } finally {
                  # 强制清理临时文件
                  Remove-Item -Path $temp -Recurse -Force -ErrorAction SilentlyContinue
              }
          }

          # 处理三组文件
          $targetWim = "$env:GITHUB_WORKSPACE\$env:TARGET_WIM"
          Process-Group -UrlList $env:DOWNLOAD_URLS_1 -TargetWim $targetWim
          Process-Group -UrlList $env:DOWNLOAD_URLS_2 -TargetWim $targetWim
          Process-Group -UrlList $env:DOWNLOAD_URLS_3 -TargetWim $targetWim

          # 转换WIM到ESD
          Write-Host "转换WIM到ESD"
          $esdFile = "$env:GITHUB_WORKSPACE\$env:TARGET_ESD"
          $imgCount = (dism /Get-WimInfo /WimFile:$targetWim | Select-String "Image Index" | Measure-Object).Count
          for ($i=1; $i -le $imgCount; $i++) {
              if ($i -eq 1) {
                  dism /Export-Image /SourceImageFile:$targetWim /SourceIndex:$i /DestinationImageFile:$esdFile /Compress:recovery | Out-Host
              } else {
                  dism /Export-Image /SourceImageFile:$targetWim /SourceIndex:$i /DestinationImageFile:$esdFile /DestinationIndex:$i /Compress:recovery | Out-Host
              }
          }
          Remove-Item -Path $targetWim -Force

          # 分卷压缩
          Write-Host "分卷压缩ESD"
          7z a -y -v$env:SPLIT_SIZE "$esdFile.7z" "$esdFile" | Out-Host
          Remove-Item -Path $esdFile -Force

      # 发布到Releases
      - name: Publish to Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TARGET_WIM }}
          name: ${{ env.TARGET_WIM }}
          files: ${{ github.workspace }}/${{ env.TARGET_ESD }}.7z.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 最终清理
      - name: Cleanup
        if: always()
        shell: powershell
        run: |
          Remove-Item -Path "$env:GITHUB_WORKSPACE\temp_*" -Recurse -Force -ErrorAction SilentlyContinue
